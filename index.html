
<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>નવજીવન પશુઆહાર - ડેશબોર્ડ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Gujarati:wght@400;600;700&family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', 'Noto Sans Gujarati', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Card Hover Effects */
        .hover-card {
            transition: all 0.3s ease;
        }
        .hover-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Glassmorphism for Modal */
        .glass-modal {
            backdrop-filter: blur(5px);
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Table Styles */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="text-gray-800 bg-gray-50 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-indigo-700 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-white p-2 rounded-full text-indigo-700">
                        <i class="fa-solid fa-cow text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-xl md:text-2xl tracking-wide">નવજીવન પશુઆહાર</h1>
                        <p class="text-[10px] text-indigo-200 uppercase tracking-wider hidden sm:block">Khata Pothi & Stock Manager</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="openDailyReport()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-semibold transition flex items-center shadow border border-indigo-500">
                        <i class="fa-solid fa-chart-pie mr-2"></i>
                        <span class="hidden sm:inline">આજનો રિપોર્ટ</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- Preview Banner (Hidden by default) -->
        <div id="preview-banner" class="hidden mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg shadow-sm animate-pulse">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-600 text-2xl"></i>
                    <div>
                        <p class="font-bold text-yellow-800 text-lg">ફાઈલ પ્રિવ્યુ (Preview Mode)</p>
                        <p class="text-sm text-yellow-700">તમે માત્ર ડેટા જોઈ રહ્યા છો. સેવ કરવા માટે કન્ફર્મ કરો.</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="cancelImport()" class="px-4 py-2 bg-white border border-red-300 text-red-600 rounded-lg hover:bg-red-50 font-semibold text-sm">
                        રદ કરો
                    </button>
                    <button onclick="confirmImport()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-semibold text-sm shadow-md">
                        મર્જ કરો & સેવ કરો
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Stats Grid -->
        <section id="summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Total Income Card -->
            <div class="bg-gradient-to-br from-emerald-50 to-white p-6 rounded-2xl shadow-sm border border-emerald-100 hover-card relative overflow-hidden">
                <div class="absolute right-0 top-0 p-4 opacity-10">
                    <i class="fa-solid fa-indian-rupee-sign text-6xl text-emerald-600"></i>
                </div>
                <p class="text-sm font-semibold text-emerald-600 uppercase tracking-wider mb-1">કુલ આવક</p>
                <h2 id="total-income" class="text-3xl font-bold text-emerald-700">₹ 0.00</h2>
            </div>

            <!-- Total Expense Card -->
            <div class="bg-gradient-to-br from-red-50 to-white p-6 rounded-2xl shadow-sm border border-red-100 hover-card relative overflow-hidden">
                <div class="absolute right-0 top-0 p-4 opacity-10">
                    <i class="fa-solid fa-wallet text-6xl text-red-600"></i>
                </div>
                <p class="text-sm font-semibold text-red-600 uppercase tracking-wider mb-1">કુલ ખર્ચ</p>
                <h2 id="total-expense" class="text-3xl font-bold text-red-700">₹ 0.00</h2>
            </div>

            <!-- Net Balance Card -->
            <div class="bg-gradient-to-br from-blue-50 to-white p-6 rounded-2xl shadow-sm border border-blue-100 hover-card relative overflow-hidden">
                <div class="absolute right-0 top-0 p-4 opacity-10">
                    <i class="fa-solid fa-scale-balanced text-6xl text-blue-600"></i>
                </div>
                <p class="text-sm font-semibold text-blue-600 uppercase tracking-wider mb-1">ચોખ્ખું બેલેન્સ</p>
                <h2 id="net-balance" class="text-3xl font-bold text-blue-700">₹ 0.00</h2>
            </div>
        </section>

        <!-- Transaction Entry Section -->
        <section class="bg-white rounded-2xl shadow-md border border-gray-200 mb-8 overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center flex-wrap gap-4">
                <h2 class="text-lg font-bold text-gray-700 flex items-center">
                    <i class="fa-solid fa-pen-to-square mr-2 text-indigo-600"></i>
                    <span id="form-title">નવો વ્યવહાર</span>
                </h2>
                <!-- Mode Switcher -->
                <div class="bg-gray-200 p-1 rounded-lg flex text-xs font-bold">
                    <button onclick="switchMode('single')" id="btn-mode-single" class="px-4 py-2 rounded-md bg-white text-indigo-700 shadow-sm transition-all duration-200">
                        એક એન્ટ્રી
                    </button>
                    <button onclick="switchMode('bulk')" id="btn-mode-bulk" class="px-4 py-2 rounded-md text-gray-500 hover:text-gray-700 transition-all duration-200">
                        બિલ (એક સાથે અનેક)
                    </button>
                </div>
            </div>

            <div class="p-6">
                <!-- Single Entry Form -->
                <form id="transaction-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 items-end">
                    <div class="col-span-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">તારીખ</label>
                        <input type="date" id="date" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">વસ્તુનો પ્રકાર</label>
                        <select id="item-type" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition">
                            <option value="" disabled selected>પસંદ કરો</option>
                            <option value="મકાઈ પાપડી">મકાઈ પાપડી</option>
                            <option value="મકાઈ ભરડો">મકાઈ ભરડો</option>
                            <option value="પાપડી">પાપડી</option>
                            <option value="જવ ભરડો">જવ ભરડો</option>
                            <option value="સોયાબીન">સોયાબીન</option>
                            <option value="તુવેરચુની">તુવેરચુની</option>
                            <option value="પશુ આહાર">પશુ આહાર</option>
                            <option value="લાલી">લાલી</option>
                            <option value="દાણ">દાણ</option>
                            <option value="જીરાળો">જીરાળો</option>
                            <option value="અન્ય">અન્ય</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">બોરી (નંગ)</label>
                        <input type="number" id="quantity" placeholder="0" required min="1" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ભાવ (Rate)</label>
                        <input type="number" id="rate" placeholder="0.00" required min="0.01" step="0.01" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition">
                    </div>
                    
                    <!-- Row 2 -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">કુલ રકમ</label>
                        <input type="text" id="total-amount-display" value="₹ 0" readonly class="w-full p-3 bg-gray-100 border border-gray-200 rounded-lg font-bold text-gray-700 cursor-not-allowed">
                        <input type="hidden" id="amount-hidden">
                    </div>
                    <div id="source-destination-group">
                        <label id="source-dest-label" class="block text-xs font-bold text-gray-500 uppercase mb-1">કોને આપ્યું / લીધું</label>
                        <input type="text" id="source-destination" placeholder="પાર્ટીનું નામ" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">વ્યવહાર પ્રકાર</label>
                        <select id="type" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition">
                            <option value="income">આવક (જમા)</option>
                            <option value="expense">ખર્ચ (ઉધાર)</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" id="submit-button" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow transition-colors flex justify-center items-center gap-2">
                            <i class="fa-solid fa-plus"></i> ઉમેરો
                        </button>
                        <button type="button" id="cancel-edit-button" class="hidden flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg shadow transition-colors">
                            રદ
                        </button>
                    </div>
                </form>

                <!-- Bulk Entry Form (Hidden) -->
                <div id="bulk-entry-form" class="hidden space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                        <div>
                            <label class="block text-xs font-bold text-indigo-800 uppercase mb-1">તારીખ</label>
                            <input type="date" id="bulk-date" class="w-full p-2 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label id="bulk-source-label" class="block text-xs font-bold text-indigo-800 uppercase mb-1">પાર્ટીનું નામ</label>
                            <input type="text" id="bulk-source" placeholder="નામ લખો..." class="w-full p-2 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-indigo-800 uppercase mb-1">પ્રકાર</label>
                            <select id="bulk-type" class="w-full p-2 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                <option value="income">આવક (Income)</option>
                                <option value="expense">ખર્ચ (Expense)</option>
                            </select>
                        </div>
                    </div>

                    <div class="border rounded-xl overflow-hidden shadow-sm">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3">વસ્તુ</th>
                                    <th class="px-4 py-3 w-24">બોરી</th>
                                    <th class="px-4 py-3 w-24">ભાવ</th>
                                    <th class="px-4 py-3 text-right">કુલ</th>
                                    <th class="px-4 py-3 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="bulk-items-body" class="bg-white divide-y divide-gray-100">
                                <!-- Dynamic Rows -->
                            </tbody>
                            <tfoot class="bg-gray-50 font-bold">
                                <tr>
                                    <td colspan="3" class="px-4 py-3 text-right text-gray-600">Grand Total:</td>
                                    <td class="px-4 py-3 text-right text-gray-900 text-lg" id="bulk-grand-total">₹ 0</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="flex justify-between items-center pt-2">
                        <button onclick="addBulkRow()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-bold transition flex items-center gap-2">
                            <i class="fa-solid fa-plus-circle"></i> બીજી વસ્તુ
                        </button>
                        <div class="flex gap-2">
                            <button onclick="cancelBulkEdit()" id="btn-cancel-bulk" class="hidden px-4 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-lg text-sm font-bold transition">રદ</button>
                            <button id="btn-save-bulk" onclick="saveBulkData()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold transition shadow flex items-center gap-2">
                                <i class="fa-solid fa-save"></i> સેવ કરો
                            </button>
                        </div>
                    </div>
                </div>

                <p id="status-message" class="hidden"></p>
            </div>
        </section>

        <!-- Tools & Analysis Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            
            <!-- Column 1: Search & Filter -->
            <div class="lg:col-span-2 space-y-6">
                 <!-- Search & Filter Card -->
                <div class="bg-white p-5 rounded-2xl shadow-md border border-gray-200">
                    <h3 class="text-md font-bold text-gray-700 mb-4 flex items-center">
                        <i class="fa-solid fa-filter mr-2 text-indigo-500"></i> શોધ અને ફિલ્ટર
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fa-solid fa-search text-gray-400"></i>
                                </div>
                                <input type="text" id="search-input" placeholder="નામ કે વિગત શોધો..." 
                                       class="w-full pl-10 p-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <select id="filter-type" class="p-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm w-1/3">
                                <option value="all">બધો સમય</option>
                                <option value="monthly" selected>માસિક</option>
                                <option value="yearly">વાર્ષિક</option>
                                <option value="custom">તારીખ</option>
                            </select>
                            <div id="date-inputs-container" class="flex-grow">
                                <!-- Dynamic Inputs -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden Templates for JS -->
                    <div id="custom-date-template" class="hidden flex gap-2">
                        <input type="date" id="filter-start-date" class="w-1/2 p-2 border rounded text-sm">
                        <input type="date" id="filter-end-date" class="w-1/2 p-2 border rounded text-sm">
                    </div>
                </div>

                <!-- Monthly Analysis -->
                <div class="bg-white p-5 rounded-2xl shadow-md border border-gray-200">
                    <h3 class="text-md font-bold text-gray-700 mb-4 flex items-center border-b pb-2">
                        <i class="fa-solid fa-chart-line mr-2 text-blue-500"></i> માસિક વિશ્લેષણ
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-emerald-50 p-3 rounded-lg border border-emerald-100">
                            <h4 class="text-sm font-bold text-emerald-800 mb-2">વધુ આવક વાળો મહિનો</h4>
                            <div class="flex justify-between items-end">
                                <span id="max-income-month" class="text-sm text-gray-600">N/A</span>
                                <span id="max-income-amount" class="font-bold text-emerald-600 text-lg">₹ 0</span>
                            </div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                            <h4 class="text-sm font-bold text-red-800 mb-2">વધુ ખર્ચ વાળો મહિનો</h4>
                            <div class="flex justify-between items-end">
                                <span id="max-expense-month" class="text-sm text-gray-600">N/A</span>
                                <span id="max-expense-amount" class="font-bold text-red-600 text-lg">₹ 0</span>
                            </div>
                        </div>
                        <!-- Min Values Hidden for Cleaner Look but IDs kept for JS safety -->
                        <div class="hidden">
                            <span id="min-income-month"></span><span id="min-income-amount"></span>
                            <span id="min-expense-month"></span><span id="min-expense-amount"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column 2: Stock Summary (Sidebar style) -->
            <div class="lg:col-span-1">
                <div class="bg-white p-5 rounded-2xl shadow-md border border-gray-200 h-full">
                    <h3 class="text-md font-bold text-gray-700 mb-4 flex items-center border-b pb-2">
                        <i class="fa-solid fa-boxes-stacked mr-2 text-purple-500"></i> સ્ટોક સમરી
                    </h3>
                    <div class="overflow-hidden rounded-lg border border-gray-100">
                        <table class="w-full text-sm">
                            <thead class="bg-purple-50 text-purple-900 font-semibold">
                                <tr>
                                    <th class="px-3 py-2 text-left">વસ્તુ</th>
                                    <th class="px-3 py-2 text-right">આવક</th>
                                    <th class="px-3 py-2 text-right">જાવક</th>
                                </tr>
                            </thead>
                            <tbody id="item-summary-body" class="divide-y divide-gray-100">
                                <tr><td colspan="3" class="text-center py-4 text-gray-400 text-xs">માહિતી નથી</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <!-- Income Table -->
            <div id="income-section" class="bg-white rounded-2xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-[600px]">
                <div class="bg-emerald-50 px-5 py-3 border-b border-emerald-100 flex justify-between items-center sticky top-0 z-20">
                    <h3 class="font-bold text-emerald-800 flex items-center">
                        <i class="fa-solid fa-arrow-down mr-2"></i> આવક (Income)
                    </h3>
                </div>
                <div class="overflow-y-auto flex-grow p-0 scrollbar-hide">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-4 py-3 text-left w-1/4 bg-gray-50">તારીખ</th>
                                <th class="px-4 py-3 text-left w-2/4 bg-gray-50">વિગત</th>
                                <th class="px-4 py-3 text-right w-1/4 bg-gray-50">રકમ</th>
                                <th class="px-4 py-3 text-center bg-gray-50">Action</th>
                            </tr>
                        </thead>
                        <tbody id="income-list-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                    <div id="no-income" class="text-center py-10 text-gray-400 hidden flex flex-col items-center">
                        <i class="fa-regular fa-folder-open text-3xl mb-2"></i>
                        <p>ડેટા નથી</p>
                    </div>
                </div>
            </div>

            <!-- Expense Table -->
            <div id="expense-section" class="bg-white rounded-2xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-[600px]">
                <div class="bg-red-50 px-5 py-3 border-b border-red-100 flex justify-between items-center sticky top-0 z-20">
                    <h3 class="font-bold text-red-800 flex items-center">
                        <i class="fa-solid fa-arrow-up mr-2"></i> ખર્ચ (Expense)
                    </h3>
                </div>
                <div class="overflow-y-auto flex-grow p-0 scrollbar-hide">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-4 py-3 text-left w-1/4 bg-gray-50">તારીખ</th>
                                <th class="px-4 py-3 text-left w-2/4 bg-gray-50">વિગત</th>
                                <th class="px-4 py-3 text-right w-1/4 bg-gray-50">રકમ</th>
                                <th class="px-4 py-3 text-center bg-gray-50">Action</th>
                            </tr>
                        </thead>
                        <tbody id="expense-list-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                    <div id="no-expense" class="text-center py-10 text-gray-400 hidden flex flex-col items-center">
                        <i class="fa-regular fa-folder-open text-3xl mb-2"></i>
                        <p>ડેટા નથી</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Management Footer -->
        <section class="bg-indigo-900 text-indigo-100 rounded-2xl p-6 md:p-8 shadow-xl mb-10">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div>
                    <h2 class="text-xl font-bold text-white mb-2 flex items-center">
                        <i class="fa-solid fa-database mr-2"></i> ડેટા મેનેજમેન્ટ
                    </h2>
                    <p class="text-sm text-indigo-300">તમારા ડેટાનો બેકઅપ લો અથવા જૂનો ડેટા અપલોડ કરો.</p>
                </div>
                <div class="flex flex-wrap gap-3 justify-center">
                    <button onclick="exportData()" class="px-4 py-2 bg-indigo-700 hover:bg-indigo-600 rounded-lg text-white font-semibold shadow transition border border-indigo-600 flex items-center gap-2">
                        <i class="fa-solid fa-download"></i> ડાઉનલોડ
                    </button>
                    <label class="px-4 py-2 bg-indigo-700 hover:bg-indigo-600 rounded-lg text-white font-semibold shadow transition border border-indigo-600 cursor-pointer flex items-center gap-2">
                        <i class="fa-solid fa-upload"></i> અપલોડ
                        <input type="file" accept=".json" class="hidden" onchange="importData(this)">
                    </label>
                    <button onclick="resetFile()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white font-semibold shadow transition flex items-center gap-2">
                        <i class="fa-solid fa-trash"></i> રિસેટ
                    </button>
                    <button id="undo-button" onclick="restoreBackup()" class="hidden px-4 py-2 bg-yellow-500 hover:bg-yellow-600 rounded-lg text-white font-bold shadow animate-pulse flex items-center gap-2">
                        <i class="fa-solid fa-rotate-left"></i> Undo
                    </button>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-indigo-800 text-center text-xs text-indigo-400">
                &copy; 2024 Navjivan Pashuahar. Secure Offline Storage.
            </div>
        </section>

    </main>

    <!-- Modals (Outside Main Layout) -->
    
    <!-- Bill Detail Modal -->
    <div id="bill-modal" class="fixed inset-0 glass-modal hidden z-[60] flex justify-center items-center">
        <div class="relative p-0 border w-full max-w-xl shadow-2xl rounded-2xl bg-white mx-4 overflow-hidden transform transition-all scale-100">
            <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-bold" id="bill-modal-title">બિલ વિગત</h3>
                    <p class="text-xs text-gray-300" id="bill-modal-subtitle">તારીખ અને પાર્ટીનું નામ</p>
                </div>
                <button onclick="closeBillModal()" class="text-gray-400 hover:text-white transition text-2xl leading-none">&times;</button>
            </div>
            <div class="overflow-x-auto max-h-[60vh] overflow-y-auto p-4">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-bold text-gray-500">વસ્તુ</th>
                            <th class="px-4 py-2 text-right text-xs font-bold text-gray-500">જથ્થો</th>
                            <th class="px-4 py-2 text-right text-xs font-bold text-gray-500">ભાવ</th>
                            <th class="px-4 py-2 text-right text-xs font-bold text-gray-500">કુલ</th>
                        </tr>
                    </thead>
                    <tbody id="bill-modal-body" class="divide-y divide-gray-100"></tbody>
                    <tfoot class="border-t">
                        <tr>
                            <td colspan="3" class="px-4 py-3 text-right font-bold text-gray-700">Grand Total:</td>
                            <td class="px-4 py-3 text-right font-bold text-indigo-600 text-lg" id="bill-modal-total">₹ 0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="p-4 bg-gray-50 text-right border-t">
                <button onclick="closeBillModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-5 py-2 rounded-lg font-semibold text-sm transition">બંધ કરો</button>
            </div>
        </div>
    </div>

    <!-- Daily Report Modal -->
    <div id="daily-report-modal" class="fixed inset-0 glass-modal hidden z-[60] flex justify-center items-center">
        <div class="relative w-full max-w-lg shadow-2xl rounded-2xl bg-white mx-4 overflow-hidden">
            <div class="bg-indigo-600 p-5 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white flex items-center">
                    <i class="fa-solid fa-calendar-day mr-2"></i> દૈનિક રિપોર્ટ
                </h3>
                <button onclick="closeDailyReport()" class="text-indigo-200 hover:text-white transition text-2xl leading-none">&times;</button>
            </div>
            
            <div class="p-6">
                <div class="mb-5">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">તારીખ પસંદ કરો</label>
                    <input type="date" id="report-date" class="w-full p-3 border-2 border-indigo-100 rounded-xl focus:border-indigo-500 focus:ring focus:ring-indigo-200 transition font-semibold text-gray-700" onchange="renderDailyReport()">
                </div>

                <div class="bg-indigo-50 rounded-xl border border-indigo-100 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-indigo-100/50">
                            <tr>
                                <th class="px-5 py-3 text-left text-xs font-bold text-indigo-800">વસ્તુનું નામ</th>
                                <th class="px-5 py-3 text-right text-xs font-bold text-indigo-800">વેચાયેલ નંગ</th>
                            </tr>
                        </thead>
                        <tbody id="daily-report-body" class="divide-y divide-indigo-100 bg-white">
                            <tr><td colspan="2" class="px-5 py-4 text-center text-gray-400 text-sm">તારીખ પસંદ કરો...</td></tr>
                        </tbody>
                        <tfoot class="bg-indigo-50/50">
                            <tr>
                                <td class="px-5 py-3 font-bold text-indigo-900 text-sm">કુલ નંગ (Total Qty)</td>
                                <td class="px-5 py-3 text-right font-bold text-indigo-900" id="daily-report-total-qty">0</td>
                            </tr>
                            <tr class="bg-emerald-600 text-white">
                                <td class="px-5 py-3 font-bold text-sm">કુલ આવક (Total Income)</td>
                                <td class="px-5 py-3 text-right font-bold text-lg" id="daily-report-total-amount">₹ 0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="p-4 bg-gray-50 text-center border-t">
                <button onclick="closeDailyReport()" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg">રીપોર્ટ બંધ કરો</button>
            </div>
        </div>
    </div>

    <!-- 
      JAVASCRIPT LOGIC 
      (Logic kept exactly the same, only class names in rendered HTML strings updated to match new UI)
    -->
    <script>
        // --- Constants & State ---
        const STORAGE_KEY = 'khataPothiTransactions';
        const BACKUP_KEY = 'khataPothiTempBackup';
        const GUJARATI_MONTHS = ["જાન્યુઆરી", "ફેબ્રુઆરી", "માર્ચ", "એપ્રિલ", "મે", "જૂન", "જુલાઈ", "ઓગસ્ટ", "સપ્ટેમ્બર", "ઓક્ટોબર", "નવેમ્બર", "ડિસેમ્બર"];
        
        let allTransactionsData = [];
        let tempImportedData = []; 
        let editingTransactionId = null;
        let editingBillId = null; 
        let isPreviewMode = false;

        // --- DOM Elements ---
        const els = {
            form: document.getElementById('transaction-form'),
            inputs: {
                date: document.getElementById('date'),
                itemType: document.getElementById('item-type'),
                quantity: document.getElementById('quantity'),
                rate: document.getElementById('rate'),
                totalDisplay: document.getElementById('total-amount-display'),
                amountHidden: document.getElementById('amount-hidden'),
                type: document.getElementById('type'),
                sourceDest: document.getElementById('source-destination'),
                sourceDestGroup: document.getElementById('source-destination-group'),
                search: document.getElementById('search-input')
            },
            buttons: {
                submit: document.getElementById('submit-button'),
                cancel: document.getElementById('cancel-edit-button'),
                undo: document.getElementById('undo-button')
            },
            summary: {
                income: document.getElementById('total-income'),
                expense: document.getElementById('total-expense'),
                balance: document.getElementById('net-balance'),
                itemBody: document.getElementById('item-summary-body'),
                monthly: {
                    maxIncM: document.getElementById('max-income-month'),
                    maxIncA: document.getElementById('max-income-amount'),
                    minIncM: document.getElementById('min-income-month'),
                    minIncA: document.getElementById('min-income-amount'),
                    maxExpM: document.getElementById('max-expense-month'),
                    maxExpA: document.getElementById('max-expense-amount'),
                    minExpM: document.getElementById('min-expense-month'),
                    minExpA: document.getElementById('min-expense-amount')
                }
            },
            lists: {
                income: document.getElementById('income-list-body'),
                expense: document.getElementById('expense-list-body'),
                noIncome: document.getElementById('no-income'),
                noExpense: document.getElementById('no-expense')
            },
            filter: {
                type: document.getElementById('filter-type'),
                container: document.getElementById('date-inputs-container'),
                statusMsg: document.getElementById('status-message')
            },
            preview: {
                banner: document.getElementById('preview-banner')
            },
            bulk: {
                form: document.getElementById('bulk-entry-form'),
                btnSingle: document.getElementById('btn-mode-single'),
                btnBulk: document.getElementById('btn-mode-bulk'),
                body: document.getElementById('bulk-items-body'),
                total: document.getElementById('bulk-grand-total'),
                date: document.getElementById('bulk-date'),
                source: document.getElementById('bulk-source'),
                type: document.getElementById('bulk-type'),
                btnSave: document.getElementById('btn-save-bulk'),
                btnCancel: document.getElementById('btn-cancel-bulk')
            }
        };

        // --- Helper Functions ---
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);
        
        const showStatus = (msg, type = 'success') => {
            // Using alert or updated simple toast logic could work, keeping it simple as per request
            // Updating hidden element to show toast
            const toast = document.createElement('div');
            toast.className = `fixed bottom-5 right-5 px-6 py-4 rounded-lg shadow-2xl text-white font-bold transform transition-all translate-y-20 opacity-0 z-50 ${type === 'error' ? 'bg-red-600' : 'bg-emerald-600'}`;
            toast.innerHTML = `<i class="fa-solid ${type === 'error' ? 'fa-circle-exclamation' : 'fa-check-circle'} mr-2"></i> ${msg}`;
            document.body.appendChild(toast);
            
            // Animation
            setTimeout(() => { toast.classList.remove('translate-y-20', 'opacity-0'); }, 100);
            setTimeout(() => { toast.classList.add('translate-y-20', 'opacity-0'); setTimeout(() => toast.remove(), 500); }, 4000);
        };

        const formatCurrency = (amt) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }).format(amt || 0);

        const calculateTotal = () => {
            const q = parseFloat(els.inputs.quantity.value) || 0;
            const r = parseFloat(els.inputs.rate.value) || 0;
            const total = (q * r).toFixed(2);
            els.inputs.totalDisplay.value = formatCurrency(total);
            els.inputs.amountHidden.value = total;
        };

        const toggleSourceDest = () => {
            const label = document.getElementById('source-dest-label');
            if (els.inputs.type.value === 'expense') {
                els.inputs.sourceDestGroup.classList.remove('hidden');
                els.inputs.sourceDest.required = true;
                els.inputs.sourceDest.placeholder = "કોને ચૂકવ્યા?";
                label.textContent = "કોને ચૂકવ્યા";
            } else {
                els.inputs.sourceDestGroup.classList.remove('hidden');
                els.inputs.sourceDest.required = true;
                els.inputs.sourceDest.placeholder = "કોને આપ્યું?";
                label.textContent = "કોને આપ્યું";
            }
        };

        // --- Mode Switcher (Single vs Bulk) ---
        window.switchMode = (mode) => {
            if(mode === 'single') {
                cancelBulkEdit();
                els.form.classList.remove('hidden');
                els.bulk.form.classList.add('hidden');
                els.bulk.btnSingle.className = "px-4 py-2 rounded-md bg-white text-indigo-700 shadow-sm transition-all duration-200 border border-gray-200";
                els.bulk.btnBulk.className = "px-4 py-2 rounded-md text-gray-500 hover:text-gray-700 transition-all duration-200";
            } else {
                els.form.classList.add('hidden');
                els.bulk.form.classList.remove('hidden');
                els.bulk.btnSingle.className = "px-4 py-2 rounded-md text-gray-500 hover:text-gray-700 transition-all duration-200";
                els.bulk.btnBulk.className = "px-4 py-2 rounded-md bg-white text-indigo-700 shadow-sm transition-all duration-200 border border-gray-200";
                
                if(!els.bulk.date.value) els.bulk.date.valueAsDate = new Date();
                if(els.bulk.body.children.length === 0 && !editingBillId) addBulkRow();
            }
        };

        // --- Bulk Entry Logic ---
        window.addBulkRow = () => {
            const rowId = generateId();
            const tr = document.createElement('tr');
            tr.id = `row-${rowId}`;
            tr.className = "bg-white border-b hover:bg-gray-50 transition";
            tr.innerHTML = `
                <td class="px-4 py-2">
                    <select class="w-full p-2 border rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-indigo-200 outline-none item-select" onchange="updateBulkTotal('${rowId}')">
                        <option value="" disabled selected>પસંદ કરો</option>
                        <option value="મકાઈ પાપડી">મકાઈ પાપડી</option>
                        <option value="મકાઈ ભરડો">મકાઈ ભરડો</option>
                        <option value="પાપડી">પાપડી</option>
                        <option value="જવ ભરડો">જવ ભરડો</option>
                        <option value="સોયાબીન">સોયાબીન</option>
                        <option value="તુવેરચુની">તુવેરચુની</option>
                        <option value="પશુ આહાર">પશુ આહાર</option>
                        <option value="લાલી">લાલી</option>
                        <option value="દાણ">દાણ</option>
                        <option value="જીરાળો">જીરાળો</option>
                        <option value="અન્ય">અન્ય</option>
                    </select>
                </td>
                <td class="px-4 py-2">
                    <input type="number" class="w-full p-2 border rounded-lg text-sm text-right bg-gray-50 focus:ring-2 focus:ring-indigo-200 outline-none qty-input" min="1" placeholder="0" oninput="updateBulkTotal('${rowId}')">
                </td>
                <td class="px-4 py-2">
                    <input type="number" class="w-full p-2 border rounded-lg text-sm text-right bg-gray-50 focus:ring-2 focus:ring-indigo-200 outline-none rate-input" min="0" step="0.01" placeholder="0" oninput="updateBulkTotal('${rowId}')">
                </td>
                <td class="px-4 py-2 text-right font-bold text-gray-700 total-cell">₹ 0</td>
                <td class="px-4 py-2 text-center">
                    <button onclick="removeBulkRow('${rowId}')" class="text-red-400 hover:text-red-600 transition"><i class="fa-solid fa-trash-can"></i></button>
                </td>
            `;
            els.bulk.body.appendChild(tr);
            return tr;
        };

        window.removeBulkRow = (id) => {
            const row = document.getElementById(`row-${id}`);
            if(row) row.remove();
            calculateBulkGrandTotal();
        };

        window.updateBulkTotal = (rowId) => {
            const row = document.getElementById(`row-${rowId}`);
            const q = parseFloat(row.querySelector('.qty-input').value) || 0;
            const r = parseFloat(row.querySelector('.rate-input').value) || 0;
            const total = q * r;
            row.querySelector('.total-cell').innerText = formatCurrency(total);
            row.setAttribute('data-total', total);
            calculateBulkGrandTotal();
        };

        const calculateBulkGrandTotal = () => {
            let grand = 0;
            const rows = els.bulk.body.querySelectorAll('tr');
            rows.forEach(r => {
                grand += parseFloat(r.getAttribute('data-total') || 0);
            });
            els.bulk.total.innerText = formatCurrency(grand);
        };

        window.saveBulkData = () => {
            const date = els.bulk.date.value;
            const source = els.bulk.source.value.trim();
            const type = els.bulk.type.value;

            if(!date || !source) return alert("કૃપા કરીને તારીખ અને નામ ભરો.");

            const rows = els.bulk.body.querySelectorAll('tr');
            if(rows.length === 0) return alert("કોઈ વસ્તુ ઉમેરેલ નથી.");

            let entriesToAdd = [];
            let isValid = true;
            
            const billId = editingBillId || generateId();

            rows.forEach(r => {
                const itemType = r.querySelector('.item-select').value;
                const q = parseFloat(r.querySelector('.qty-input').value);
                const rate = parseFloat(r.querySelector('.rate-input').value);
                const total = parseFloat(r.getAttribute('data-total'));

                if(!itemType || !q || !rate) {
                    isValid = false;
                } else {
                    entriesToAdd.push({
                        id: generateId(), 
                        billId: billId, 
                        date: date,
                        itemType: itemType,
                        quantity: q,
                        rate: rate,
                        amount: total,
                        sourceDest: source,
                        type: type
                    });
                }
            });

            if(!isValid) return alert("બધી વસ્તુની વિગત (નામ, જથ્થો, ભાવ) ભરો.");

            if(editingBillId) {
                allTransactionsData = allTransactionsData.filter(t => t.billId !== editingBillId);
            }

            entriesToAdd.forEach(e => allTransactionsData.push(e));
            
            editingBillId = null;
            els.bulk.btnSave.innerHTML = `<i class="fa-solid fa-save"></i> સેવ કરો`;
            els.bulk.btnCancel.classList.add('hidden');
            
            saveData();
            renderAll();
            
            els.bulk.body.innerHTML = '';
            els.bulk.source.value = '';
            els.bulk.total.innerText = '₹ 0';
            addBulkRow(); 
            
            showStatus(editingBillId ? `બિલ સુધારાઈ ગયું!` : `${entriesToAdd.length} વસ્તુઓનું બિલ ઉમેરાઈ ગયું!`);
        };
        
        window.cancelBulkEdit = () => {
            editingBillId = null;
            els.bulk.btnSave.innerHTML = `<i class="fa-solid fa-save"></i> સેવ કરો`;
            els.bulk.btnCancel.classList.add('hidden');
            els.bulk.body.innerHTML = '';
            els.bulk.source.value = '';
            els.bulk.total.innerText = '₹ 0';
            addBulkRow();
        };

        window.editBill = (billId) => {
            const billItems = allTransactionsData.filter(t => t.billId === billId);
            if(billItems.length === 0) return;

            switchMode('bulk');

            const first = billItems[0];
            els.bulk.date.value = first.date;
            els.bulk.source.value = first.sourceDest;
            els.bulk.type.value = first.type;

            els.bulk.body.innerHTML = ''; 
            billItems.forEach(item => {
                const tr = addBulkRow(); 
                const rowId = tr.id.replace('row-', '');
                tr.querySelector('.item-select').value = item.itemType;
                tr.querySelector('.qty-input').value = item.quantity;
                tr.querySelector('.rate-input').value = item.rate;
                updateBulkTotal(rowId);
            });

            editingBillId = billId;
            els.bulk.btnSave.innerHTML = `<i class="fa-solid fa-pen"></i> અપડેટ બિલ`;
            els.bulk.btnCancel.classList.remove('hidden');
            
            els.bulk.form.scrollIntoView({ behavior: 'smooth' });
        };

        // --- Data Management ---
        const loadData = () => {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                allTransactionsData = data ? JSON.parse(data) : [];
                allTransactionsData = allTransactionsData.map(t => ({...t, amount: parseFloat(t.amount), quantity: parseInt(t.quantity)}));
            } catch (e) { console.error(e); allTransactionsData = []; }
            renderAll();
        };

        const saveData = () => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allTransactionsData));
        };

        const exportData = () => {
            let dataToExport = [...allTransactionsData];
            let filenameSuffix = 'All';
            const type = els.filter.type.value;
            const dynamicDateInput = document.getElementById('filter-date-dynamic');
            if (type === 'monthly' && dynamicDateInput && dynamicDateInput.value) {
                dataToExport = dataToExport.filter(t => t.date.startsWith(dynamicDateInput.value));
                filenameSuffix = dynamicDateInput.value;
            } else if (type === 'yearly' && dynamicDateInput && dynamicDateInput.value) {
                 dataToExport = dataToExport.filter(t => t.date.startsWith(dynamicDateInput.value));
                 filenameSuffix = dynamicDateInput.value;
            }

            if(!dataToExport.length) return showStatus("ડાઉનલોડ કરવા માટે કોઈ ડેટા નથી.", 'error');

            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Navjivan_Data_${filenameSuffix}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showStatus(`ફાઈલ ડાઉનલોડ થઈ! (${filenameSuffix})`);
        };

        const resetFile = () => {
            if(confirm("શું તમે ખાતાની ફાઈલ રિસેટ કરવા માંગો છો?\n\nઆનાથી અત્યારનો બધો ડેટા જતો રહેશે અને નવું કોરું ખાતું શરૂ થશે.")) {
                localStorage.setItem(BACKUP_KEY, JSON.stringify(allTransactionsData));
                localStorage.removeItem(STORAGE_KEY);
                allTransactionsData = [];
                loadData();
                els.buttons.undo.classList.remove('hidden');
                showStatus("ફાઈલ રિસેટ થઈ ગઈ. જૂનો ડેટા 'Undo' બટનથી પાછો લાવી શકાશે.");
            }
        };

        const restoreBackup = () => {
            const backup = localStorage.getItem(BACKUP_KEY);
            if(backup) {
                if(confirm("શું તમે રિસેટ કરેલો ડેટા પાછો લાવવા માંગો છો?")) {
                    allTransactionsData = JSON.parse(backup);
                    saveData();
                    renderAll();
                    els.buttons.undo.classList.add('hidden');
                    showStatus("જૂનો ડેટા પાછો આવી ગયો!");
                }
            } else {
                showStatus("કોઈ બેકઅપ ડેટા મળ્યો નથી.", 'error');
            }
        };

        const importData = (input) => {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data)) {
                        isPreviewMode = true;
                        tempImportedData = data;
                        renderAll();
                        els.preview.banner.classList.remove('hidden');
                        els.buttons.submit.disabled = true;
                        showStatus("પ્રિવ્યુ મોડ ચાલુ છે.");
                    } else showStatus("ખોટી ફાઈલ છે.", 'error');
                } catch(err) { showStatus("ફાઈલ વાંચી શકાઈ નથી.", 'error'); }
                input.value = '';
            };
            reader.readAsText(input.files[0]);
        };

        const confirmImport = () => {
            if(confirm("આ ડેટા તમારા જૂના ડેટામાં ઉમેરાશે (Merge). શું તમે આગળ વધવા માંગો છો?")) {
                const mergedMap = new Map();
                allTransactionsData.forEach(item => mergedMap.set(item.id, item));
                tempImportedData.forEach(item => {
                    if(!item.id) item.id = generateId();
                    mergedMap.set(item.id, item);
                });
                allTransactionsData = Array.from(mergedMap.values());
                allTransactionsData.sort((a,b) => new Date(b.date) - new Date(a.date));
                saveData();
                isPreviewMode = false;
                tempImportedData = [];
                els.preview.banner.classList.add('hidden');
                els.buttons.submit.disabled = false;
                renderAll();
                showStatus("ડેટા સફળતાપૂર્વક મર્જ (Merge) થઈ ગયો!");
            }
        };

        const cancelImport = () => {
            isPreviewMode = false;
            tempImportedData = [];
            els.preview.banner.classList.add('hidden');
            els.buttons.submit.disabled = false;
            renderAll();
            showStatus("ઓરીજીનલ ડેટા પાછો આવી ગયો.");
        };

        // --- Filter Logic ---
        const updateFilterInputs = () => {
            const type = els.filter.type.value;
            els.filter.container.innerHTML = '';
            if (type === 'all') {
                els.filter.container.innerHTML = `<input type="text" disabled value="બધો ડેટા" class="w-full p-2 bg-gray-100 border rounded text-sm text-gray-400 cursor-not-allowed">`;
            } else if (type === 'monthly') {
                els.filter.container.innerHTML = `<input type="month" id="filter-date-dynamic" class="w-full p-2 border rounded text-sm bg-white">`;
                const monthInput = document.getElementById('filter-date-dynamic');
                monthInput.value = new Date().toISOString().slice(0,7);
                monthInput.addEventListener('change', renderAll);
            } else if (type === 'yearly') {
                els.filter.container.innerHTML = `<input type="number" id="filter-date-dynamic" min="2000" max="2100" class="w-full p-2 border rounded text-sm bg-white">`;
                const yearInput = document.getElementById('filter-date-dynamic');
                yearInput.value = new Date().getFullYear();
                yearInput.addEventListener('input', renderAll);
            } else if (type === 'custom') {
                const template = document.getElementById('custom-date-template').innerHTML;
                els.filter.container.innerHTML = template;
                document.getElementById('filter-start-date').addEventListener('change', renderAll);
                document.getElementById('filter-end-date').addEventListener('change', renderAll);
            }
            renderAll();
        };

        const getFilteredData = () => {
            let data = isPreviewMode ? tempImportedData : allTransactionsData;
            const query = els.inputs.search.value.toLowerCase();
            if (query) {
                data = data.filter(t => 
                    t.itemType.toLowerCase().includes(query) || 
                    t.sourceDest.toLowerCase().includes(query) ||
                    t.amount.toString().includes(query)
                );
            }
            const type = els.filter.type.value;
            const dynamicDateInput = document.getElementById('filter-date-dynamic');

            if (type === 'monthly' && dynamicDateInput && dynamicDateInput.value) {
                data = data.filter(t => t.date.startsWith(dynamicDateInput.value));
            } else if (type === 'yearly' && dynamicDateInput && dynamicDateInput.value) {
                data = data.filter(t => t.date.startsWith(dynamicDateInput.value));
            } else if (type === 'custom') {
                const start = document.getElementById('filter-start-date')?.value;
                const end = document.getElementById('filter-end-date')?.value;
                if (start) data = data.filter(t => t.date >= start);
                if (end) data = data.filter(t => t.date <= end);
            }
            return data.sort((a, b) => new Date(b.date) - new Date(a.date));
        };

        // --- Rendering ---
        const renderAll = () => {
            const filteredData = getFilteredData();

            // Calculate Totals
            let income = 0, expense = 0;
            filteredData.forEach(t => {
                if (t.type === 'income') income += t.amount;
                else expense += t.amount;
            });

            els.summary.income.innerText = formatCurrency(income);
            els.summary.expense.innerText = formatCurrency(expense);
            els.summary.balance.innerText = formatCurrency(income - expense);
            
            // Fix color class for balance based on value
            const bal = income - expense;
            els.summary.balance.className = `text-3xl font-bold ${bal >= 0 ? 'text-blue-700' : 'text-red-600'}`;

            renderTable(filteredData.filter(t => t.type === 'income'), 'income', els.lists.income, els.lists.noIncome);
            renderTable(filteredData.filter(t => t.type === 'expense'), 'expense', els.lists.expense, els.lists.noExpense);

            renderStockSummary(filteredData);
            renderMonthlyAnalysis(filteredData);
        };

        const renderTable = (data, type, tableBody, noMsg) => {
            tableBody.innerHTML = '';
            if (data.length === 0) {
                noMsg.classList.remove('hidden');
                return;
            }
            noMsg.classList.add('hidden');

            const renderedBillIds = new Set();

            data.forEach(t => {
                if (t.billId) {
                    if (renderedBillIds.has(t.billId)) return; 

                    const billItems = allTransactionsData.filter(x => x.billId === t.billId);
                    
                    const totalQty = billItems.reduce((sum, i) => sum + i.quantity, 0);
                    const totalAmt = billItems.reduce((sum, i) => sum + i.amount, 0);
                    
                    const names = [...new Set(billItems.map(i => i.itemType))].join(', ');
                    const dateObj = new Date(t.date);
                    const dateStr = `${dateObj.getDate().toString().padStart(2,'0')}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}-${dateObj.getFullYear()}`;

                    const row = document.createElement('tr');
                    // Style updated for new UI
                    row.className = "hover:bg-yellow-50 transition border-l-4 border-l-yellow-400"; 
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="text-sm font-bold text-gray-800">${dateStr}</div>
                            <div class="text-xs text-indigo-600 font-semibold truncate max-w-[100px]">${t.sourceDest}</div>
                        </td>
                        <td class="px-4 py-3 text-xs text-gray-600">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                                બિલ (${billItems.length})
                            </span>
                            <span class="ml-1">${names}</span>
                            <div class="text-gray-500 mt-1">કુલ ${totalQty} નંગ</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right font-bold ${type === 'income' ? 'text-emerald-600' : 'text-red-600'}">
                            ${formatCurrency(totalAmt)}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            <div class="flex justify-center space-x-2">
                                ${!isPreviewMode ? `
                                <button onclick="viewBill('${t.billId}')" class="text-blue-500 hover:text-blue-700 bg-blue-50 p-2 rounded-full transition" title="જોવો">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                                <button onclick="editBill('${t.billId}')" class="text-emerald-500 hover:text-emerald-700 bg-emerald-50 p-2 rounded-full transition" title="સુધારો">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button onclick="deleteBill('${t.billId}')" class="text-red-400 hover:text-red-600 bg-red-50 p-2 rounded-full transition" title="ડિલીટ">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                                ` : `<i class="fa-solid fa-lock text-gray-300"></i>`}
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                    renderedBillIds.add(t.billId);

                } else {
                    const row = document.createElement('tr');
                    const d = new Date(t.date);
                    const dateStr = `${d.getDate().toString().padStart(2,'0')}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getFullYear()}`;
                    row.className = "hover:bg-gray-50 transition group";
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="text-sm font-bold text-gray-800">${dateStr}</div>
                            <div class="text-xs text-gray-500 font-medium truncate max-w-[100px]">${t.sourceDest}</div>
                        </td>
                        <td class="px-4 py-3 text-xs text-gray-600">
                            <div class="font-bold text-gray-700">${t.itemType}</div>
                            <div>${t.quantity} નંગ x ${t.rate}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right font-bold ${type === 'income' ? 'text-emerald-600' : 'text-red-600'}">
                            ${formatCurrency(t.amount)}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            <div class="flex justify-center space-x-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                ${!isPreviewMode ? `
                                <button onclick="editTransaction('${t.id}')" class="text-indigo-500 hover:text-indigo-700 bg-indigo-50 p-2 rounded-full transition" title="સુધારો">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button onclick="deleteTransaction('${t.id}')" class="text-red-400 hover:text-red-600 bg-red-50 p-2 rounded-full transition" title="ડિલીટ">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                                ` : `<i class="fa-solid fa-lock text-gray-300"></i>`}
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        };

        const renderStockSummary = (data) => {
            const summary = {};
            data.forEach(t => {
                if (!summary[t.itemType]) summary[t.itemType] = { in: 0, out: 0 };
                if (t.type === 'income') summary[t.itemType].in += t.quantity;
                else summary[t.itemType].out += t.quantity;
            });
            const tbody = els.summary.itemBody;
            tbody.innerHTML = '';
            if(Object.keys(summary).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-400 text-xs">માહિતી નથી</td></tr>';
                return;
            }
            Object.keys(summary).forEach(item => {
                const row = document.createElement('tr');
                row.className = "hover:bg-purple-50 transition";
                row.innerHTML = `
                    <td class="px-3 py-2 text-xs font-medium text-gray-700">${item}</td>
                    <td class="px-3 py-2 text-right text-xs text-emerald-600 font-bold">${summary[item].in > 0 ? summary[item].in : '-'}</td>
                    <td class="px-3 py-2 text-right text-xs text-red-500 font-bold">${summary[item].out > 0 ? summary[item].out : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        };

        const renderMonthlyAnalysis = (data) => {
            const analysis = {};
            data.forEach(t => {
                const m = t.date.substring(0, 7);
                if (!analysis[m]) analysis[m] = { inc: 0, exp: 0 };
                if (t.type === 'income') analysis[m].inc += t.amount;
                else analysis[m].exp += t.amount;
            });
            let maxInc = { val: 0, m: 'N/A' }, minInc = { val: Infinity, m: 'N/A' };
            let maxExp = { val: 0, m: 'N/A' }, minExp = { val: Infinity, m: 'N/A' };
            Object.keys(analysis).forEach(m => {
                const a = analysis[m];
                if(a.inc > 0) {
                    if (a.inc > maxInc.val) { maxInc.val = a.inc; maxInc.m = m; }
                    if (a.inc < minInc.val) { minInc.val = a.inc; minInc.m = m; }
                }
                if(a.exp > 0) {
                    if (a.exp > maxExp.val) { maxExp.val = a.exp; maxExp.m = m; }
                    if (a.exp < minExp.val) { minExp.val = a.exp; minExp.m = m; }
                }
            });
            const formatM = (ys) => {
                if (ys === 'N/A') return 'N/A';
                const [y, m] = ys.split('-');
                return `${GUJARATI_MONTHS[parseInt(m)-1]} ${y}`;
            };
            
            els.summary.monthly.maxIncM.innerText = formatM(maxInc.m);
            els.summary.monthly.maxIncA.innerText = formatCurrency(maxInc.val);
            els.summary.monthly.maxExpM.innerText = formatM(maxExp.m);
            els.summary.monthly.maxExpA.innerText = formatCurrency(maxExp.val);
        };

        // --- CRUD Operations ---
        els.form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (isPreviewMode) return;
            const transaction = {
                id: editingTransactionId || generateId(),
                date: els.inputs.date.value,
                itemType: els.inputs.itemType.value,
                quantity: parseFloat(els.inputs.quantity.value),
                rate: parseFloat(els.inputs.rate.value),
                amount: parseFloat(els.inputs.amountHidden.value),
                sourceDest: els.inputs.sourceDest.value,
                type: els.inputs.type.value
            };
            if (editingTransactionId) {
                const index = allTransactionsData.findIndex(t => t.id === editingTransactionId);
                if (index !== -1) allTransactionsData[index] = transaction;
                showStatus("વ્યવહાર સુધારાઈ ગયો!");
                editingTransactionId = null;
                els.buttons.submit.innerHTML = `<i class="fa-solid fa-plus"></i> ઉમેરો`;
                els.buttons.cancel.classList.add('hidden');
                document.getElementById('form-title').innerText = "નવો વ્યવહાર";
            } else {
                allTransactionsData.push(transaction);
                showStatus("વ્યવહાર ઉમેરાઈ ગયો!");
            }
            saveData();
            renderAll();
            els.form.reset();
            document.getElementById('total-amount-display').value = "₹ 0";
            document.getElementById('date').valueAsDate = new Date();
        });

        window.editTransaction = (id) => {
            switchMode('single');
            const t = allTransactionsData.find(x => x.id === id);
            if (!t) return;
            els.inputs.date.value = t.date;
            els.inputs.itemType.value = t.itemType;
            els.inputs.quantity.value = t.quantity;
            els.inputs.rate.value = t.rate;
            els.inputs.sourceDest.value = t.sourceDest;
            els.inputs.type.value = t.type;
            calculateTotal();
            toggleSourceDest();
            editingTransactionId = id;
            els.buttons.submit.innerHTML = `<i class="fa-solid fa-save"></i> અપડેટ`;
            els.buttons.cancel.classList.remove('hidden');
            document.getElementById('form-title').innerText = "વ્યવહાર સુધારો";
            els.form.scrollIntoView({ behavior: 'smooth' });
        };

        window.deleteTransaction = (id) => {
            if (confirm("શું તમે આ વ્યવહાર ડિલીટ કરવા માંગો છો?")) {
                allTransactionsData = allTransactionsData.filter(t => t.id !== id);
                saveData();
                renderAll();
                showStatus("વ્યવહાર ડિલીટ કર્યો.", 'error');
            }
        };
        
        window.deleteBill = (billId) => {
             if (confirm("આખું બિલ (બધી વસ્તુઓ) ડિલીટ થશે. આગળ વધવું છે?")) {
                allTransactionsData = allTransactionsData.filter(t => t.billId !== billId);
                saveData();
                renderAll();
                showStatus("આખું બિલ ડિલીટ કર્યું.", 'error');
            }
        };

        // NEW: View Bill Detail Logic
        window.viewBill = (billId) => {
            const billItems = allTransactionsData.filter(t => t.billId === billId);
            if(billItems.length === 0) return;

            const tbody = document.getElementById('bill-modal-body');
            tbody.innerHTML = '';
            let grandTotal = 0;

            const first = billItems[0];
            const d = new Date(first.date);
            const dateStr = `${d.getDate().toString().padStart(2,'0')}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getFullYear()}`;
            
            document.getElementById('bill-modal-title').innerText = `બિલ: ${first.sourceDest}`;
            document.getElementById('bill-modal-subtitle').innerText = `તારીખ: ${dateStr} | પ્રકાર: ${first.type === 'income' ? 'આવક' : 'ખર્ચ'}`;

            billItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.itemType}</td>
                    <td class="px-4 py-3 text-sm text-right text-gray-600">${item.quantity}</td>
                    <td class="px-4 py-3 text-sm text-right text-gray-600">${item.rate}</td>
                    <td class="px-4 py-3 text-sm text-right font-bold text-emerald-600">${formatCurrency(item.amount)}</td>
                `;
                tbody.appendChild(tr);
                grandTotal += item.amount;
            });

            document.getElementById('bill-modal-total').innerText = formatCurrency(grandTotal);
            document.getElementById('bill-modal').classList.remove('hidden');
        };

        window.closeBillModal = () => {
            document.getElementById('bill-modal').classList.add('hidden');
        };

        window.openDailyReport = () => {
            document.getElementById('daily-report-modal').classList.remove('hidden');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('report-date').value = today;
            renderDailyReport();
        };

        window.closeDailyReport = () => {
            document.getElementById('daily-report-modal').classList.add('hidden');
        };

        window.renderDailyReport = () => {
            const date = document.getElementById('report-date').value;
            if(!date) return;

            const tbody = document.getElementById('daily-report-body');
            const totalQtyEl = document.getElementById('daily-report-total-qty');
            const totalAmountEl = document.getElementById('daily-report-total-amount'); 
            
            tbody.innerHTML = '';
            
            const data = allTransactionsData.filter(t => t.date === date && t.type === 'income');

            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="px-4 py-4 text-center text-gray-400 text-sm">કોઈ ડેટા નથી.</td></tr>';
                totalQtyEl.innerText = '0';
                totalAmountEl.innerText = formatCurrency(0);
                return;
            }

            const summary = {};
            let grandTotalQty = 0;
            let grandTotalAmount = 0;

            data.forEach(t => {
                if(!summary[t.itemType]) summary[t.itemType] = 0;
                summary[t.itemType] += t.quantity;
                grandTotalQty += t.quantity;
                grandTotalAmount += t.amount;
            });

            Object.keys(summary).forEach(itemType => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-5 py-3 text-sm font-medium text-gray-700">${itemType}</td>
                    <td class="px-5 py-3 text-right text-sm font-bold text-emerald-600">${summary[itemType]}</td>
                `;
                tbody.appendChild(tr);
            });

            totalQtyEl.innerText = grandTotalQty;
            totalAmountEl.innerText = formatCurrency(grandTotalAmount);
        };

        els.buttons.cancel.addEventListener('click', () => {
            editingTransactionId = null;
            els.form.reset();
            calculateTotal();
            els.buttons.submit.innerHTML = `<i class="fa-solid fa-plus"></i> ઉમેરો`;
            els.buttons.cancel.classList.add('hidden');
            document.getElementById('form-title').innerText = "નવો વ્યવહાર";
            document.getElementById('date').valueAsDate = new Date();
        });

        els.inputs.quantity.addEventListener('input', calculateTotal);
        els.inputs.rate.addEventListener('input', calculateTotal);
        els.inputs.type.addEventListener('change', toggleSourceDest);
        els.inputs.search.addEventListener('input', renderAll);
        els.filter.type.addEventListener('change', updateFilterInputs);
        els.bulk.type.addEventListener('change', () => {
            const label = document.getElementById('bulk-source-label');
            if(els.bulk.type.value === 'expense') {
                label.textContent = "પાર્ટીનું નામ (કોને ચૂકવ્યા)";
                els.bulk.source.placeholder = "નામ લખો...";
            } else {
                label.textContent = "પાર્ટીનું નામ (કોને આપ્યું)";
                els.bulk.source.placeholder = "નામ લખો...";
            }
        });

        document.getElementById('date').valueAsDate = new Date();
        updateFilterInputs();
        loadData();
    </script>
</body>
</html>
