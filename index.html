<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Navjivan Pro - рк╕рлНркорк╛рк░рлНркЯ рк╣рк┐рк╕рк╛ркм</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Gujarati:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'Noto Sans Gujarati', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4F46E5', /* Indigo 600 */
                        secondary: '#10B981', /* Emerald 500 */
                        danger: '#EF4444', /* Red 500 */
                        dark: '#111827',
                        light: '#F3F4F6'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        /* Smooth Transitions */
        .transition-all-300 { transition: all 0.3s ease-in-out; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Card Hover Effects */
        .hover-lift { transition: transform 0.2s, box-shadow 0.2s; }
        .hover-lift:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        /* Mobile Bottom Nav */
        @media (max-width: 768px) {
            .mobile-bottom-padding { padding-bottom: 80px; }
            .hide-on-mobile { display: none; }
        }
        
        /* Glass Effect */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        /* Input Styles */
        .form-input {
            width: 100%;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        .form-input:focus {
            background-color: #fff;
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex">

    <!-- Sidebar (Desktop Only) -->
    <aside class="w-64 bg-dark text-white hidden md:flex flex-col shadow-2xl z-20">
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">
                ркирк╡ркЬрлАрк╡рки
            </h1>
            <p class="text-xs text-gray-400 mt-1">рккрк╢рлБркЖрк╣рк╛рк░ рк╣рк┐рк╕рк╛ркм</p>
        </div>
        
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="showSection('dashboard')" class="nav-btn w-full flex items-center p-3 rounded-xl bg-primary text-white shadow-lg transition-all-300">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                ркбрлЗрк╢ркмрлЛрк░рлНркб (Home)
            </button>
            <button onclick="showSection('transactions')" class="nav-btn w-full flex items-center p-3 rounded-xl hover:bg-gray-800 text-gray-300 transition-all-300">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                рк╡рлНркпрк╡рк╣рк╛рк░рлЛ (List)
            </button>
            <button onclick="showSection('add-new')" class="nav-btn w-full flex items-center p-3 rounded-xl hover:bg-gray-800 text-gray-300 transition-all-300">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                ркирк╡рлБркВ ркЙркорлЗрк░рлЛ (Add)
            </button>
            <button onclick="showSection('settings')" class="nav-btn w-full flex items-center p-3 rounded-xl hover:bg-gray-800 text-gray-300 transition-all-300">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                ркбрлЗркЯрк╛ / рк╕рлЗркЯрк┐ркВркЧрлНрк╕
            </button>
        </nav>
        
        <div class="p-4 border-t border-gray-700">
            <p class="text-xs text-center text-gray-500">v2.1 Pro Edition</p>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto relative mobile-bottom-padding">
        <!-- Top Bar -->
        <header class="sticky top-0 z-10 glass border-b border-gray-200 px-6 py-3 flex justify-between items-center">
            <h2 id="page-title" class="text-xl font-bold text-gray-800">ркбрлЗрк╢ркмрлЛрк░рлНркб</h2>
            <div class="flex items-center gap-3">
                <div id="preview-badge" class="hidden px-3 py-1 bg-yellow-100 text-yellow-700 text-xs font-bold rounded-full animate-pulse border border-yellow-300">
                    Preview Mode
                </div>
                <button onclick="exportData()" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition text-gray-600" title="Download Data">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                </button>
            </div>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="p-4 md:p-8 space-y-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Income -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover-lift relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-emerald-50 rounded-bl-full -mr-4 -mt-4 z-0"></div>
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-gray-500 uppercase">ркХрлБрк▓ ркЖрк╡ркХ (Total Income)</p>
                        <h3 id="dash-income" class="text-3xl font-bold text-gray-800 mt-2">тВ╣ 0</h3>
                        <p class="text-xs text-emerald-600 mt-2 font-semibold flex items-center">
                            <span class="bg-emerald-100 p-1 rounded-full mr-1">тЖЧ</span>
                            ркЖрк╡ркХ рк╡ркзрлА рк░рк╣рлА ркЫрлЗ
                        </p>
                    </div>
                </div>
                <!-- Expense -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover-lift relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-red-50 rounded-bl-full -mr-4 -mt-4 z-0"></div>
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-gray-500 uppercase">ркХрлБрк▓ ркЦрк░рлНркЪ (Total Expense)</p>
                        <h3 id="dash-expense" class="text-3xl font-bold text-gray-800 mt-2">тВ╣ 0</h3>
                         <p class="text-xs text-red-600 mt-2 font-semibold flex items-center">
                            <span class="bg-red-100 p-1 rounded-full mr-1">тЖШ</span>
                            ркЦрк░рлНркЪ рккрк░ ркзрлНркпрк╛рки ркЖрккрлЛ
                        </p>
                    </div>
                </div>
                <!-- Balance -->
                <div class="bg-gradient-to-br from-indigo-600 to-purple-600 p-6 rounded-2xl shadow-lg hover-lift text-white relative">
                    <p class="text-sm font-medium text-indigo-100 uppercase">ркЪрлЛркЦрлНркЦрлБркВ ркмрлЗрк▓рлЗркирлНрк╕ (Net Balance)</p>
                    <h3 id="dash-balance" class="text-3xl font-bold mt-2">тВ╣ 0</h3>
                    <p class="text-xs text-indigo-100 mt-2 opacity-80">ркдркорк╛рк░рлА рккрк╛рк╕рлЗ ркЕркдрлНркпрк╛рк░рлЗ ркЖркЯрк▓рк╛ рк░рлВрккрк┐ркпрк╛ ркЫрлЗ.</p>
                </div>
            </div>

            <!-- Charts & Lists Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Main Chart -->
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h3 class="font-bold text-gray-700 mb-2 sm:mb-0">ркорк╛рк╕рк┐ркХ ркЖрк╡ркХ-ркЦрк░рлНркЪ ркЧрлНрк░рк╛ркл</h3>
                        <select id="chart-filter" class="text-sm border rounded p-2 bg-gray-50 w-full sm:w-auto" onchange="updateChart()">
                            <option value="6">ркЫрлЗрк▓рлНрк▓рк╛ 6 ркорк╣рк┐ркирк╛</option>
                            <option value="12">ркЫрлЗрк▓рлНрк▓рк╛ 12 ркорк╣рк┐ркирк╛</option>
                            <option value="all">ркмркзрлЛ ркбрлЗркЯрк╛</option>
                        </select>
                    </div>
                    <div class="h-64 w-full">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                    <h3 class="font-bold text-gray-700 mb-4">ркдрк╛ркЬрлЗркдрк░ркирк╛ рк╡рлНркпрк╡рк╣рк╛рк░рлЛ</h3>
                    <div id="recent-list" class="flex-1 overflow-y-auto space-y-3 custom-scroll pr-2" style="max-height: 300px;">
                        <!-- Items populated via JS -->
                        <div class="text-center text-gray-400 text-sm py-10">ркХрлЛркИ ркбрлЗркЯрк╛ ркиркерлА</div>
                    </div>
                    <button onclick="showSection('transactions')" class="mt-4 w-full py-2 text-sm text-primary font-bold bg-indigo-50 rounded-lg hover:bg-indigo-100 transition">ркмркзрк╛ ркЬрлБркУ</button>
                </div>
            </div>

             <!-- Stock Quick View -->
             <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4">рк╕рлНркЯрлЛркХ рк╕ркорк░рлА (Stock Overview)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-xs text-gray-500 uppercase font-semibold">
                            <tr>
                                <th class="px-4 py-3 text-left rounded-l-lg">рк╡рк╕рлНркдрлБ</th>
                                <th class="px-4 py-3 text-right text-emerald-600">ркЖрк╡ркХ (In)</th>
                                <th class="px-4 py-3 text-right text-red-600">ркЬрк╛рк╡ркХ (Out)</th>
                                <th class="px-4 py-3 text-right text-blue-600 rounded-r-lg">рк╕рлНркЯрлЛркХ</th>
                            </tr>
                        </thead>
                        <tbody id="dash-stock-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
             </div>
        </div>

        <!-- TRANSACTIONS VIEW -->
        <div id="view-transactions" class="hidden p-4 md:p-8 space-y-6">
            <!-- Filter Bar -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row gap-4 justify-between items-center">
                <div class="relative w-full md:w-96">
                    <svg class="absolute left-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="text" id="list-search" placeholder="ркирк╛рко, ркдрк╛рк░рлАркЦ ркХрлЗ рк░ркХрко рк╢рлЛркзрлЛ..." class="form-input pl-10">
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <select id="list-filter-type" class="form-input w-full md:w-auto" onchange="renderTransactionsList()">
                        <option value="all">ркмркзрк╛ (All)</option>
                        <option value="income">рклркХрлНркд ркЖрк╡ркХ</option>
                        <option value="expense">рклркХрлНркд ркЦрк░рлНркЪ</option>
                    </select>
                    <input type="month" id="list-filter-date" class="form-input w-full md:w-auto" onchange="renderTransactionsList()">
                </div>
            </div>

            <!-- List Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 text-xs uppercase text-gray-500 font-semibold border-b">
                            <tr>
                                <th class="px-6 py-4 text-left">ркдрк╛рк░рлАркЦ & рккрк╛рк░рлНркЯрлА</th>
                                <th class="px-6 py-4 text-left">рк╡рк┐ркЧркд</th>
                                <th class="px-6 py-4 text-right">рк░ркХрко</th>
                                <th class="px-6 py-4 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="main-list-body" class="divide-y divide-gray-100 text-sm"></tbody>
                    </table>
                </div>
                <div id="list-empty" class="hidden p-10 text-center flex flex-col items-center justify-center">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-gray-400 text-2xl">ЁЯУВ</div>
                    <p class="text-gray-500">ркХрлЛркИ ркбрлЗркЯрк╛ ркорк│рлНркпрлЛ ркиркерлА.</p>
                </div>
            </div>
        </div>

        <!-- ADD NEW VIEW -->
        <div id="view-add-new" class="hidden p-4 md:p-8 flex justify-center">
            <div class="w-full max-w-4xl bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden">
                <div class="bg-gradient-to-r from-primary to-purple-600 p-6 text-white flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">ркирк╡рлЛ рк╡рлНркпрк╡рк╣рк╛рк░</h2>
                        <p class="text-indigo-100 text-sm opacity-90">ркдркорк╛рк░рлЛ рк░рлЛркЬркорлЗрк│ ркЕрккркбрлЗркЯ ркХрк░рлЛ</p>
                    </div>
                    <!-- Toggle Switch -->
                    <div class="bg-black/20 p-1 rounded-lg flex text-xs font-bold">
                        <button onclick="toggleEntryMode('single')" id="mode-single" class="px-4 py-2 rounded-md bg-white text-primary shadow-sm transition-all">Single</button>
                        <button onclick="toggleEntryMode('bulk')" id="mode-bulk" class="px-4 py-2 rounded-md text-indigo-100 hover:bg-white/10 transition-all">Bill Entry</button>
                    </div>
                </div>

                <div class="p-6 md:p-8">
                    <!-- SINGLE FORM -->
                    <form id="single-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ркдрк╛рк░рлАркЦ</label>
                                <input type="date" id="s-date" class="form-input" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">рк╡рлНркпрк╡рк╣рк╛рк░ рккрлНрк░ркХрк╛рк░</label>
                                <select id="s-type" class="form-input" onchange="handleTypeChange()">
                                    <option value="income">ркЖрк╡ркХ (ркЬркорк╛)</option>
                                    <option value="expense">ркЦрк░рлНркЪ (ркЙркзрк╛рк░)</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label id="s-party-label" class="block text-sm font-medium text-gray-700 mb-1">рккрк╛рк░рлНркЯрлАркирлБркВ ркирк╛рко (ркХрлЛркирлЗ ркЖрккрлНркпрлБркВ?)</label>
                                <input type="text" id="s-party" class="form-input" placeholder="ркжрк╛.ркд. рк░ркорлЗрк╢ркнрк╛ркИ рккркЯрлЗрк▓" required>
                            </div>
                            
                            <!-- Items Section -->
                            <div class="md:col-span-2 bg-gray-50 p-5 rounded-xl border border-gray-200">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">рк╡рк╕рлНркдрлБ (Item)</label>
                                        <select id="s-item" class="form-input mt-1">
                                            <option value="" disabled selected>рккрк╕ркВркж ркХрк░рлЛ</option>
                                            <option value="ркоркХрк╛ркИ рккрк╛рккркбрлА">ркоркХрк╛ркИ рккрк╛рккркбрлА</option>
                                            <option value="ркоркХрк╛ркИ ркнрк░ркбрлЛ">ркоркХрк╛ркИ ркнрк░ркбрлЛ</option>
                                            <option value="рккрк╛рккркбрлА">рккрк╛рккркбрлА</option>
                                            <option value="ркЬрк╡ ркнрк░ркбрлЛ">ркЬрк╡ ркнрк░ркбрлЛ</option>
                                            <option value="рк╕рлЛркпрк╛ркмрлАрки">рк╕рлЛркпрк╛ркмрлАрки</option>
                                            <option value="ркдрлБрк╡рлЗрк░ркЪрлБркирлА">ркдрлБрк╡рлЗрк░ркЪрлБркирлА</option>
					       <option value="ркЬрлАрк░рк╛рк│рлЛ ">ркЬрлАрк░рк╛рк│рлЛ </option>
                                            <option value="рккрк╢рлБ ркЖрк╣рк╛рк░">рккрк╢рлБ ркЖрк╣рк╛рк░</option>
                                            <option value="рк▓рк╛рк▓рлА">рк▓рк╛рк▓рлА</option>
                                            <option value="ркжрк╛ркг">ркжрк╛ркг</option>
                                            <option value="ркЕркирлНркп">ркЕркирлНркп</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">ркиркВркЧ (Qty)</label>
                                        <input type="number" id="s-qty" class="form-input mt-1" placeholder="0" oninput="calcSingleTotal()">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">ркнрк╛рк╡ (Rate)</label>
                                        <input type="number" id="s-rate" class="form-input mt-1" placeholder="0.00" oninput="calcSingleTotal()">
                                    </div>
                                </div>
                                <div class="mt-4 flex justify-between items-end border-t border-gray-200 pt-4">
                                    <p class="text-sm text-gray-500">ркХрлБрк▓ рк░ркХрко</p>
                                    <p id="s-total-display" class="text-2xl font-bold text-primary">тВ╣ 0</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-4 pt-2">
                            <button type="button" onclick="resetForm('single')" class="px-6 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 transition">рк░рлАрк╕рлЗркЯ</button>
                            <button type="submit" class="flex-1 px-6 py-3 rounded-xl bg-primary text-white font-bold shadow-lg hover:shadow-xl hover:bg-indigo-700 transition transform active:scale-95">
                                рк╕рлЗрк╡ ркХрк░рлЛ
                            </button>
                        </div>
                    </form>

                    <!-- BULK FORM (Hidden) -->
                    <div id="bulk-form" class="hidden space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ркдрк╛рк░рлАркЦ</label>
                                <input type="date" id="b-date" class="form-input" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">рккрк╛рк░рлНркЯрлАркирлБркВ ркирк╛рко</label>
                                <input type="text" id="b-party" class="form-input" placeholder="рккрк╛рк░рлНркЯрлАркирлБркВ ркирк╛рко" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">рккрлНрк░ркХрк╛рк░</label>
                                <select id="b-type" class="form-input">
                                    <option value="income">ркЖрк╡ркХ</option>
                                    <option value="expense">ркЦрк░рлНркЪ</option>
                                </select>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-xl border border-gray-200 overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100 text-xs uppercase text-gray-500">
                                    <tr>
                                        <th class="px-4 py-3 text-left">рк╡рк╕рлНркдрлБ</th>
                                        <th class="px-4 py-3 w-24">ркиркВркЧ</th>
                                        <th class="px-4 py-3 w-28">ркнрк╛рк╡</th>
                                        <th class="px-4 py-3 w-32 text-right">ркХрлБрк▓</th>
                                        <th class="px-4 py-3 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody id="bulk-rows" class="bg-white divide-y divide-gray-100"></tbody>
                            </table>
                            <div class="p-3 bg-gray-50 border-t flex justify-between items-center">
                                <button onclick="addBulkRow()" class="text-primary font-bold text-sm hover:underline">+ ркмрлАркЬрлА рк╡рк╕рлНркдрлБ ркЙркорлЗрк░рлЛ</button>
                                <div class="font-bold text-gray-800">Grand Total: <span id="b-grand-total" class="text-primary text-lg ml-2">тВ╣ 0</span></div>
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button onclick="resetForm('bulk')" class="px-6 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-50">Cancel</button>
                            <button onclick="saveBulk()" class="flex-1 px-6 py-3 rounded-xl bg-primary text-white font-bold shadow-lg hover:shadow-xl hover:bg-indigo-700 transition">ркмркзрлБркВ рк╕рлЗрк╡ ркХрк░рлЛ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="view-settings" class="hidden p-4 md:p-8 max-w-2xl mx-auto space-y-6">
            <h2 class="text-2xl font-bold text-gray-800">ркбрлЗркЯрк╛ ркорлЗркирлЗркЬркорлЗркирлНркЯ</h2>
            
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">ркмрлЗркХркЕркк ркЕркирлЗ рк░рлАрк╕рлНркЯрлЛрк░</h3>
                <div class="space-y-4">
                    <button onclick="exportData()" class="w-full flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition border border-gray-200">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 text-blue-600 rounded-lg mr-3">тмЗя╕П</div>
                            <div class="text-left">
                                <p class="font-bold text-gray-800">ркбрлЗркЯрк╛ ркбрк╛ркЙркирк▓рлЛркб ркХрк░рлЛ</p>
                                <p class="text-xs text-gray-500">JSON рклрк╛ркИрк▓ ркдрк░рлАркХрлЗ рк╕рлЗрк╡ ркХрк░рлЛ</p>
                            </div>
                        </div>
                        <span class="text-gray-400">тЮФ</span>
                    </button>
                    
                    <label class="w-full flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition border border-gray-200 cursor-pointer">
                        <div class="flex items-center">
                            <div class="p-2 bg-emerald-100 text-emerald-600 rounded-lg mr-3">тмЖя╕П</div>
                            <div class="text-left">
                                <p class="font-bold text-gray-800">ркбрлЗркЯрк╛ ркЕрккрк▓рлЛркб ркХрк░рлЛ</p>
                                <p class="text-xs text-gray-500">ркЬрлВркирлА рклрк╛ркИрк▓ рккрк╛ркЫрлА рк▓рк╛рк╡рлЛ</p>
                            </div>
                        </div>
                        <input type="file" accept=".json" class="hidden" onchange="importData(this)">
                        <span class="text-gray-400">тЮФ</span>
                    </label>

                    <button onclick="resetData()" class="w-full flex items-center justify-between p-4 bg-red-50 rounded-xl hover:bg-red-100 transition border border-red-200">
                        <div class="flex items-center">
                            <div class="p-2 bg-red-200 text-red-600 rounded-lg mr-3">ЁЯЧСя╕П</div>
                            <div class="text-left">
                                <p class="font-bold text-red-700">ркмркзрлЛ ркбрлЗркЯрк╛ ркбрк┐рк▓рлАркЯ ркХрк░рлЛ</p>
                                <p class="text-xs text-red-500">ркЪрлЗркдрк╡ркгрлА: ркЖ ркХрлНрк░рк┐ркпрк╛ рккрк╛ркЫрлА ркирк╣рлАркВ ркЖрк╡рлЗ</p>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
            
            <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100 text-center">
                <p class="text-indigo-800 font-bold">Navjivan Pashuahar Pro</p>
                <p class="text-indigo-600 text-xs mt-1">Version 2.1 | Offline Secure Storage</p>
            </div>
        </div>
        
        <!-- Mobile Bottom Spacing -->
        <div class="h-20 md:hidden"></div>
    </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-5px_10px_rgba(0,0,0,0.05)] z-30 flex justify-around p-2 pb-4">
        <button onclick="showSection('dashboard')" class="mobile-nav-btn flex flex-col items-center p-2 text-primary">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span class="text-[10px] font-bold mt-1">Home</span>
        </button>
        <button onclick="showSection('transactions')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <span class="text-[10px] font-bold mt-1">List</span>
        </button>
        <div class="relative -top-6">
            <button onclick="showSection('add-new')" class="w-14 h-14 bg-primary text-white rounded-full shadow-lg flex items-center justify-center hover:scale-105 transition border-4 border-gray-100">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            </button>
        </div>
        <button onclick="showSection('settings')" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <span class="text-[10px] font-bold mt-1">Data</span>
        </button>
    </nav>

    <!-- Bill Modal -->
    <div id="modal-bill" class="fixed inset-0 bg-black/60 hidden z-50 flex justify-center items-end md:items-center backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full md:max-w-lg md:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden animate-[slideUp_0.3s_ease-out]">
            <div class="bg-indigo-600 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold text-lg">ркмрк┐рк▓ рк╡рк┐ркЧркд</h3>
                <button onclick="closeModal()" class="bg-white/20 hover:bg-white/30 rounded-full p-1"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <div class="p-5 max-h-[70vh] overflow-y-auto">
                <div class="flex justify-between items-end border-b pb-3 mb-3">
                    <div>
                        <p class="text-xs text-gray-500 uppercase">рккрк╛рк░рлНркЯрлАркирлБркВ ркирк╛рко</p>
                        <p id="m-party" class="text-lg font-bold text-gray-800">Name</p>
                    </div>
                    <div class="text-right">
                        <p id="m-date" class="text-xs text-gray-500">Date</p>
                        <span id="m-badge" class="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100">TYPE</span>
                    </div>
                </div>
                <table class="w-full text-sm">
                    <thead class="text-gray-500 text-xs uppercase bg-gray-50">
                        <tr><th class="py-2 text-left">рк╡рк╕рлНркдрлБ</th><th class="py-2 text-right">Qty</th><th class="py-2 text-right">Price</th><th class="py-2 text-right">Total</th></tr>
                    </thead>
                    <tbody id="m-body" class="divide-y divide-gray-100"></tbody>
                </table>
                <div class="mt-4 pt-4 border-t flex justify-between items-center">
                    <span class="font-bold text-gray-600">Grand Total</span>
                    <span id="m-total" class="text-xl font-bold text-indigo-600">тВ╣ 0</span>
                </div>
                <div class="mt-6 flex gap-3">
                    <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 font-bold rounded-xl text-gray-600">ркмркВркз ркХрк░рлЛ</button>
                    <button id="m-delete-btn" class="flex-1 py-3 bg-red-50 text-red-600 font-bold rounded-xl border border-red-100">ркбрк┐рк▓рлАркЯ ркмрк┐рк▓</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // State
        const STORAGE_KEY = 'khataPro_v2';
        let transactions = [];
        let chartInstance = null;
        let isPreview = false;
        let dataRange = { start: null, end: null }; // New: To store min/max dates

        // Init
        window.onload = () => {
            loadData();
            document.getElementById('s-date').valueAsDate = new Date();
            document.getElementById('b-date').valueAsDate = new Date();
            document.getElementById('list-filter-date').value = new Date().toISOString().slice(0, 7);
            addBulkRow(); // Init bulk row
        };

        // Navigation
        function showSection(id) {
            // Hide all
            ['dashboard', 'transactions', 'add-new', 'settings'].forEach(s => {
                document.getElementById('view-' + s).classList.add('hidden');
            });
            // Show selected
            document.getElementById('view-' + id).classList.remove('hidden');
            
            // Update Title
            const titles = { 'dashboard': 'ркбрлЗрк╢ркмрлЛрк░рлНркб', 'transactions': 'рк╡рлНркпрк╡рк╣рк╛рк░рлЛ', 'add-new': 'ркирк╡рлБркВ ркЙркорлЗрк░рлЛ', 'settings': 'рк╕рлЗркЯрк┐ркВркЧрлНрк╕' };
            document.getElementById('page-title').innerText = titles[id];

            // Update Desktop Nav Active State
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white', 'shadow-lg');
                btn.classList.add('text-gray-300', 'hover:bg-gray-800');
                if(btn.innerHTML.includes(titles[id].split(' ')[0])) { // Simple matching logic
                    btn.classList.add('bg-primary', 'text-white', 'shadow-lg');
                    btn.classList.remove('text-gray-300', 'hover:bg-gray-800');
                }
            });

             // Update Mobile Nav
             document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                 btn.classList.remove('text-primary');
                 btn.classList.add('text-gray-400');
                 if(btn.onclick.toString().includes(id)) {
                     btn.classList.add('text-primary');
                     btn.classList.remove('text-gray-400');
                 }
             });

            if(id === 'dashboard') renderDashboard();
            if(id === 'transactions') renderTransactionsList();
        }

        // --- Data Logic ---
        function loadData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                transactions = raw ? JSON.parse(raw) : [];
                transactions = transactions.map(t => ({...t, amount: parseFloat(t.amount), qty: parseInt(t.qty || t.quantity) })); // Normalize
                
                // NEW: Calculate data range and setup chart filter
                calculateDataRange(); 

                renderDashboard();
            } catch(e) { console.error("Load Error", e); transactions = []; }
        }

        function calculateDataRange() {
            if (transactions.length === 0) {
                dataRange = { start: null, end: null };
                return;
            }

            // Ensure all transactions have valid dates before calculating
            const validDates = transactions.map(t => new Date(t.date)).filter(d => !isNaN(d));
            
            if (validDates.length === 0) {
                 dataRange = { start: null, end: null };
                 return;
            }

            const minDate = new Date(Math.min(...validDates));
            const maxDate = new Date(Math.max(...validDates));
            
            dataRange.start = minDate.toISOString().slice(0, 10);
            dataRange.end = maxDate.toISOString().slice(0, 10);
            
            // Update "All Data" option label
            const allOption = document.querySelector('#chart-filter option[value="all"]');
            if (allOption) {
                const startYear = minDate.getFullYear();
                const endYear = maxDate.getFullYear();
                const label = (startYear !== endYear) 
                    ? `ркмркзрлЛ ркбрлЗркЯрк╛ (${startYear} - ${endYear})`
                    : `ркмркзрлЛ ркбрлЗркЯрк╛ (${startYear})`;
                allOption.textContent = label;
            }
        }

        function saveData() {
            if(isPreview) return;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
            calculateDataRange(); // Recalculate range after saving
            renderDashboard();
        }

        const formatCurrency = (amt) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }).format(amt);
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

        // --- Dashboard ---
        function renderDashboard() {
            let income = 0, expense = 0;
            const stock = {};

            transactions.forEach(t => {
                if(t.type === 'income') {
                    income += t.amount;
                    if(!stock[t.item]) stock[t.item] = { in: 0, out: 0 };
                    stock[t.item].in += t.qty;
                } else {
                    expense += t.amount;
                    if(!stock[t.item]) stock[t.item] = { in: 0, out: 0 };
                    stock[t.item].out += t.qty;
                }
            });

            // Animate Numbers
            animateValue("dash-income", income);
            animateValue("dash-expense", expense);
            animateValue("dash-balance", income - expense);

            // Recent List
            const recent = [...transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            const rList = document.getElementById('recent-list');
            rList.innerHTML = '';
            
            // Deduplicate Bills for Recent View
            const seenBills = new Set();
            recent.forEach(t => {
                if(t.billId && seenBills.has(t.billId)) return;
                if(t.billId) seenBills.add(t.billId);
                
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="p-2 rounded-full ${t.type==='income' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}">
                            ${t.type==='income' ? 'тЖУ' : 'тЖС'}
                        </div>
                        <div>
                            <p class="font-bold text-sm text-gray-800">${t.party || t.sourceDest}</p>
                            <p class="text-xs text-gray-500">${t.item} ${t.billId ? '(Bill)' : ''}</p>
                        </div>
                    </div>
                    <span class="font-bold text-sm ${t.type==='income' ? 'text-emerald-600' : 'text-red-600'}">
                        ${t.type==='income' ? '+' : '-'} ${formatCurrency(t.amount)}
                    </span>
                `;
                rList.appendChild(div);
            });
            if(recent.length === 0) rList.innerHTML = `<div class="text-center text-gray-400 text-sm py-10">ркХрлЛркИ ркбрлЗркЯрк╛ ркиркерлА</div>`;

            // Stock Table
            const sBody = document.getElementById('dash-stock-body');
            sBody.innerHTML = '';
            Object.keys(stock).forEach(k => {
                const bal = stock[k].in - stock[k].out;
                sBody.innerHTML += `
                    <tr>
                        <td class="px-4 py-2 font-medium text-gray-700 border-l-4 border-indigo-500 bg-indigo-50/30">${k}</td>
                        <td class="px-4 py-2 text-right font-bold text-emerald-600">${stock[k].in}</td>
                        <td class="px-4 py-2 text-right font-bold text-red-600">${stock[k].out}</td>
                        <td class="px-4 py-2 text-right font-bold text-blue-600 bg-blue-50/50">${bal}</td>
                    </tr>
                `;
            });

            updateChart();
        }

        function animateValue(id, end) {
            const obj = document.getElementById(id);
            obj.innerText = formatCurrency(end); // Simple update for now
        }

        function updateChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const filterValue = document.getElementById('chart-filter').value;
            
            const labels = [];
            const dataInc = [];
            const dataExp = [];

            let startDate = null;
            let endDate = new Date(); // Default end date is today

            if (dataRange.start && filterValue === 'all') {
                startDate = new Date(dataRange.start);
                // Ensure endDate is at least the end date of the data, or today if data is old.
                const dataEnd = new Date(dataRange.end);
                endDate = (dataEnd > endDate) ? dataEnd : endDate; 
            } else if (filterValue !== 'all') {
                const months = parseInt(filterValue);
                startDate = new Date();
                startDate.setMonth(startDate.getMonth() - months + 1); // Start from the first day of the Nth month ago
                startDate.setDate(1); 
            }
            
            // If no data, or start date is null, clear and return
            if (!startDate || transactions.length === 0) {
                 if(chartInstance) chartInstance.destroy();
                 return;
            }

            // Generate monthly labels and aggregate data
            let current = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
            
            while (current <= endDate) {
                const year = current.getFullYear();
                const month = current.getMonth();
                
                // Format YYYY-MM for filtering
                const key = current.toISOString().slice(0, 7); 
                
                // Label format: Short month name (e.g., Dec, Jan)
                const mName = current.toLocaleString('default', { month: 'short', year: 'numeric' }).replace(/\s\d{4}/, ''); // Remove year if present
                labels.push(mName);
                
                let inc = 0, exp = 0;
                transactions.filter(t => t.date.startsWith(key)).forEach(t => {
                    t.type === 'income' ? inc += t.amount : exp += t.amount;
                });

                dataInc.push(inc);
                dataExp.push(exp);

                // Move to the next month
                current.setMonth(current.getMonth() + 1);
                
                // Stop if the loop goes too far (safety break)
                if(labels.length > 200) break; 
            }

            // Remove year from label if only one year is present
            const uniqueYears = new Set(labels.map(l => l.slice(-4)));
            if (uniqueYears.size === 1) {
                const formattedLabels = labels.map(l => l.split(' ')[0]);
                labels.length = 0;
                labels.push(...formattedLabels);
            }
            

            if(chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ркЖрк╡ркХ', data: dataInc, backgroundColor: '#10B981', borderRadius: 5 },
                        { label: 'ркЦрк░рлНркЪ', data: dataExp, backgroundColor: '#EF4444', borderRadius: 5 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // --- Transactions List ---
        function renderTransactionsList() {
            const filterType = document.getElementById('list-filter-type').value;
            const filterDate = document.getElementById('list-filter-date').value;
            const search = document.getElementById('list-search').value.toLowerCase();
            const tbody = document.getElementById('main-list-body');
            const empty = document.getElementById('list-empty');

            let filtered = transactions.filter(t => {
                const matchesSearch = (t.party || t.sourceDest).toLowerCase().includes(search) || t.item.toLowerCase().includes(search);
                const matchesType = filterType === 'all' || t.type === filterType;
                const matchesDate = !filterDate || t.date.startsWith(filterDate);
                return matchesSearch && matchesType && matchesDate;
            });

            // Group Bills
            const processedBillIds = new Set();
            tbody.innerHTML = '';
            
            if(filtered.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            // Sort Descending
            filtered.sort((a,b) => new Date(b.date) - new Date(a.date));

            filtered.forEach(t => {
                if(t.billId) {
                    if(processedBillIds.has(t.billId)) return;
                    
                    // Bill Summary
                    const billItems = transactions.filter(x => x.billId === t.billId); // Fetch from source to get full total
                    const total = billItems.reduce((s, i) => s + i.amount, 0);
                    const itemsStr = [...new Set(billItems.map(i => i.item))].join(', ');
                    
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-indigo-50/30 transition group border-b last:border-0";
                    tr.innerHTML = `
                        <td class="px-6 py-4">
                            <p class="font-bold text-gray-800">${t.party || t.sourceDest}</p>
                            <p class="text-xs text-gray-500">${t.date}</p>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-indigo-100 text-indigo-700 border border-indigo-200">BILL</span>
                            <p class="text-sm text-gray-600 truncate max-w-xs">${itemsStr}</p>
                        </td>
                        <td class="px-6 py-4 text-right">
                             <span class="font-bold ${t.type==='income'?'text-emerald-600':'text-red-600'}">${formatCurrency(total)}</span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="openBillModal('${t.billId}')" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-lg transition font-medium text-xs border border-indigo-100">View Details</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                    processedBillIds.add(t.billId);
                } else {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition border-b last:border-0";
                    tr.innerHTML = `
                        <td class="px-6 py-4">
                            <p class="font-bold text-gray-800">${t.party || t.sourceDest}</p>
                            <p class="text-xs text-gray-500">${t.date}</p>
                        </td>
                        <td class="px-6 py-4">
                            <p class="text-sm text-gray-600 font-medium">${t.item}</p>
                            <p class="text-xs text-gray-400">${t.qty} x ${t.rate}</p>
                        </td>
                        <td class="px-6 py-4 text-right">
                             <span class="font-bold ${t.type==='income'?'text-emerald-600':'text-red-600'}">${formatCurrency(t.amount)}</span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="deleteTx('${t.id}')" class="text-red-400 hover:text-red-600 p-2 transition" title="Delete">ЁЯЧСя╕П</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        }

        // --- Add New Logic ---
        function toggleEntryMode(mode) {
            if(mode === 'single') {
                document.getElementById('single-form').classList.remove('hidden');
                document.getElementById('bulk-form').classList.add('hidden');
                document.getElementById('mode-single').className = "px-4 py-2 rounded-md bg-white text-primary shadow-sm transition-all";
                document.getElementById('mode-bulk').className = "px-4 py-2 rounded-md text-indigo-100 hover:bg-white/10 transition-all";
            } else {
                document.getElementById('single-form').classList.add('hidden');
                document.getElementById('bulk-form').classList.remove('hidden');
                document.getElementById('mode-bulk').className = "px-4 py-2 rounded-md bg-white text-primary shadow-sm transition-all";
                document.getElementById('mode-single').className = "px-4 py-2 rounded-md text-indigo-100 hover:bg-white/10 transition-all";
                if(!document.getElementById('b-date').value) document.getElementById('b-date').valueAsDate = new Date();
            }
        }

        function handleTypeChange() {
            const type = document.getElementById('s-type').value;
            const label = document.getElementById('s-party-label');
            const ph = document.getElementById('s-party');
            if(type === 'expense') {
                label.innerText = "рккрк╛рк░рлНркЯрлАркирлБркВ ркирк╛рко (ркХрлЛркирлЗ ркЪрлВркХрк╡рлНркпрк╛?)";
                ph.placeholder = "ркХрлЛркирлЗ ркЪрлВркХрк╡рлНркпрк╛?";
            } else {
                label.innerText = "рккрк╛рк░рлНркЯрлАркирлБркВ ркирк╛рко (ркХрлЛркирлЗ ркЖрккрлНркпрлБркВ?)";
                ph.placeholder = "ркХрлЛркирлЗ ркЖрккрлНркпрлБркВ?";
            }
        }

        function calcSingleTotal() {
            const q = parseFloat(document.getElementById('s-qty').value) || 0;
            const r = parseFloat(document.getElementById('s-rate').value) || 0;
            document.getElementById('s-total-display').innerText = formatCurrency(q*r);
        }

        // Single Form Submit
        document.getElementById('single-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const tx = {
                id: generateId(),
                date: document.getElementById('s-date').value,
                type: document.getElementById('s-type').value,
                party: document.getElementById('s-party').value,
                item: document.getElementById('s-item').value,
                qty: parseFloat(document.getElementById('s-qty').value),
                rate: parseFloat(document.getElementById('s-rate').value),
                amount: parseFloat(document.getElementById('s-qty').value) * parseFloat(document.getElementById('s-rate').value)
            };
            transactions.push(tx);
            saveData();
            resetForm('single');
            alert("рк╡рлНркпрк╡рк╣рк╛рк░ ркЙркорлЗрк░рк╛ркИ ркЧркпрлЛ!");
        });

        // Bulk Logic
        function addBulkRow() {
            const id = generateId();
            const tr = document.createElement('tr');
            tr.id = `row-${id}`;
            tr.innerHTML = `
                <td class="p-2"><select class="form-input text-sm p-2 item-sel" onchange="calcBulkRow('${id}')">${document.getElementById('s-item').innerHTML}</select></td>
                <td class="p-2"><input type="number" class="form-input text-sm p-2 qty-inp text-right" placeholder="0" oninput="calcBulkRow('${id}')"></td>
                <td class="p-2"><input type="number" class="form-input text-sm p-2 rate-inp text-right" placeholder="0" oninput="calcBulkRow('${id}')"></td>
                <td class="p-2 text-right font-bold text-gray-700 total-cell">тВ╣ 0</td>
                <td class="p-2 text-center"><button type="button" onclick="this.closest('tr').remove(); calcBulkTotal();" class="text-red-400 hover:text-red-600">├Ч</button></td>
            `;
            document.getElementById('bulk-rows').appendChild(tr);
        }

        function calcBulkRow(id) {
            const row = document.getElementById(`row-${id}`);
            const q = parseFloat(row.querySelector('.qty-inp').value) || 0;
            const r = parseFloat(row.querySelector('.rate-inp').value) || 0;
            row.querySelector('.total-cell').innerText = formatCurrency(q*r);
            row.dataset.total = q*r;
            calcBulkTotal();
        }

        function calcBulkTotal() {
            let t = 0;
            document.querySelectorAll('#bulk-rows tr').forEach(r => t += parseFloat(r.dataset.total || 0));
            document.getElementById('b-grand-total').innerText = formatCurrency(t);
        }

        function saveBulk() {
            const date = document.getElementById('b-date').value;
            const party = document.getElementById('b-party').value;
            const type = document.getElementById('b-type').value;
            const billId = generateId();
            
            if(!date || !party) return alert("ркдрк╛рк░рлАркЦ ркЕркирлЗ ркирк╛рко ркЬрк░рлВрк░рлА ркЫрлЗ.");
            
            let count = 0;
            document.querySelectorAll('#bulk-rows tr').forEach(r => {
                const item = r.querySelector('.item-sel').value;
                const q = parseFloat(r.querySelector('.qty-inp').value);
                const rate = parseFloat(r.querySelector('.rate-inp').value);
                if(item && q && rate) {
                    transactions.push({
                        id: generateId(), billId, date, party, type, item, qty: q, rate, amount: q*rate
                    });
                    count++;
                }
            });
            
            if(count === 0) return alert("ркХрлЛркИ рк╡рк╕рлНркдрлБ ркЙркорлЗрк░рлА ркиркерлА.");
            saveData();
            resetForm('bulk');
            alert("ркмрк┐рк▓ рк╕рлЗрк╡ ркеркИ ркЧркпрлБркВ!");
        }

        function resetForm(type) {
            if(type === 'single') {
                document.getElementById('single-form').reset();
                document.getElementById('s-date').valueAsDate = new Date();
                document.getElementById('s-total-display').innerText = 'тВ╣ 0';
            } else {
                document.getElementById('bulk-rows').innerHTML = '';
                document.getElementById('b-party').value = '';
                addBulkRow();
                calcBulkTotal();
            }
        }

        // --- Details Modal ---
        function openBillModal(billId) {
            const items = transactions.filter(t => t.billId === billId);
            if(items.length === 0) return;
            
            document.getElementById('m-party').innerText = items[0].party || items[0].sourceDest;
            document.getElementById('m-date').innerText = items[0].date;
            document.getElementById('m-badge').innerText = items[0].type.toUpperCase();
            document.getElementById('m-badge').className = `px-2 py-0.5 rounded text-[10px] font-bold ${items[0].type === 'income' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`;
            
            const tbody = document.getElementById('m-body');
            tbody.innerHTML = '';
            let total = 0;
            items.forEach(i => {
                total += i.amount;
                tbody.innerHTML += `<tr><td class="py-2 text-gray-700">${i.item}</td><td class="py-2 text-right text-gray-500">${i.qty}</td><td class="py-2 text-right text-gray-500">${i.rate}</td><td class="py-2 text-right font-bold text-indigo-600">${formatCurrency(i.amount)}</td></tr>`;
            });
            document.getElementById('m-total').innerText = formatCurrency(total);
            document.getElementById('m-delete-btn').onclick = () => deleteBill(billId);
            document.getElementById('modal-bill').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal-bill').classList.add('hidden'); }
        
        // --- Delete Logic ---
        function deleteTx(id) {
            if(confirm('Are you sure?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData(); renderTransactionsList();
            }
        }
        function deleteBill(id) {
            if(confirm('Delete entire bill?')) {
                transactions = transactions.filter(t => t.billId !== id);
                saveData(); closeModal(); renderTransactionsList();
            }
        }

        // --- File Ops ---
        function exportData() {
            const b = new Blob([JSON.stringify(transactions)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'navjivan_pro_backup.json'; a.click();
        }
        
        function importData(input) {
            const f = input.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // Simple merge/overwrite logic for this version
                    transactions = importedData; 
                    
                    // Re-process to ensure correct types (important for legacy data)
                    transactions = transactions.map(t => ({...t, amount: parseFloat(t.amount || 0), qty: parseInt(t.qty || t.quantity || 0) })); 
                    
                    isPreview = true;
                    document.getElementById('preview-badge').classList.remove('hidden');
                    saveData(); // Save the imported data immediately
                    alert("ркбрлЗркЯрк╛ рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркЕрккрк▓рлЛркб ркеркИ ркЧркпрлЛ ркЫрлЗ ркЕркирлЗ рк╣рк╡рлЗ ркЧрлНрк░рк╛рклркорк╛ркВ ркЬрлВркирлА ркдрк╛рк░рлАркЦрлЛ рккркг ркжрлЗркЦрк╛рк╢рлЗ. ркЖ ркбрлЗркЯрк╛ рк▓рлЛркХрк▓ рк╕рлНркЯрлЛрк░рлЗркЬркорк╛ркВ рк╕рлЗрк╡ ркеркИ ркЧркпрлЛ ркЫрлЗ.");
                } catch (error) {
                    console.error("Error parsing imported data:", error);
                    alert("ркбрлЗркЯрк╛ ркЕрккрк▓рлЛркб ркХрк░рк╡рк╛ркорк╛ркВ ркнрлВрк▓ ркеркИ. рклрк╛ркЗрк▓ рклрлЛрк░рлНркорлЗркЯ ркЪрлЗркХ ркХрк░рлЛ.");
                }
            };
            r.readAsText(f);
            input.value = ''; // Reset file input
        }

        function resetData() {
            if(confirm("ркмркзрлЛ ркбрлЗркЯрк╛ ркбрк┐рк▓рлАркЯ ркХрк░рк╡рлЛ ркЫрлЗ? ркЖ ркХрлНрк░рк┐ркпрк╛ рккрк╛ркЫрлА ркирк╣рлАркВ ркЖрк╡рлЗ.")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
    </script>
</body>
</html>
