
<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ркирк╡ркЬрлАрк╡рки рккрк╢рлБркЖрк╣рк╛рк░ - рк╣рк┐рк╕рк╛ркм</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ркХрк╕рлНркЯрко CSS */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            width: 100%;
        }
        /* ркХрк╕рлНркЯрко рк╕рлНркХрлНрк░рлЛрк▓ркмрк╛рк░ */
        .transaction-table-body::-webkit-scrollbar {
            width: 8px;
        }
        .transaction-table-body::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        /* ркорлЛркЯрк╛ ркЗркирккрлБркЯ ркорк╛ркЯрлЗ рк╕рлНркЯрк╛ркЗрк▓ */
        .large-input {
            padding: 0.75rem; 
            border-color: #9ca3af; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        /* рк░рк┐рк╕рлНрккрлЛркирлНрк╕рк┐рк╡ ркЯрлЗркмрк▓ рклрк┐ркХрлНрк╕ */
        @media (min-width: 768px) {
            .table-container {
                display: table;
                table-layout: fixed;
                width: 100%;
            }
            .table-container thead, .table-container tbody {
                display: table-row-group;
            }
            .transaction-table-body {
                display: table-row-group;
                max-height: none;
                overflow-y: visible;
            }
        }
        /* ркЯрлНрк░рк╛ркирлНркЭрлЗркХрлНрк╢рки ркмрлЛркбрлА ркорк╛ркЯрлЗ ркорк╣ркдрлНркдрко ркКркВркЪрк╛ркИ ркорлЛркмрк╛ркЗрк▓ рккрк░ */
        .transaction-table-body {
            max-height: 400px;
            overflow-y: auto;
            display: block; /* ркорлЛркмрк╛ркИрк▓ ркорк╛ркЯрлЗ */
        }
        /* ркорлЛркмрк╛ркИрк▓ ркорк╛ркЯрлЗ рк╣рлЗркбрк░ ркЕркирлЗ рк░рлЛ рклрк┐ркХрлНрк╕ */
        thead tr, tbody tr {
             display: table;
             width: 100%;
             table-layout: fixed;
        }
    </style>
</head>
<body>
    <div class="container bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <header class="mb-8 border-b-4 border-emerald-500 pb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center">
                ркирк╡ркЬрлАрк╡рки рккрк╢рлБркЖрк╣рк╛рк░ (Kh─Бt─Б P┼Нth─л)
            </h1>
            <p class="text-center text-sm text-gray-600 mt-1">ркСрклрк▓рк╛ркЗрки ркЖрк╡ркХ ркЕркирлЗ ркЦрк░рлНркЪркирлЛ рк╣рк┐рк╕рк╛ркм (Offline Income & Expense Tracker)</p>
            <p class="text-center text-xs mt-3 p-1 bg-gray-100 rounded-lg text-red-500 font-semibold">
                ркирлЛркВркз: ркбрлЗркЯрк╛ рк╢рлЗрк░ ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ ркирлАркЪрлЗ ркЖрккрлЗрк▓ "ркбрлЗркЯрк╛ ркмрлЗркХркЕркк" рк╡рк┐ркХрк▓рлНрккркирлЛ ркЙрккркпрлЛркЧ ркХрк░рлЛ.
            </p>
        </header>

        <!-- ркбрлЗркЯрк╛ ркмрлЗркХркЕркк ркЕркирлЗ рк░рк┐рк╕рлНркЯрлЛрк░ (NEW SECTION for Permanent Save/Share) -->
        <section class="mb-8 p-6 bg-indigo-50 rounded-xl border border-indigo-200 shadow-md">
            <h2 class="text-lg font-bold mb-3 text-indigo-900 flex items-center">
                <span class="text-xl mr-2">ЁЯТ╛</span> ркбрлЗркЯрк╛ ркорлЗркирлЗркЬркорлЗркирлНркЯ (Share & Save Data)
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                ркЖ рклрк╛ркИрк▓ ркмрлАркЬрк╛ркирлЗ ркорлЛркХрк▓рк╡рк╛ ркорк╛ркЯрлЗ рккрк╣рлЗрк▓рк╛ <b>"ркбрлЗркЯрк╛ ркбрк╛ркЙркирк▓рлЛркб"</b> ркХрк░рлЛ. ркЬрлЛ ркмрлАркЬрк╛ркП ркорлЛркХрк▓рлЗрк▓рлА рклрк╛ркИрк▓ ркдркорк╛рк░рлЗ ркЬрлЛрк╡рлА рк╣рлЛркп ркдрлЛ <b>"ркбрлЗркЯрк╛ ркЕрккрк▓рлЛркб"</b> ркХрк░рлЛ.
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- ркмрлЗркХркЕркк ркмркЯрки -->
                <div>
                    <button onclick="exportData()" class="w-full flex justify-center items-center px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        ркбрлЗркЯрк╛ ркбрк╛ркЙркирк▓рлЛркб ркХрк░рлЛ (Backup)
                    </button>
                    <p class="text-xs text-gray-500 mt-1 text-center">ркЖ рклрк╛ркИрк▓ рк╕рк╛ркЪрк╡рлА рк░рк╛ркЦрлЛ ркЕркерк╡рк╛ рк╢рлЗрк░ ркХрк░рлЛ.</p>
                </div>

                <!-- рк░рк┐рк╕рлНркЯрлЛрк░ ркмркЯрки -->
                <div>
                    <label for="file-upload" class="w-full flex justify-center items-center px-4 py-3 bg-white border-2 border-indigo-300 border-dashed hover:border-indigo-500 text-indigo-700 font-semibold rounded-lg shadow-sm cursor-pointer transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        ркбрлЗркЯрк╛ ркЕрккрк▓рлЛркб ркХрк░рлЛ (Restore)
                    </label>
                    <input id="file-upload" type="file" accept=".json" class="hidden" onchange="importData(this)">
                    <p class="text-xs text-gray-500 mt-1 text-center">ркЬрлВркирлЛ ркбрлЗркЯрк╛ ркЖркирк╛ркерлА ркмркжрк▓рк╛ркИ ркЬрк╢рлЗ.</p>
                </div>
            </div>
        </section>

        <!-- рклрк┐рк▓рлНркЯрк░ ркХркВркЯрлНрк░рлЛрк▓рлНрк╕ -->
        <section class="mb-8 p-4 bg-yellow-50 rounded-xl border border-yellow-200 shadow-md">
            <h2 class="text-lg font-semibold mb-3 text-yellow-800">рк╣рк┐рк╕рк╛ркм рклрк┐рк▓рлНркЯрк░ ркХрк░рлЛ (Filter Account)</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                 <!-- рклрк┐рк▓рлНркЯрк░ рккрлНрк░ркХрк╛рк░ -->
                <div>
                    <label for="filter-type" class="block text-sm font-medium text-gray-700 mb-1">рклрк┐рк▓рлНркЯрк░ рккрлНрк░ркХрк╛рк░ (Filter Type)</label>
                    <select id="filter-type" class="w-full large-input border rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-white">
                        <option value="all">ркмркзрк╛ рк╡рлНркпрк╡рк╣рк╛рк░рлЛ (All Transactions)</option>
                        <option value="monthly">ркорк╛рк╕рк┐ркХ рк╣рк┐рк╕рк╛ркм (Monthly Account)</option>
                        <option value="yearly">рк╡рк╛рк░рлНрк╖рк┐ркХ рк╣рк┐рк╕рк╛ркм (Yearly Account)</option>
                    </select>
                </div>
                
                <!-- рклрк┐рк▓рлНркЯрк░ ркдрк╛рк░рлАркЦ ркЗркирккрлБркЯ -->
                <div class="sm:col-span-2">
                    <label for="filter-date" class="block text-sm font-medium text-gray-700 mb-1" id="filter-date-label">ркдрк╛рк░рлАркЦ рккрк╕ркВркж ркХрк░рлЛ (Select Date)</label>
                    <input type="month" id="filter-date" class="w-full large-input border rounded-lg focus:ring-yellow-500 focus:border-yellow-500" disabled>
                </div>
            </div>
        </section>

        <!-- рк╕рк╛рк░рк╛ркВрк╢ рк╡рк┐ркнрк╛ркЧ (Summary Section) -->
        <section id="summary" class="mb-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
            <!-- ркХрлБрк▓ ркЖрк╡ркХ -->
            <div class="bg-emerald-100 p-4 rounded-lg shadow-md text-center">
                <p class="text-sm font-semibold text-emerald-700">ркХрлБрк▓ ркЖрк╡ркХ (Total Income)</p>
                <p id="total-income" class="text-2xl font-bold text-emerald-600 mt-1">тВ╣ 0.00</p>
            </div>
            <!-- ркХрлБрк▓ ркЦрк░рлНркЪ -->
            <div class="bg-red-100 p-4 rounded-lg shadow-md text-center">
                <p class="text-sm font-semibold text-red-700">ркХрлБрк▓ ркЦрк░рлНркЪ (Total Expense)</p>
                <p id="total-expense" class="text-2xl font-bold text-red-600 mt-1">тВ╣ 0.00</p>
            </div>
            <!-- ркЪрлЛркЦрлНркЦрлБркВ ркмрлЗрк▓рлЗркирлНрк╕ -->
            <div class="bg-blue-100 p-4 rounded-lg shadow-md text-center">
                <p class="text-sm font-semibold text-blue-700">ркЪрлЛркЦрлНркЦрлБркВ ркмрлЗрк▓рлЗркирлНрк╕ (Net Balance)</p>
                <p id="net-balance" class="text-2xl font-bold text-blue-600 mt-1">тВ╣ 0.00</p>
            </div>
        </section>
        
        <!-- ркорк╛рк╕рк┐ркХ рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг рк╡рк┐ркнрк╛ркЧ -->
        <section class="mb-8 p-6 bg-blue-50 rounded-xl border border-blue-200 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-blue-800 border-b pb-2">ркорк╛рк╕рк┐ркХ рккрлНрк░ркжрк░рлНрк╢рки рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг (Monthly Performance Analysis)</h2>
            <div id="monthly-analysis-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- ркЖрк╡ркХ рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг -->
                <div class="bg-white p-4 rounded-lg shadow-md border border-emerald-300">
                    <h3 class="text-lg font-bold text-emerald-700 mb-2">ркЖрк╡ркХ рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг (Income Analysis)</h3>
                    <p class="text-sm mb-1 text-gray-700">рк╕рлМркерлА рк╡ркзрлБ ркЖрк╡ркХ: <span id="max-income-month" class="font-semibold text-emerald-600">N/A</span> (<span id="max-income-amount" class="font-bold text-emerald-600">тВ╣ 0.00</span>)</p>
                    <p class="text-sm text-gray-700">рк╕рлМркерлА ркУркЫрлА ркЖрк╡ркХ: <span id="min-income-month" class="font-semibold text-red-600">N/A</span> (<span id="min-income-amount" class="font-bold text-red-600">тВ╣ 0.00</span>)</p>
                </div>
                <!-- ркЦрк░рлНркЪ рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг -->
                <div class="bg-white p-4 rounded-lg shadow-md border border-red-300">
                    <h3 class="text-lg font-bold text-red-700 mb-2">ркЦрк░рлНркЪ рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг (Expense Analysis)</h3>
                    <p class="text-sm mb-1 text-gray-700">рк╕рлМркерлА рк╡ркзрлБ ркЦрк░рлНркЪ: <span id="max-expense-month" class="font-semibold text-red-600">N/A</span> (<span id="max-expense-amount" class="font-bold text-red-600">тВ╣ 0.00</span>)</p>
                    <p class="text-sm text-gray-700">рк╕рлМркерлА ркУркЫрлЛ ркЦрк░рлНркЪ: <span id="min-expense-month" class="font-semibold text-emerald-600">N/A</span> (<span id="min-expense-amount" class="font-bold text-emerald-600">тВ╣ 0.00</span>)</p>
                </div>
            </div>
        </section>

        <!-- рк╡рк╕рлНркдрлБ ркорлБркЬркм рк╕рк╛рк░рк╛ркВрк╢ (Item Summary) - NEW SECTION -->
        <section class="mb-10 p-6 bg-purple-50 rounded-xl border border-purple-200 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-purple-800 border-b pb-2">рк╡рк╕рлНркдрлБ ркорлБркЬркм рк╕рк╛рк░рк╛ркВрк╢ (Item-wise Stock Summary)</h2>
            <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200 bg-white">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-purple-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-purple-900 uppercase tracking-wider">рк╡рк╕рлНркдрлБркирлБркВ ркирк╛рко</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-emerald-700 uppercase tracking-wider">ркХрлБрк▓ ркЖрк╡ркХ ркЬркерлНркерлЛ (Income Qty)</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-red-700 uppercase tracking-wider">ркХрлБрк▓ ркЦрк░рлНркЪ ркЬркерлНркерлЛ (Expense Qty)</th>
                        </tr>
                    </thead>
                    <tbody id="item-summary-body" class="divide-y divide-gray-100">
                        <!-- JavaScript ркерлА ркбрлЗркЯрк╛ ркЕрк╣рлАркВ ркЖрк╡рк╢рлЗ -->
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">ркорк╛рк╣рк┐ркдрлА ркиркерлА</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- рк╡рлНркпрк╡рк╣рк╛рк░ ркЙркорлЗрк░рлЛ/ркПркбрк┐ркЯ ркХрк░рлЛ рклрлЛрк░рлНрко -->
        <section class="mb-10 p-6 bg-gray-50 rounded-xl border border-gray-200 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-700" id="form-title">ркирк╡рлЛ рк╡рлНркпрк╡рк╣рк╛рк░ ркЙркорлЗрк░рлЛ (Add New Transaction)</h2>
            <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-8 gap-4 items-end">
                
                <!-- ркдрк╛рк░рлАркЦ -->
                <div class="md:col-span-1">
                    <label for="date" class="block text-sm font-medium text-gray-700 mb-1">ркдрк╛рк░рлАркЦ (Date)</label>
                    <input type="date" id="date" required autofocus
                           class="w-full large-input border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <!-- ркЖркЗркЯркоркирлЛ рккрлНрк░ркХрк╛рк░ (ркЦрлЛркиркирлЛ рккрлНрк░ркХрк╛рк░ - Dropdown) -->
                <div class="md:col-span-1">
                    <label for="item-type" class="block text-sm font-medium text-gray-700 mb-1">ркЦрлЛркиркирлЛ рккрлНрк░ркХрк╛рк░ (Item Type)</label>
                    <select id="item-type" required 
                            class="w-full large-input border rounded-lg focus:ring-emerald-500 focus:border-emerald-500 bg-white">
                        <option value="" disabled selected>рккрк╕ркВркж ркХрк░рлЛ</option>
                        <option value="ркоркХрк╛ркИ рккрк╛рккркбрлА">ркоркХрк╛ркИ рккрк╛рккркбрлА (Makai Papadi)</option>
                        <option value="ркоркХрк╛ркИ ркнрк░ркбрлЛ">ркоркХрк╛ркИ ркнрк░ркбрлЛ (Makai Bhardo)</option>
                        <option value="рккрк╛рккркбрлА">рккрк╛рккркбрлА (Papadi)</option>
                        <option value="ркЬрк╡ ркнрк░ркбрлЛ">ркЬрк╡ ркнрк░ркбрлЛ (Jav Bhardo)</option>
                        <option value="рк╕рлЛркпрк╛ркмрлАрки">рк╕рлЛркпрк╛ркмрлАрки (Soyabean)</option>
                        <option value="ркдрлБрк╡рлЗрк░ркЪрлБркирлА">ркдрлБрк╡рлЗрк░ркЪрлБркирлА (Tuverchuni)</option>
                        <option value="рккрк╢рлБ ркЖрк╣рк╛рк░">рккрк╢рлБ ркЖрк╣рк╛рк░ (Pashu Aahar)</option>
                        <option value="рк▓рк╛рк▓рлА">рк▓рк╛рк▓рлА (Lali)</option>
                        <option value="ркжрк╛ркг">ркжрк╛ркг (Daan)</option>
                        <option value="ркЕркирлНркп">ркЕркирлНркп (Other)</option>
                    </select>
                </div>
                
                <!-- ркЬркерлНркерлЛ (ркХрлЗркЯрк▓рлА ркмрлЛрк░рлА) -->
                <div class="md:col-span-1">
                    <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">ркмрлЛрк░рлА (Quantity)</label>
                    <input type="number" id="quantity" placeholder="рк╕ркВркЦрлНркпрк╛" required min="1" step="1" 
                           class="w-full large-input border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <!-- ркжрк░ (ркмрлЛрк░рлАркирлЛ ркнрк╛рк╡) -->
                <div class="md:col-span-1">
                    <label for="rate" class="block text-sm font-medium text-gray-700 mb-1">ркмрлЛрк░рлАркирлЛ ркнрк╛рк╡ (Rate)</label>
                    <input type="number" id="rate" placeholder="ркнрк╛рк╡/Rate" required min="0.01" step="0.01" 
                           class="w-full large-input border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                 
                 <!-- ркХрлБрк▓ рк░ркХрко (Calculated) -->
                <div class="md:col-span-1">
                    <label for="total-amount-display" class="block text-sm font-medium text-gray-700 mb-1">ркХрлБрк▓ рк░ркХрко (Total)</label>
                    <input type="text" id="total-amount-display" value="тВ╣ 0.00" readonly 
                           class="w-full large-input border rounded-lg bg-gray-200 font-bold text-gray-700">
                    <input type="hidden" id="amount-hidden" name="amount">
                </div>
                
                <!-- рк╕рлНркдрлНрк░рлЛркд/ркЧркВркдрк╡рлНркп (Source/Destination) -->
                <div class="md:col-span-1" id="source-destination-group">
                    <label for="source-destination" class="block text-sm font-medium text-gray-700 mb-1">ркХрлНркпрк╛ркВркерлА/ркХрлЛркирлЗ? (S/D)</label>
                    <input type="text" id="source-destination" placeholder="рк╡рлЗрккрк╛рк░рлАркирлБркВ ркирк╛рко" required 
                           class="w-full large-input border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <!-- рк╡рлНркпрк╡рк╣рк╛рк░ рккрлНрк░ркХрк╛рк░ -->
                <div class="md:col-span-1">
                    <label for="type" class="block text-sm font-medium text-gray-700 mb-1">рк╡рлНркпрк╡рк╣рк╛рк░ рккрлНрк░ркХрк╛рк░ (Type)</label>
                    <select id="type" required 
                            class="w-full large-input border rounded-lg focus:ring-emerald-500 focus:border-emerald-500 bg-white">
                        <option value="income">ркЖрк╡ркХ (Income)</option>
                        <option value="expense">ркЦрк░рлНркЪ (Expense)</option>
                    </select>
                </div>
                
                <!-- рк╕ркмркорк┐ркЯ ркмркЯрки -->
                <div class="md:col-span-1">
                    <button type="submit" id="submit-button"
                            class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-4 rounded-xl 
                                   transition duration-150 ease-in-out shadow-lg hover:shadow-xl transform hover:scale-105">
                        ркЙркорлЗрк░рлЛ (Add)
                    </button>
                    <button type="button" id="cancel-edit-button"
                            class="w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-4 rounded-xl 
                                   transition duration-150 ease-in-out shadow-lg transform hover:scale-105 mt-2 hidden">
                        рк░ркжрлНркж ркХрк░рлЛ (Cancel)
                    </button>
                </div>
            </form>
            <p id="error-message" class="text-red-500 text-sm mt-3 hidden"></p>
            <p id="success-message" class="text-emerald-500 text-sm mt-3 hidden"></p>
        </section>

        <!-- ркЯрлНрк░рк╛ркирлНркЭрлЗркХрлНрк╢рки ркпрк╛ркжрлАркУ -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- ркЖрк╡ркХ ркпрк╛ркжрлА рк╡рк┐ркнрк╛ркЧ -->
            <div id="income-section">
                <h2 class="text-xl font-semibold mb-4 text-emerald-700 border-b pb-2">ркЖрк╡ркХркирлА ркпрк╛ркжрлА (Income List)</h2>
                <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-200 table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-emerald-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">ркдрк╛рк░рлАркЦ</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">рк╡рк┐ркЧркд</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">ркХрлБрк▓ рк░ркХрко</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">ркХрк╛рк░рлНркпрк╡рк╛рк╣рлА</th>
                            </tr>
                        </thead>
                        <tbody id="income-list-body" class="bg-white divide-y divide-gray-100 transaction-table-body">
                            <tr class="loading-row-income"><td colspan="4" class="py-4 text-center text-gray-500">рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="no-income" class="text-center text-gray-500 mt-4 hidden">ркХрлЛркИ ркЖрк╡ркХ рк╡рлНркпрк╡рк╣рк╛рк░ ркорк│рлНркпрлЛ ркиркерлА.</p>
            </div>

            <!-- ркЦрк░рлНркЪ ркпрк╛ркжрлА рк╡рк┐ркнрк╛ркЧ -->
            <div id="expense-section">
                <h2 class="text-xl font-semibold mb-4 text-red-700 border-b pb-2">ркЦрк░рлНркЪркирлА ркпрк╛ркжрлА (Expense List)</h2>
                 <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-200 table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-red-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">ркдрк╛рк░рлАркЦ</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">рк╡рк┐ркЧркд</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">ркХрлБрк▓ рк░ркХрко</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">ркХрк╛рк░рлНркпрк╡рк╛рк╣рлА</th>
                            </tr>
                        </thead>
                        <tbody id="expense-list-body" class="bg-white divide-y divide-gray-100 transaction-table-body">
                             <tr class="loading-row-expense"><td colspan="4" class="py-4 text-center text-gray-500">рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="no-expense" class="text-center text-gray-500 mt-4 hidden">ркХрлЛркИ ркЦрк░рлНркЪ рк╡рлНркпрк╡рк╣рк╛рк░ ркорк│рлНркпрлЛ ркиркерлА.</p>
            </div>
        </section>
    </div>

    <!-- JavaScript Logic (LocalStorage Based) -->
    <script>
        // --- ркХрлЛркирлНрк╕рлНркЯркирлНркЯрлНрк╕ ---
        const STORAGE_KEY = 'khataPothiTransactions';
        const GUJARATI_MONTHS = ["ркЬрк╛ркирлНркпрлБркЖрк░рлА", "рклрлЗркмрлНрк░рлБркЖрк░рлА", "ркорк╛рк░рлНркЪ", "ркПрккрлНрк░рк┐рк▓", "ркорлЗ", "ркЬрлВрки", "ркЬрлБрк▓рк╛ркИ", "ркУркЧрк╕рлНркЯ", "рк╕рккрлНркЯрлЗркорлНркмрк░", "ркУркХрлНркЯрлЛркмрк░", "ркирк╡рлЗркорлНркмрк░", "ркбрк┐рк╕рлЗркорлНркмрк░"];

        let allTransactionsData = []; // ркмркзрк╛ ркбрлЗркЯрк╛ рк╕рлНркЯрлЛрк░ ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ
        let editingTransactionId = null; 

        // --- HTML ркПрк▓рк┐ркорлЗркирлНркЯрлНрк╕ ---
        const form = document.getElementById('transaction-form');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const netBalanceEl = document.getElementById('net-balance');
        const errorMessageEl = document.getElementById('error-message');
        const successMessageEl = document.getElementById('success-message');

        const dateInput = document.getElementById('date');
        const itemTypeInput = document.getElementById('item-type');
        const quantityInput = document.getElementById('quantity');
        const rateInput = document.getElementById('rate');
        const totalAmountDisplay = document.getElementById('total-amount-display');
        const amountHiddenInput = document.getElementById('amount-hidden');
        const typeInput = document.getElementById('type');
        const sourceDestinationInput = document.getElementById('source-destination');
        const sourceDestinationGroup = document.getElementById('source-destination-group');
        
        const submitButton = document.getElementById('submit-button');
        const cancelButton = document.getElementById('cancel-edit-button');
        const formTitle = document.getElementById('form-title');

        const incomeListBody = document.getElementById('income-list-body');
        const expenseListBody = document.getElementById('expense-list-body');
        const noIncomeEl = document.getElementById('no-income');
        const noExpenseEl = document.getElementById('no-expense');
        
        const filterTypeInput = document.getElementById('filter-type');
        const filterDateInput = document.getElementById('filter-date');
        const filterDateLabel = document.getElementById('filter-date-label');
        
        // рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг ркПрк▓рк┐ркорлЗркирлНркЯрлНрк╕
        const maxIncomeMonthEl = document.getElementById('max-income-month');
        const maxIncomeAmountEl = document.getElementById('max-income-amount');
        const minIncomeMonthEl = document.getElementById('min-income-month');
        const minIncomeAmountEl = document.getElementById('min-income-amount');
        const maxExpenseMonthEl = document.getElementById('max-expense-month');
        const maxExpenseAmountEl = document.getElementById('max-expense-amount');
        const minExpenseMonthEl = document.getElementById('min-expense-month');
        const minExpenseAmountEl = document.getElementById('min-expense-amount');
        
        const itemSummaryBody = document.getElementById('item-summary-body');

        // --- ркпрлБркЯрк┐рк▓рк┐ркЯрлА рклркВркХрлНрк╢ркирлНрк╕ ---

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function showStatus(message, type = 'success') {
            errorMessageEl.classList.add('hidden');
            successMessageEl.classList.add('hidden');
            
            const targetEl = type === 'error' ? errorMessageEl : successMessageEl;
            targetEl.textContent = message;
            targetEl.classList.remove('hidden');

            setTimeout(() => {
                targetEl.classList.add('hidden');
            }, 3000);
        }

        function toggleSourceDestinationVisibility() {
            const isExpense = typeInput.value === 'expense';
            
            if (isExpense) {
                sourceDestinationGroup.classList.remove('hidden');
                sourceDestinationInput.required = true;
                sourceDestinationInput.placeholder = "ркХрлЛркирлЗ ркЪрлВркХрк╡рлНркпрк╛?";
            } else {
                sourceDestinationGroup.classList.add('hidden');
                sourceDestinationInput.required = false;
                // ркЖрк╡ркХ ркорк╛ркЯрлЗ рк░рлАрк╕рлЗркЯ
                if (editingTransactionId === null) { 
                    sourceDestinationInput.value = ''; 
                }
            }
        }

        function updateFilterDateInput() {
            const filterType = filterTypeInput.value;
            
            filterDateInput.disabled = false;
            
            if (filterType === 'all') {
                filterDateInput.disabled = true;
                filterDateInput.type = 'month'; 
                filterDateInput.value = ''; 
                filterDateLabel.textContent = 'ркдрк╛рк░рлАркЦ рккрк╕ркВркж ркХрк░рлЛ (Select Date)';
            } else if (filterType === 'monthly') {
                filterDateInput.type = 'month';
                if (!filterDateInput.value) {
                    filterDateInput.value = new Date().toISOString().substring(0, 7); 
                }
                filterDateLabel.textContent = 'ркорк╣рк┐ркирлЛ рккрк╕ркВркж ркХрк░рлЛ (Select Month)';
            } else if (filterType === 'yearly') {
                filterDateInput.type = 'number'; // рк╡рк░рлНрк╖ ркорк╛ркЯрлЗ ркиркВркмрк░
                filterDateInput.min = 2000;
                filterDateInput.max = 2099;
                if (!filterDateInput.value) {
                    filterDateInput.value = new Date().getFullYear();
                }
                filterDateLabel.textContent = 'рк╡рк░рлНрк╖ рккрк╕ркВркж ркХрк░рлЛ (Select Year)';
            }
            
            applyFiltersAndRender();
        }

        function resetFormState() {
            form.reset();
            dateInput.value = new Date().toISOString().substring(0, 10);
            calculateTotalAmount();
            editingTransactionId = null;
            
            submitButton.textContent = 'ркЙркорлЗрк░рлЛ (Add)';
            submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            submitButton.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
            cancelButton.classList.add('hidden');
            formTitle.textContent = 'ркирк╡рлЛ рк╡рлНркпрк╡рк╣рк╛рк░ ркЙркорлЗрк░рлЛ (Add New Transaction)';

            toggleSourceDestinationVisibility();
            dateInput.focus();
        }

        function formatCurrency(amount) {
            const numAmount = typeof amount === 'number' ? amount : parseFloat(amount);
            if (isNaN(numAmount)) return 'тВ╣ 0.00';
            
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2
            }).format(numAmount);
        }
        
        function formatMonthYear(ymString) {
            if (!ymString || ymString.length !== 7 || ymString.indexOf('-') !== 4) return ymString;
            const [year, monthIndexStr] = ymString.split('-');
            const monthIndex = parseInt(monthIndexStr, 10) - 1; 
            
            if (monthIndex >= 0 && monthIndex < 12) {
                return `${GUJARATI_MONTHS[monthIndex]} ${year}`;
            }
            return ymString;
        }

        function calculateTotalAmount() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const rate = parseFloat(rateInput.value) || 0;
            
            const totalAmount = (quantity * rate).toFixed(2); 

            totalAmountDisplay.value = formatCurrency(totalAmount);
            amountHiddenInput.value = totalAmount;
        }

        // --- ркбрлЗркЯрк╛ рк▓рлЛркЬрлАркХ ---

        function loadTransactions() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                allTransactionsData = data ? JSON.parse(data) : [];
                allTransactionsData = allTransactionsData.map(t => ({
                    ...t,
                    amount: parseFloat(t.amount),
                    quantity: parseInt(t.quantity) || 0
                }));
                console.log("Transactions loaded:", allTransactionsData.length);
            } catch (error) {
                console.error("Error loading transactions:", error);
                showStatus("ркбрлЗркЯрк╛ рк▓рлЛркб ркХрк░рк╡рк╛ркорк╛ркВ ркнрлВрк▓ ркЖрк╡рлА.", 'error');
                allTransactionsData = [];
            }
            applyFiltersAndRender();
        }

        function saveTransactions() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allTransactionsData));
            } catch (error) {
                console.error("Error saving transactions:", error);
                showStatus("ркбрлЗркЯрк╛ рк╕рлЗрк╡ ркХрк░рк╡рк╛ркорк╛ркВ ркнрлВрк▓ ркЖрк╡рлА.", 'error');
            }
        }

        // --- ркмрлЗркХркЕркк ркЕркирлЗ рк░рк┐рк╕рлНркЯрлЛрк░ (Backup & Restore Functions) ---

        function exportData() {
            if (allTransactionsData.length === 0) {
                showStatus("ркХрлЛркИ ркбрлЗркЯрк╛ ркЙрккрк▓ркмрлНркз ркиркерлА ркмрлЗркХркЕркк рк▓рлЗрк╡рк╛ ркорк╛ркЯрлЗ.", 'error');
                return;
            }

            const dataStr = JSON.stringify(allTransactionsData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const now = new Date();
            const dateStr = `${now.getDate()}-${now.getMonth()+1}-${now.getFullYear()}`;
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `Navjivan_Backup_${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus("ркмрлЗркХркЕркк рклрк╛ркИрк▓ ркбрк╛ркЙркирк▓рлЛркб ркеркИ ркЧркИ ркЫрлЗ.");
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const parsedData = JSON.parse(content);
                    
                    if (Array.isArray(parsedData)) {
                        if (confirm(`ркЖ рклрк╛ркИрк▓ркорк╛ркВ ${parsedData.length} ркПркирлНркЯрлНрк░рлА ркЫрлЗ. рк╢рлБркВ ркдркорлЗ рк╣рк╛рк▓ркирлЛ ркбрлЗркЯрк╛ ркмркжрк▓рлАркирлЗ ркЖ ркирк╡рлЛ ркбрлЗркЯрк╛ рк▓рк╛рк╡рк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?`)) {
                            allTransactionsData = parsedData;
                            saveTransactions();
                            applyFiltersAndRender();
                            showStatus("ркбрлЗркЯрк╛ рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ рк░рк┐рк╕рлНркЯрлЛрк░ ркеркпрлЛ!");
                        }
                    } else {
                        showStatus("рклрк╛ркИрк▓ рклрлЛрк░рлНркорлЗркЯ ркЕркпрлЛркЧрлНркп ркЫрлЗ.", 'error');
                    }
                } catch (error) {
                    console.error("Error parsing JSON:", error);
                    showStatus("рклрк╛ркИрк▓ рк╡рк╛ркВркЪрк╡рк╛ркорк╛ркВ ркнрлВрк▓ ркЖрк╡рлА.", 'error');
                }
                // Reset input so same file can be selected again if needed
                input.value = '';
            };
            reader.readAsText(file);
        }

        // --- рклрлЛрк░рлНрко рк╣рлЗркирлНркбрк▓рк┐ркВркЧ ---

        function handleFormSubmit(e) {
            e.preventDefault();
            errorMessageEl.classList.add('hidden');
            successMessageEl.classList.add('hidden');

            calculateTotalAmount(); 

            const date = dateInput.value;
            const itemType = itemTypeInput.value ? itemTypeInput.value.trim() : '';
            const quantity = parseInt(quantityInput.value);
            const rate = parseFloat(rateInput.value);
            const totalAmount = parseFloat(amountHiddenInput.value);
            const type = typeInput.value;
            
            let sourceDestination = '';
            if (type === 'expense') {
                sourceDestination = sourceDestinationInput.value ? sourceDestinationInput.value.trim() : '';
                if (!sourceDestination) {
                    showStatus("ркЦрк░рлНркЪ ркорк╛ркЯрлЗ 'ркХрлНркпрк╛ркВркерлА/ркХрлЛркирлЗ?' ркнрк░рк╡рлБркВ рклрк░ркЬрк┐ркпрк╛ркд ркЫрлЗ.", 'error');
                    return;
                }
            } else {
                sourceDestination = ''; 
            }
            
            if (!date || !itemType || isNaN(quantity) || quantity <= 0 || isNaN(rate) || rate < 0 || isNaN(totalAmount)) {
                showStatus("ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркмркзрлА рк╡рк┐ркЧркдрлЛ ркпрлЛркЧрлНркп рк░рлАркдрлЗ ркнрк░рлЛ.", 'error');
                return;
            }

            const transactionData = {
                date: date,
                itemType: itemType,
                quantity: quantity,
                rate: rate,
                amount: totalAmount,
                type: type,
                sourceDestination: sourceDestination,
            };

            if (editingTransactionId) {
                const index = allTransactionsData.findIndex(t => t.id === editingTransactionId);
                if (index !== -1) {
                    allTransactionsData[index] = { ...allTransactionsData[index], ...transactionData };
                    showStatus("рк╡рлНркпрк╡рк╣рк╛рк░ ркЕрккркбрлЗркЯ ркеркпрлЛ.");
                }
            } else {
                transactionData.id = generateId();
                transactionData.timestamp = Date.now();
                allTransactionsData.push(transactionData);
                showStatus("ркирк╡рлЛ рк╡рлНркпрк╡рк╣рк╛рк░ ркЙркорлЗрк░рк╛ркпрлЛ.");
            }
            
            saveTransactions();
            resetFormState();
            applyFiltersAndRender();
        }

        function editTransactionHandler(id) {
            const transaction = allTransactionsData.find(t => t.id === id);
            if (!transaction) return;

            editingTransactionId = transaction.id;

            dateInput.value = transaction.date;
            itemTypeInput.value = transaction.itemType;
            quantityInput.value = transaction.quantity;
            rateInput.value = transaction.rate;
            typeInput.value = transaction.type;
            
            toggleSourceDestinationVisibility(); // рккрлНрк░ркХрк╛рк░ ркмркжрк▓рк╛ркпрлЛ рк╣рлЛркИ рк╢ркХрлЗ
            sourceDestinationInput.value = transaction.sourceDestination || ''; 
            
            calculateTotalAmount(); 

            submitButton.textContent = 'ркЕрккркбрлЗркЯ ркХрк░рлЛ (Update)';
            submitButton.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
            submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            cancelButton.classList.remove('hidden');
            formTitle.textContent = `рк╡рлНркпрк╡рк╣рк╛рк░ ркПркбрк┐ркЯ ркХрк░рлЛ`;

            form.scrollIntoView({ behavior: 'smooth' });
            dateInput.focus();
        }

        function deleteTransactionHandler(id) {
            if (confirm("рк╢рлБркВ ркдркорлЗ ркЦрк░рлЗркЦрк░ ркЖ рк╡рлНркпрк╡рк╣рк╛рк░ ркХрк╛ркврлА ркирк╛ркЦрк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?")) {
                allTransactionsData = allTransactionsData.filter(t => t.id !== id);
                saveTransactions();
                applyFiltersAndRender();
                showStatus("рк╡рлНркпрк╡рк╣рк╛рк░ ркХрк╛ркврлА ркирк╛ркЦрк╡рк╛ркорк╛ркВ ркЖрк╡рлНркпрлЛ.");
                
                if (editingTransactionId === id) {
                    resetFormState();
                }
            }
        }

        // --- рк░рлЗркирлНркбрк░рлАркВркЧ ркЕркирлЗ ркПркирк╛рк▓рк┐рк╕рк┐рк╕ ---

        function updateSummary(transactions) {
            let totalIncome = 0;
            let totalExpense = 0;

            transactions.forEach(t => {
                const amount = t.amount;
                if (!isNaN(amount)) {
                    if (t.type === 'income') {
                        totalIncome += amount;
                    } else if (t.type === 'expense') {
                        totalExpense += amount;
                    }
                }
            });

            const netBalance = totalIncome - totalExpense;

            totalIncomeEl.textContent = formatCurrency(totalIncome);
            totalExpenseEl.textContent = formatCurrency(totalExpense);
            netBalanceEl.textContent = formatCurrency(netBalance);
            
            if (netBalance >= 0) {
                netBalanceEl.classList.remove('text-red-600');
                netBalanceEl.classList.add('text-blue-600');
            } else {
                netBalanceEl.classList.remove('text-blue-600');
                netBalanceEl.classList.add('text-red-600');
            }
        }

        function calculateMonthlyAnalysis(transactions) {
            if (transactions.length === 0) {
                [maxIncomeMonthEl, maxIncomeAmountEl, minIncomeMonthEl, minIncomeAmountEl, 
                 maxExpenseMonthEl, maxExpenseAmountEl, minExpenseMonthEl, minExpenseAmountEl].forEach(el => {
                     el.textContent = el.id.includes('amount') ? 'тВ╣ 0.00' : 'N/A';
                 });
                return;
            }

            const monthlyData = {};

            transactions.forEach(t => {
                const monthKey = t.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { income: 0, expense: 0 };
                }
                if (t.type === 'income') monthlyData[monthKey].income += t.amount;
                if (t.type === 'expense') monthlyData[monthKey].expense += t.amount;
            });

            const months = Object.keys(monthlyData);
            if (months.length === 0) return;

            let maxInc = -1, minInc = Infinity, maxIncMonth = 'N/A', minIncMonth = 'N/A';
            let maxExp = -1, minExp = Infinity, maxExpMonth = 'N/A', minExpMonth = 'N/A';

            months.forEach(m => {
                const d = monthlyData[m];
                if (d.income > maxInc) { maxInc = d.income; maxIncMonth = m; }
                if (d.income > 0 && d.income < minInc) { minInc = d.income; minIncMonth = m; }
                if (d.expense > maxExp) { maxExp = d.expense; maxExpMonth = m; }
                if (d.expense > 0 && d.expense < minExp) { minExp = d.expense; minExpMonth = m; }
            });

            if (minInc === Infinity) minInc = 0;
            if (minExp === Infinity) minExp = 0;

            maxIncomeMonthEl.textContent = formatMonthYear(maxIncMonth);
            maxIncomeAmountEl.textContent = formatCurrency(maxInc > -1 ? maxInc : 0);
            minIncomeMonthEl.textContent = formatMonthYear(minIncMonth);
            minIncomeAmountEl.textContent = formatCurrency(minInc);

            maxExpenseMonthEl.textContent = formatMonthYear(maxExpMonth);
            maxExpenseAmountEl.textContent = formatCurrency(maxExp > -1 ? maxExp : 0);
            minExpenseMonthEl.textContent = formatMonthYear(minExpMonth);
            minExpenseAmountEl.textContent = formatCurrency(minExp);
        }

        // --- ркирк╡рлА рклркВркХрлНрк╢рки: рк╡рк╕рлНркдрлБ ркорлБркЬркм рк╕рк╛рк░рк╛ркВрк╢ (Item Summary) ---
        function updateItemSummary(transactions) {
            const summary = {};

            // ркбрлЗркЯрк╛ ркПркХркдрлНрк░рк┐ркд ркХрк░рлЛ
            transactions.forEach(t => {
                const item = t.itemType;
                const qty = parseInt(t.quantity) || 0;

                if (!summary[item]) {
                    summary[item] = { incomeQty: 0, expenseQty: 0 };
                }

                if (t.type === 'income') {
                    summary[item].incomeQty += qty;
                } else if (t.type === 'expense') {
                    summary[item].expenseQty += qty;
                }
            });

            // UI ркЕрккркбрлЗркЯ ркХрк░рлЛ
            itemSummaryBody.innerHTML = '';
            const items = Object.keys(summary);

            if (items.length === 0) {
                itemSummaryBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">ркХрлЛркИ ркбрлЗркЯрк╛ ркЙрккрк▓ркмрлНркз ркиркерлА</td></tr>`;
                return;
            }

            // рк╕рлЛрк░рлНркЯ ркХрк░рлЛ (рк╡рк╕рлНркдрлБркирк╛ ркирк╛рко рккрлНрк░ркорк╛ркгрлЗ)
            items.sort();

            items.forEach(item => {
                const data = summary[item];
                // ркорк╛ркдрлНрк░ ркЬрлЛ ркХрлЛркИ ркЬркерлНркерлЛ рк╣рлЛркп ркдрлЛ ркЬ ркмркдрк╛рк╡рлЛ (optional)
                if (data.incomeQty > 0 || data.expenseQty > 0) {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm font-semibold text-gray-800 bg-gray-50">${item}</td>
                        <td class="px-4 py-3 text-sm font-bold text-right text-emerald-600">${data.incomeQty} ркмрлЛрк░рлА</td>
                        <td class="px-4 py-3 text-sm font-bold text-right text-red-600">${data.expenseQty} ркмрлЛрк░рлА</td>
                    `;
                    itemSummaryBody.appendChild(row);
                }
            });
        }

        function renderTransactionLists(incomeTx, expenseTx) {
            // Income Table
            incomeListBody.innerHTML = '';
            if (incomeTx.length === 0) {
                noIncomeEl.classList.remove('hidden');
                incomeListBody.parentElement.classList.add('hidden'); 
            } else {
                noIncomeEl.classList.add('hidden');
                incomeListBody.parentElement.classList.remove('hidden');
                
                incomeTx.forEach(t => {
                    const row = document.createElement('tr');
                    const formattedDate = t.date.split('-').reverse().join('-'); 
                    
                    row.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${formattedDate}</td>
                        <td class="px-3 py-3 text-sm text-gray-600">
                            <div class="font-semibold">${t.itemType}</div>
                            <div class="text-xs text-gray-500">${t.quantity} ркмрлЛрк░рлА x ${t.rate}</div>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-emerald-600 font-bold text-right">${formatCurrency(t.amount)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-center text-sm font-medium">
                            <button onclick="editTransactionHandler('${t.id}')" class="text-blue-600 hover:text-blue-900 mx-1 p-1 rounded hover:bg-blue-50">тЬПя╕П</button>
                            <button onclick="deleteTransactionHandler('${t.id}')" class="text-red-600 hover:text-red-900 mx-1 p-1 rounded hover:bg-red-50">ЁЯЧСя╕П</button>
                        </td>
                    `;
                    incomeListBody.appendChild(row);
                });
            }

            // Expense Table
            expenseListBody.innerHTML = '';
            if (expenseTx.length === 0) {
                noExpenseEl.classList.remove('hidden');
                expenseListBody.parentElement.classList.add('hidden');
            } else {
                noExpenseEl.classList.add('hidden');
                expenseListBody.parentElement.classList.remove('hidden');

                expenseTx.forEach(t => {
                    const row = document.createElement('tr');
                    const formattedDate = t.date.split('-').reverse().join('-');

                    row.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${formattedDate}</td>
                        <td class="px-3 py-3 text-sm text-gray-600">
                            <div class="font-semibold">${t.itemType}</div>
                            <div class="text-xs text-gray-500 text-red-500">To: ${t.sourceDestination}</div>
                            <div class="text-xs text-gray-400">${t.quantity} ркмрлЛрк░рлА x ${t.rate}</div>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-red-600 font-bold text-right">${formatCurrency(t.amount)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-center text-sm font-medium">
                            <button onclick="editTransactionHandler('${t.id}')" class="text-blue-600 hover:text-blue-900 mx-1 p-1 rounded hover:bg-blue-50">тЬПя╕П</button>
                            <button onclick="deleteTransactionHandler('${t.id}')" class="text-red-600 hover:text-red-900 mx-1 p-1 rounded hover:bg-red-50">ЁЯЧСя╕П</button>
                        </td>
                    `;
                    expenseListBody.appendChild(row);
                });
            }
        }

        function applyFiltersAndRender() {
            const filterType = filterTypeInput.value;
            const filterVal = filterDateInput.value;
            
            let filteredData = [...allTransactionsData];
            
            if (filterType === 'monthly' && filterVal) {
                filteredData = filteredData.filter(t => t.date.startsWith(filterVal));
            } else if (filterType === 'yearly' && filterVal) {
                filteredData = filteredData.filter(t => t.date.startsWith(filterVal));
            }
            
            // ркдрк╛рк░рлАркЦ ркорлБркЬркм рк╕рлЛрк░рлНркЯ ркХрк░рлЛ
            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const incomeTx = filteredData.filter(t => t.type === 'income');
            const expenseTx = filteredData.filter(t => t.type === 'expense');
            
            updateSummary(filteredData);
            calculateMonthlyAnalysis(filteredData);
            updateItemSummary(filteredData); // NEW: Call item summary update
            renderTransactionLists(incomeTx, expenseTx);
        }

        // --- ркЗрк╡рлЗркирлНркЯ рк▓рк┐рк╕ркирк░рлНрк╕ ---

        form.addEventListener('submit', handleFormSubmit);
        
        quantityInput.addEventListener('input', calculateTotalAmount);
        rateInput.addEventListener('input', calculateTotalAmount);
        
        typeInput.addEventListener('change', toggleSourceDestinationVisibility);
        
        cancelButton.addEventListener('click', resetFormState);
        
        filterTypeInput.addEventListener('change', updateFilterDateInput);
        filterDateInput.addEventListener('change', applyFiltersAndRender);

        // --- рккрлНрк░рк╛рк░ркВркнрк┐ркХрк░ркг ---
        window.addEventListener('DOMContentLoaded', () => {
            dateInput.value = new Date().toISOString().substring(0, 10);
            toggleSourceDestinationVisibility();
            loadTransactions();
        });
    </script>
</body>
</html>
