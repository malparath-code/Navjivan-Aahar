<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ркирк╡ркЬрлАрк╡рки рккрк╢рлБркЖрк╣рк╛рк░ - рк╣рк┐рк╕рк╛ркм</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ркХрк╕рлНркЯрко CSS */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            width: 100%;
        }
        /* ркХрк╕рлНркЯрко рк╕рлНркХрлНрк░рлЛрк▓ркмрк╛рк░ */
        .transaction-table-body::-webkit-scrollbar {
            width: 8px;
        }
        .transaction-table-body::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        /* ркорлЛркЯрк╛ ркЗркирккрлБркЯ ркорк╛ркЯрлЗ рк╕рлНркЯрк╛ркЗрк▓ */
        .large-input {
            padding: 0.75rem; 
            border-color: #9ca3af; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        /* рк░рк┐рк╕рлНрккрлЛркирлНрк╕рк┐рк╡ ркЯрлЗркмрк▓ рклрк┐ркХрлНрк╕ */
        @media (min-width: 768px) {
            .table-container {
                display: table;
                table-layout: fixed;
                width: 100%;
            }
            .table-container thead, .table-container tbody {
                display: table-row-group;
            }
            .transaction-table-body {
                display: table-row-group;
                max-height: none;
                overflow-y: visible;
            }
        }
        /* ркЯрлНрк░рк╛ркирлНркЭрлЗркХрлНрк╢рки ркмрлЛркбрлА ркорк╛ркЯрлЗ ркорк╣ркдрлНркдрко ркКркВркЪрк╛ркИ ркорлЛркмрк╛ркЗрк▓ рккрк░ */
        .transaction-table-body {
            max-height: 400px;
            overflow-y: auto;
            display: block; /* ркорлЛркмрк╛ркИрк▓ ркорк╛ркЯрлЗ */
        }
        /* ркорлЛркмрк╛ркИрк▓ ркорк╛ркЯрлЗ рк╣рлЗркбрк░ ркЕркирлЗ рк░рлЛ рклрк┐ркХрлНрк╕ */
        thead tr, tbody tr {
             display: table;
             width: 100%;
             table-layout: fixed;
        }
    </style>
</head>
<body>
    <div class="container bg-white p-6 md:p-10 rounded-xl shadow-2xl relative">
        
        <!-- Preview Mode Banner -->
        <div id="preview-banner" class="hidden mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded shadow-md sticky top-0 z-50">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-3 md:mb-0">
                    <p class="font-bold text-lg flex items-center"><span class="text-2xl mr-2">тЪая╕П</span> рклрк╛ркИрк▓ рккрлНрк░рк┐рк╡рлНркпрлБ (Preview Mode)</p>
                    <p class="text-sm mt-1">ркдркорлЗ ркЕрккрк▓рлЛркб ркХрк░рлЗрк▓рлА рклрк╛ркИрк▓ ркЬрлЛркИ рк░рк╣рлНркпрк╛ ркЫрлЛ. ркдркорк╛рк░рлЛ <b>ркЬрлВркирлЛ ркбрлЗркЯрк╛ рк╣ркЬрлБ рк╕рлБрк░ркХрлНрк╖рк┐ркд ркЫрлЗ.</b></p>
                </div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                    <!-- Cancel Button -->
                    <button onclick="cancelImport()" class="flex items-center justify-center bg-white text-red-600 font-bold py-2 px-4 border-2 border-red-200 rounded-lg shadow hover:bg-red-50 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        рк░ркж ркХрк░рлЛ (ркЬрлВркирлЛ ркбрлЗркЯрк╛ ркмркдрк╛рк╡рлЛ)
                    </button>
                    <!-- Save Button -->
                    <button onclick="confirmImport()" class="flex items-center justify-center bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-emerald-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        ркЬрлВркирк╛ ркбрлЗркЯрк╛ркорк╛ркВ ркЙркорлЗрк░рлЛ (Merge & Save)
                    </button>
                </div>
            </div>
        </div>

        <!-- Bill Detail Modal (Popup) -->
        <div id="bill-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[100] flex justify-center items-center backdrop-blur-sm">
            <div class="relative p-5 border w-full max-w-xl shadow-2xl rounded-xl bg-white mx-4 animate-[fadeIn_0.2s_ease-out]">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800" id="bill-modal-title">ркмрк┐рк▓ рк╡рк┐ркЧркд</h3>
                        <p class="text-sm text-gray-500" id="bill-modal-subtitle">ркдрк╛рк░рлАркЦ ркЕркирлЗ рккрк╛рк░рлНркЯрлАркирлБркВ ркирк╛рко</p>
                    </div>
                    <button onclick="closeBillModal()" class="text-gray-400 hover:text-red-500 transition font-bold text-3xl leading-none">&times;</button>
                </div>
                <div class="overflow-x-auto max-h-[60vh] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">рк╡рк╕рлНркдрлБ</th>
                                <th class="px-4 py-2 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">ркЬркерлНркерлЛ</th>
                                <th class="px-4 py-2 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">ркнрк╛рк╡</th>
                                <th class="px-4 py-2 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">ркХрлБрк▓</th>
                            </tr>
                        </thead>
                        <tbody id="bill-modal-body" class="divide-y divide-gray-100 bg-white">
                            <!-- Items will be populated here -->
                        </tbody>
                        <tfoot class="bg-gray-50 font-bold sticky bottom-0">
                            <tr>
                                <td colspan="3" class="px-4 py-3 text-right text-gray-700">Grand Total:</td>
                                <td class="px-4 py-3 text-right text-gray-900" id="bill-modal-total">тВ╣ 0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="mt-5 text-right">
                    <button onclick="closeBillModal()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition shadow-sm">ркмркВркз ркХрк░рлЛ</button>
                </div>
            </div>
        </div>

        <!-- Daily Report Modal (New) -->
        <div id="daily-report-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[100] flex justify-center items-center backdrop-blur-sm">
            <div class="relative p-6 border w-full max-w-lg shadow-2xl rounded-xl bg-white mx-4 animate-[fadeIn_0.2s_ease-out]">
                <div class="flex justify-between items-center mb-6 border-b pb-3">
                    <h3 class="text-2xl font-bold text-indigo-800 flex items-center">
                        <span class="mr-2">ЁЯУЕ</span> ркжрлИркирк┐ркХ рк╡рлЗркЪрк╛ркг рк░рк┐рккрлЛрк░рлНркЯ
                    </h3>
                    <button onclick="closeDailyReport()" class="text-gray-400 hover:text-red-500 transition font-bold text-3xl leading-none">&times;</button>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-2">ркдрк╛рк░рлАркЦ рккрк╕ркВркж ркХрк░рлЛ:</label>
                    <input type="date" id="report-date" class="w-full p-3 border-2 border-indigo-100 rounded-lg focus:border-indigo-500 focus:ring focus:ring-indigo-200 transition font-semibold text-gray-700" onchange="renderDailyReport()">
                </div>

                <div class="bg-indigo-50 rounded-lg border border-indigo-100 overflow-hidden">
                    <table class="min-w-full divide-y divide-indigo-200">
                        <thead class="bg-indigo-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-indigo-800 uppercase">рк╡рк╕рлНркдрлБркирлБркВ ркирк╛рко</th>
                                <th class="px-4 py-3 text-right text-xs font-bold text-indigo-800 uppercase">рк╡рлЗркЪрк╛ркпрлЗрк▓ ркиркВркЧ (Qty)</th>
                            </tr>
                        </thead>
                        <tbody id="daily-report-body" class="divide-y divide-indigo-100 bg-white">
                            <tr><td colspan="2" class="px-4 py-3 text-center text-gray-500">ркдрк╛рк░рлАркЦ рккрк╕ркВркж ркХрк░рлЛ...</td></tr>
                        </tbody>
                        <tfoot class="bg-indigo-50 font-bold">
                            <tr>
                                <td class="px-4 py-3 text-indigo-900">ркХрлБрк▓ ркиркВркЧ (Total Qty)</td>
                                <td class="px-4 py-3 text-right text-indigo-900" id="daily-report-total-qty">0</td>
                            </tr>
                            <tr class="bg-emerald-100 text-emerald-900">
                                <td class="px-4 py-3">ркХрлБрк▓ ркЖрк╡ркХ (Total Income)</td>
                                <td class="px-4 py-3 text-right text-xl" id="daily-report-total-amount">тВ╣ 0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="mt-4 text-right text-sm text-gray-500">
                    * ркЖ рк░рк┐рккрлЛрк░рлНркЯ ркорк╛ркдрлНрк░ рк╡рлЗркЪрк╛ркг (ркЖрк╡ркХ) ркорк╛ркЯрлЗ ркЫрлЗ.
                </div>

                <div class="mt-6 text-center">
                    <button onclick="closeDailyReport()" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg">ркмркВркз ркХрк░рлЛ</button>
                </div>
            </div>
        </div>

        <header class="mb-8 border-b-4 border-emerald-500 pb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center">
                ркирк╡ркЬрлАрк╡рки рккрк╢рлБркЖрк╣рк╛рк░ (Kh─Бt─Б P┼Нth─л)
            </h1>
            <p class="text-center text-sm text-gray-600 mt-1">ркСрклрк▓рк╛ркЗрки ркЖрк╡ркХ ркЕркирлЗ ркЦрк░рлНркЪркирлЛ рк╣рк┐рк╕рк╛ркм (Offline Income & Expense Tracker)</p>
        </header>

        <!-- ркЭркбрккрлА рк░рк┐рккрлЛрк░рлНркЯ ркмркЯрки -->
        <section class="mb-6 flex justify-center">
            <button onclick="openDailyReport()" class="flex items-center justify-center bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition duration-200">
                <span class="text-xl mr-2">ЁЯУК</span> ркЖркЬркирлЛ / ркжрлИркирк┐ркХ рк╣рк┐рк╕рк╛ркм (Daily Report)
            </button>
        </section>

        <!-- ркбрлЗркЯрк╛ ркорлЗркирлЗркЬркорлЗркирлНркЯ -->
        <section class="mb-8 p-6 bg-indigo-50 rounded-xl border border-indigo-200 shadow-md">
            <h2 class="text-lg font-bold mb-3 text-indigo-900 flex items-center justify-between">
                <span class="flex items-center"><span class="text-xl mr-2">ЁЯТ╛</span> ркбрлЗркЯрк╛ ркорлЗркирлЗркЬркорлЗркирлНркЯ (Data Backup)</span>
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <button onclick="exportData()" class="flex justify-center items-center px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow">
                    <span class="mr-2">тмЗя╕П</span> ркбрлЗркЯрк╛ ркбрк╛ркЙркирк▓рлЛркб
                </button>
                <label class="flex justify-center items-center px-4 py-3 bg-white border-2 border-indigo-300 border-dashed hover:border-indigo-500 text-indigo-700 font-semibold rounded-lg shadow cursor-pointer">
                    <span class="mr-2">тмЖя╕П</span> ркбрлЗркЯрк╛ ркЕрккрк▓рлЛркб
                    <input type="file" accept=".json" class="hidden" onchange="importData(this)">
                </label>
                <button onclick="resetFile()" class="flex justify-center items-center px-4 py-3 bg-orange-100 hover:bg-orange-200 text-orange-800 border border-orange-300 font-semibold rounded-lg shadow">
                    <span class="mr-2">ЁЯФД</span> рклрк╛ркИрк▓ рк░рк┐рк╕рлЗркЯ ркХрк░рлЛ
                </button>
                <!-- Undo Button (Hidden initially) -->
                <button id="undo-button" onclick="restoreBackup()" class="hidden flex justify-center items-center px-4 py-3 bg-green-100 hover:bg-green-200 text-green-800 border border-green-300 font-semibold rounded-lg shadow animate-pulse">
                    <span class="mr-2">тЖйя╕П</span> Undo (ркбрлЗркЯрк╛ рккрк╛ркЫрлЛ рк▓рк╛рк╡рлЛ)
                </button>
            </div>
        </section>

        <!-- ркПркбрк╡рк╛ркирлНрк╕ рклрк┐рк▓рлНркЯрк░ ркЕркирлЗ рк╕рк░рлНркЪ -->
        <section class="mb-8 p-4 bg-yellow-50 rounded-xl border border-yellow-200 shadow-md">
            <h2 class="text-lg font-semibold mb-3 text-yellow-800">рк╣рк┐рк╕рк╛ркм рк╢рлЛркзрлЛ ркЕркирлЗ рклрк┐рк▓рлНркЯрк░ ркХрк░рлЛ (Search & Filter)</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-12 gap-4 items-end">
                <!-- рк╕рк░рлНркЪ ркмрк╛рк░ -->
                <div class="sm:col-span-4">
                    <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">ркирк╛рко ркХрлЗ рк╡рк┐ркЧркд рк╢рлЛркзрлЛ (Search)</label>
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="ркжрк╛.ркд. рк░ркорлЗрк╢ркнрк╛ркИ, ркоркХрк╛ркИ..." 
                               class="w-full large-input border rounded-lg focus:ring-yellow-500 focus:border-yellow-500 pl-10">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- рклрк┐рк▓рлНркЯрк░ рккрлНрк░ркХрк╛рк░ -->
                <div class="sm:col-span-3">
                    <label for="filter-type" class="block text-sm font-medium text-gray-700 mb-1">рк╕ркоркпркЧрк╛рк│рлЛ (Duration)</label>
                    <select id="filter-type" class="w-full large-input border rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-white">
                        <option value="all">ркмркзрлЛ рк╕ркоркп (All Time)</option>
                        <option value="monthly" selected>ркорк╣рк┐ркирк╛ ркорлБркЬркм (Monthly)</option>
                        <option value="yearly">рк╡рк░рлНрк╖ ркорлБркЬркм (Yearly)</option>
                        <option value="custom">ркдрк╛рк░рлАркЦ рк░рлЗркирлНркЬ (Custom Date)</option>
                    </select>
                </div>
                
                <!-- ркдрк╛рк░рлАркЦ ркЗркирккрлБркЯрлНрк╕ (Dynamic) -->
                <div class="sm:col-span-5" id="date-inputs-container">
                    <!-- ркЕрк╣рлАркВ JavaScript ркерлА ркЗркирккрлБркЯ ркЖрк╡рк╢рлЗ -->
                </div>
            </div>
            
            <!-- Custom Date Range Inputs (Hidden by default, moved via JS) -->
            <div id="custom-date-template" class="hidden grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-xs text-gray-500">ркерлА (From)</label>
                    <input type="date" id="filter-start-date" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-xs text-gray-500">рк╕рлБркзрлА (To)</label>
                    <input type="date" id="filter-end-date" class="w-full p-2 border rounded-lg">
                </div>
            </div>
        </section>

        <!-- рк╕рк╛рк░рк╛ркВрк╢ рк╡рк┐ркнрк╛ркЧ -->
        <section id="summary" class="mb-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="bg-emerald-100 p-4 rounded-lg shadow-md text-center">
                <p class="text-sm font-semibold text-emerald-700">ркХрлБрк▓ ркЖрк╡ркХ</p>
                <p id="total-income" class="text-2xl font-bold text-emerald-600 mt-1">тВ╣ 0.00</p>
            </div>
            <div class="bg-red-100 p-4 rounded-lg shadow-md text-center">
                <p class="text-sm font-semibold text-red-700">ркХрлБрк▓ ркЦрк░рлНркЪ</p>
                <p id="total-expense" class="text-2xl font-bold text-red-600 mt-1">тВ╣ 0.00</p>
            </div>
            <div class="bg-blue-100 p-4 rounded-lg shadow-md text-center">
                <p class="text-sm font-semibold text-blue-700">ркЪрлЛркЦрлНркЦрлБркВ ркмрлЗрк▓рлЗркирлНрк╕</p>
                <p id="net-balance" class="text-2xl font-bold text-blue-600 mt-1">тВ╣ 0.00</p>
            </div>
        </section>
        
        <!-- ркорк╛рк╕рк┐ркХ рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг -->
        <section class="mb-8 p-6 bg-blue-50 rounded-xl border border-blue-200 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-blue-800 border-b pb-2">ркорк╛рк╕рк┐ркХ рккрлНрк░ркжрк░рлНрк╢рки (Monthly Analysis)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-4 rounded-lg shadow-md border border-emerald-300">
                    <h3 class="text-lg font-bold text-emerald-700 mb-2">ркЖрк╡ркХ (Income)</h3>
                    <p class="text-sm text-gray-700">рк╡ркзрлБ: <span id="max-income-month" class="font-semibold">N/A</span> (<span id="max-income-amount" class="font-bold">тВ╣ 0</span>)</p>
                    <p class="text-sm text-gray-700">ркУркЫрлА: <span id="min-income-month" class="font-semibold">N/A</span> (<span id="min-income-amount" class="font-bold">тВ╣ 0</span>)</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md border border-red-300">
                    <h3 class="text-lg font-bold text-red-700 mb-2">ркЦрк░рлНркЪ (Expense)</h3>
                    <p class="text-sm text-gray-700">рк╡ркзрлБ: <span id="max-expense-month" class="font-semibold">N/A</span> (<span id="max-expense-amount" class="font-bold">тВ╣ 0</span>)</p>
                    <p class="text-sm text-gray-700">ркУркЫрлЛ: <span id="min-expense-month" class="font-semibold">N/A</span> (<span id="min-expense-amount" class="font-bold">тВ╣ 0</span>)</p>
                </div>
            </div>
        </section>

        <!-- рк╡рк╕рлНркдрлБ ркорлБркЬркм рк╕рк╛рк░рк╛ркВрк╢ -->
        <section class="mb-10 p-6 bg-purple-50 rounded-xl border border-purple-200 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-purple-800 border-b pb-2">рк╕рлНркЯрлЛркХ рк╕ркорк░рлА (Stock Summary)</h2>
            <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200 bg-white">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-purple-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-purple-900">рк╡рк╕рлНркдрлБ</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-emerald-700">ркЖрк╡ркХ ркЬркерлНркерлЛ</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-red-700">ркЦрк░рлНркЪ ркЬркерлНркерлЛ</th>
                        </tr>
                    </thead>
                    <tbody id="item-summary-body" class="divide-y divide-gray-100">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">ркорк╛рк╣рк┐ркдрлА ркиркерлА</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- рклрлЛрк░рлНрко -->
        <section class="mb-10 p-6 bg-gray-50 rounded-xl border border-gray-200 shadow-lg">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-semibold text-gray-700" id="form-title">рк╡рлНркпрк╡рк╣рк╛рк░ ркЙркорлЗрк░рлЛ</h2>
                <!-- Mode Toggle -->
                <div class="flex bg-gray-200 p-1 rounded-lg">
                    <button onclick="switchMode('single')" id="btn-mode-single" class="px-3 py-1 rounded-md text-sm font-bold bg-white shadow text-gray-800 transition">ркПркХ (Single)</button>
                    <button onclick="switchMode('bulk')" id="btn-mode-bulk" class="px-3 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-gray-800 transition">ркПркХ рк╕рк╛ркерлЗ ркЕркирлЗркХ (Bill)</button>
                </div>
            </div>

            <!-- Single Entry Form -->
            <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-8 gap-4 items-end">
                <div class="md:col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">ркдрк╛рк░рлАркЦ</label>
                    <input type="date" id="date" required class="w-full large-input border rounded-lg">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">рккрлНрк░ркХрк╛рк░</label>
                    <select id="item-type" required class="w-full large-input border rounded-lg bg-white">
                        <option value="" disabled selected>рккрк╕ркВркж ркХрк░рлЛ</option>
                        <option value="ркоркХрк╛ркИ рккрк╛рккркбрлА">ркоркХрк╛ркИ рккрк╛рккркбрлА</option>
                        <option value="ркоркХрк╛ркИ ркнрк░ркбрлЛ">ркоркХрк╛ркИ ркнрк░ркбрлЛ</option>
                        <option value="рккрк╛рккркбрлА">рккрк╛рккркбрлА</option>
                        <option value="ркЬрк╡ ркнрк░ркбрлЛ">ркЬрк╡ ркнрк░ркбрлЛ</option>
                        <option value="рк╕рлЛркпрк╛ркмрлАрки">рк╕рлЛркпрк╛ркмрлАрки</option>
                        <option value="ркдрлБрк╡рлЗрк░ркЪрлБркирлА">ркдрлБрк╡рлЗрк░ркЪрлБркирлА</option>
                        <option value="рккрк╢рлБ ркЖрк╣рк╛рк░">рккрк╢рлБ ркЖрк╣рк╛рк░</option>
                        <option value="рк▓рк╛рк▓рлА">рк▓рк╛рк▓рлА</option>
                        <option value="ркжрк╛ркг">ркжрк╛ркг</option>
                        <option value="ркЬрлАрк░рк╛рк│рлЛ">ркЬрлАрк░рк╛рк│рлЛ</option>
                        <option value="ркЕркирлНркп">ркЕркирлНркп</option>
                    </select>
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">ркмрлЛрк░рлА</label>
                    <input type="number" id="quantity" placeholder="0" required min="1" class="w-full large-input border rounded-lg">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">ркнрк╛рк╡</label>
                    <input type="number" id="rate" placeholder="0.00" required min="0.01" step="0.01" class="w-full large-input border rounded-lg">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">ркХрлБрк▓</label>
                    <input type="text" id="total-amount-display" value="тВ╣ 0" readonly class="w-full large-input border rounded-lg bg-gray-200 font-bold">
                    <input type="hidden" id="amount-hidden">
                </div>
                <div class="md:col-span-1" id="source-destination-group">
                    <label id="source-dest-label" class="block text-xs font-medium text-gray-700 mb-1">ркХрлЛркирлЗ ркЖрккрлНркпрлБркВ</label>
                    <input type="text" id="source-destination" placeholder="ркирк╛рко" required class="w-full large-input border rounded-lg">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">рк╡рлНркпрк╡рк╣рк╛рк░</label>
                    <select id="type" required class="w-full large-input border rounded-lg bg-white">
                        <option value="income">ркЖрк╡ркХ</option>
                        <option value="expense">ркЦрк░рлНркЪ</option>
                    </select>
                </div>
                <div class="md:col-span-1">
                    <button type="submit" id="submit-button" class="w-full bg-emerald-600 text-white font-bold py-3 px-2 rounded-xl shadow hover:bg-emerald-700 text-sm">ркЙркорлЗрк░рлЛ</button>
                    <button type="button" id="cancel-edit-button" class="w-full bg-gray-400 text-white font-bold py-3 px-2 rounded-xl shadow mt-2 hidden text-sm">рк░ркжрлНркж</button>
                </div>
            </form>

            <!-- Bulk Entry Form -->
            <div id="bulk-entry-form" class="hidden">
                <!-- Common Details -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">ркдрк╛рк░рлАркЦ</label>
                        <input type="date" id="bulk-date" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label id="bulk-source-label" class="block text-xs font-medium text-gray-700 mb-1">ркХрлЛркирлЗ ркЖрккрлНркпрлБркВ</label>
                        <input type="text" id="bulk-source" placeholder="рккрк╛рк░рлНркЯрлАркирлБркВ ркирк╛рко" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">рк╡рлНркпрк╡рк╣рк╛рк░ рккрлНрк░ркХрк╛рк░</label>
                        <select id="bulk-type" class="w-full p-2 border rounded-lg bg-white">
                            <option value="income">ркЖрк╡ркХ (Income)</option>
                            <option value="expense">ркЦрк░рлНркЪ (Expense)</option>
                        </select>
                    </div>
                </div>

                <!-- Items List -->
                <div class="border rounded-lg overflow-hidden mb-4">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 w-1/3">рк╡рк╕рлНркдрлБ (Item)</th>
                                <th class="px-4 py-3 w-1/6">ркмрлЛрк░рлА (Qty)</th>
                                <th class="px-4 py-3 w-1/6">ркнрк╛рк╡ (Rate)</th>
                                <th class="px-4 py-3 w-1/6">ркХрлБрк▓ (Total)</th>
                                <th class="px-4 py-3 w-1/12">Action</th>
                            </tr>
                        </thead>
                        <tbody id="bulk-items-body">
                            <!-- Dynamic Rows -->
                        </tbody>
                        <tfoot>
                             <tr class="bg-gray-50 font-bold">
                                <td colspan="3" class="px-4 py-3 text-right">Grand Total:</td>
                                <td class="px-4 py-3 text-gray-900" id="bulk-grand-total">тВ╣ 0</td>
                                <td></td>
                             </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="addBulkRow()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg text-sm font-bold">+ ркмрлАркЬрлА рк╡рк╕рлНркдрлБ ркЙркорлЗрк░рлЛ</button>
                    <button id="btn-save-bulk" onclick="saveBulkData()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold ml-auto">ркмркзрлБркВ рк╕рк╛ркЪрк╡рлЛ (Save All)</button>
                    <button onclick="cancelBulkEdit()" id="btn-cancel-bulk" class="hidden px-4 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-lg text-sm font-bold">рк░ркжрлНркж</button>
                </div>
            </div>

            <p id="status-message" class="text-center text-sm mt-3 font-semibold"></p>
        </section>

        <!-- ркпрк╛ркжрлАркУ -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ркЖрк╡ркХ -->
            <div id="income-section">
                <h2 class="text-xl font-semibold mb-4 text-emerald-700 border-b pb-2">ркЖрк╡ркХ (Income)</h2>
                <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-200 table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-emerald-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 w-1/4">ркдрк╛рк░рлАркЦ</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 w-2/4">рк╡рк┐ркЧркд</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 w-1/4">рк░ркХрко</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500">Action</th>
                            </tr>
                        </thead>
                        <tbody id="income-list-body" class="bg-white divide-y divide-gray-100 transaction-table-body"></tbody>
                    </table>
                </div>
                <p id="no-income" class="text-center text-gray-500 mt-4 hidden">ркбрлЗркЯрк╛ ркиркерлА.</p>
            </div>
            <!-- ркЦрк░рлНркЪ -->
            <div id="expense-section">
                <h2 class="text-xl font-semibold mb-4 text-red-700 border-b pb-2">ркЦрк░рлНркЪ (Expense)</h2>
                 <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-200 table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-red-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 w-1/4">ркдрк╛рк░рлАркЦ</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 w-2/4">рк╡рк┐ркЧркд</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 w-1/4">рк░ркХрко</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500">Action</th>
                            </tr>
                        </thead>
                        <tbody id="expense-list-body" class="bg-white divide-y divide-gray-100 transaction-table-body"></tbody>
                    </table>
                </div>
                <p id="no-expense" class="text-center text-gray-500 mt-4 hidden">ркбрлЗркЯрк╛ ркиркерлА.</p>
            </div>
        </section>
    </div>

    <script>
        // --- Constants & State ---
        const STORAGE_KEY = 'khataPothiTransactions';
        const BACKUP_KEY = 'khataPothiTempBackup';
        const GUJARATI_MONTHS = ["ркЬрк╛ркирлНркпрлБркЖрк░рлА", "рклрлЗркмрлНрк░рлБркЖрк░рлА", "ркорк╛рк░рлНркЪ", "ркПрккрлНрк░рк┐рк▓", "ркорлЗ", "ркЬрлВрки", "ркЬрлБрк▓рк╛ркИ", "ркУркЧрк╕рлНркЯ", "рк╕рккрлНркЯрлЗркорлНркмрк░", "ркУркХрлНркЯрлЛркмрк░", "ркирк╡рлЗркорлНркмрк░", "ркбрк┐рк╕рлЗркорлНркмрк░"];
        
        let allTransactionsData = [];
        let tempImportedData = []; // To store imported data temporarily for preview
        let editingTransactionId = null;
        let editingBillId = null; // To track if we are editing a bill
        let isPreviewMode = false;

        // --- DOM Elements ---
        const els = {
            form: document.getElementById('transaction-form'),
            inputs: {
                date: document.getElementById('date'),
                itemType: document.getElementById('item-type'),
                quantity: document.getElementById('quantity'),
                rate: document.getElementById('rate'),
                totalDisplay: document.getElementById('total-amount-display'),
                amountHidden: document.getElementById('amount-hidden'),
                type: document.getElementById('type'),
                sourceDest: document.getElementById('source-destination'),
                sourceDestGroup: document.getElementById('source-destination-group'),
                search: document.getElementById('search-input')
            },
            buttons: {
                submit: document.getElementById('submit-button'),
                cancel: document.getElementById('cancel-edit-button'),
                undo: document.getElementById('undo-button')
            },
            summary: {
                income: document.getElementById('total-income'),
                expense: document.getElementById('total-expense'),
                balance: document.getElementById('net-balance'),
                itemBody: document.getElementById('item-summary-body'),
                monthly: {
                    maxIncM: document.getElementById('max-income-month'),
                    maxIncA: document.getElementById('max-income-amount'),
                    minIncM: document.getElementById('min-income-month'),
                    minIncA: document.getElementById('min-income-amount'),
                    maxExpM: document.getElementById('max-expense-month'),
                    maxExpA: document.getElementById('max-expense-amount'),
                    minExpM: document.getElementById('min-expense-month'),
                    minExpA: document.getElementById('min-expense-amount')
                }
            },
            lists: {
                income: document.getElementById('income-list-body'),
                expense: document.getElementById('expense-list-body'),
                noIncome: document.getElementById('no-income'),
                noExpense: document.getElementById('no-expense')
            },
            filter: {
                type: document.getElementById('filter-type'),
                container: document.getElementById('date-inputs-container'),
                statusMsg: document.getElementById('status-message')
            },
            preview: {
                banner: document.getElementById('preview-banner')
            },
            bulk: {
                form: document.getElementById('bulk-entry-form'),
                btnSingle: document.getElementById('btn-mode-single'),
                btnBulk: document.getElementById('btn-mode-bulk'),
                body: document.getElementById('bulk-items-body'),
                total: document.getElementById('bulk-grand-total'),
                date: document.getElementById('bulk-date'),
                source: document.getElementById('bulk-source'),
                type: document.getElementById('bulk-type'),
                btnSave: document.getElementById('btn-save-bulk'),
                btnCancel: document.getElementById('btn-cancel-bulk')
            }
        };

        // --- Helper Functions ---
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);
        
        const showStatus = (msg, type = 'success') => {
            els.filter.statusMsg.textContent = msg;
            els.filter.statusMsg.className = `text-center text-sm mt-3 font-semibold ${type === 'error' ? 'text-red-600' : 'text-emerald-600'}`;
            setTimeout(() => els.filter.statusMsg.textContent = '', 5000);
        };

        const formatCurrency = (amt) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }).format(amt || 0);

        const calculateTotal = () => {
            const q = parseFloat(els.inputs.quantity.value) || 0;
            const r = parseFloat(els.inputs.rate.value) || 0;
            const total = (q * r).toFixed(2);
            els.inputs.totalDisplay.value = formatCurrency(total);
            els.inputs.amountHidden.value = total;
        };

        const toggleSourceDest = () => {
            const label = document.getElementById('source-dest-label');
            if (els.inputs.type.value === 'expense') {
                els.inputs.sourceDestGroup.classList.remove('hidden');
                els.inputs.sourceDest.required = true;
                els.inputs.sourceDest.placeholder = "ркХрлЛркирлЗ ркЪрлВркХрк╡рлНркпрк╛?";
                label.textContent = "ркХрлЛркирлЗ ркЪрлВркХрк╡рлНркпрк╛";
            } else {
                els.inputs.sourceDestGroup.classList.remove('hidden');
                els.inputs.sourceDest.required = true;
                els.inputs.sourceDest.placeholder = "ркХрлЛркирлЗ ркЖрккрлНркпрлБркВ?";
                label.textContent = "ркХрлЛркирлЗ ркЖрккрлНркпрлБркВ";
            }
        };

        // --- Mode Switcher (Single vs Bulk) ---
        window.switchMode = (mode) => {
            // Clear editing state if switching manually
            if(mode === 'single') {
                cancelBulkEdit(); // Clear bulk state
                els.form.classList.remove('hidden');
                els.bulk.form.classList.add('hidden');
                els.bulk.btnSingle.className = "px-3 py-1 rounded-md text-sm font-bold bg-white shadow text-gray-800 transition";
                els.bulk.btnBulk.className = "px-3 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-gray-800 transition";
            } else {
                els.form.classList.add('hidden');
                els.bulk.form.classList.remove('hidden');
                els.bulk.btnSingle.className = "px-3 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-gray-800 transition";
                els.bulk.btnBulk.className = "px-3 py-1 rounded-md text-sm font-bold bg-white shadow text-gray-800 transition";
                
                // Set default date for bulk if empty
                if(!els.bulk.date.value) els.bulk.date.valueAsDate = new Date();
                // Add one empty row if none exist AND we are not editing
                if(els.bulk.body.children.length === 0 && !editingBillId) addBulkRow();
            }
        };

        // --- Bulk Entry Logic ---
        window.addBulkRow = () => {
            const rowId = generateId();
            const tr = document.createElement('tr');
            tr.id = `row-${rowId}`;
            tr.className = "bg-white border-b hover:bg-gray-50";
            tr.innerHTML = `
                <td class="px-4 py-2">
                    <select class="w-full p-1 border rounded text-sm item-select" onchange="updateBulkTotal('${rowId}')">
                        <option value="" disabled selected>рккрк╕ркВркж ркХрк░рлЛ</option>
                        <option value="ркоркХрк╛ркИ рккрк╛рккркбрлА">ркоркХрк╛ркИ рккрк╛рккркбрлА</option>
                        <option value="ркоркХрк╛ркИ ркнрк░ркбрлЛ">ркоркХрк╛ркИ ркнрк░ркбрлЛ</option>
                        <option value="рккрк╛рккркбрлА">рккрк╛рккркбрлА</option>
                        <option value="ркЬрк╡ ркнрк░ркбрлЛ">ркЬрк╡ ркнрк░ркбрлЛ</option>
                        <option value="рк╕рлЛркпрк╛ркмрлАрки">рк╕рлЛркпрк╛ркмрлАрки</option>
                        <option value="ркдрлБрк╡рлЗрк░ркЪрлБркирлА">ркдрлБрк╡рлЗрк░ркЪрлБркирлА</option>
                        <option value="рккрк╢рлБ ркЖрк╣рк╛рк░">рккрк╢рлБ ркЖрк╣рк╛рк░</option>
                        <option value="рк▓рк╛рк▓рлА">рк▓рк╛рк▓рлА</option>
                        <option value="ркжрк╛ркг">ркжрк╛ркг</option>
                        <option value="ркЬрлАрк░рк╛рк│рлЛ">ркЬрлАрк░рк╛рк│рлЛ</option>
                        <option value="ркЕркирлНркп">ркЕркирлНркп</option>
                    </select>
                </td>
                <td class="px-4 py-2">
                    <input type="number" class="w-full p-1 border rounded text-sm text-right qty-input" min="1" placeholder="0" oninput="updateBulkTotal('${rowId}')">
                </td>
                <td class="px-4 py-2">
                    <input type="number" class="w-full p-1 border rounded text-sm text-right rate-input" min="0" step="0.01" placeholder="0" oninput="updateBulkTotal('${rowId}')">
                </td>
                <td class="px-4 py-2 text-right font-bold text-gray-700 total-cell">тВ╣ 0</td>
                <td class="px-4 py-2 text-center">
                    <button onclick="removeBulkRow('${rowId}')" class="text-red-500 hover:text-red-700 font-bold">├Ч</button>
                </td>
            `;
            els.bulk.body.appendChild(tr);
            return tr;
        };

        window.removeBulkRow = (id) => {
            const row = document.getElementById(`row-${id}`);
            if(row) row.remove();
            calculateBulkGrandTotal();
        };

        window.updateBulkTotal = (rowId) => {
            const row = document.getElementById(`row-${rowId}`);
            const q = parseFloat(row.querySelector('.qty-input').value) || 0;
            const r = parseFloat(row.querySelector('.rate-input').value) || 0;
            const total = q * r;
            row.querySelector('.total-cell').innerText = formatCurrency(total);
            row.setAttribute('data-total', total);
            calculateBulkGrandTotal();
        };

        const calculateBulkGrandTotal = () => {
            let grand = 0;
            const rows = els.bulk.body.querySelectorAll('tr');
            rows.forEach(r => {
                grand += parseFloat(r.getAttribute('data-total') || 0);
            });
            els.bulk.total.innerText = formatCurrency(grand);
        };

        window.saveBulkData = () => {
            const date = els.bulk.date.value;
            const source = els.bulk.source.value.trim();
            const type = els.bulk.type.value;

            if(!date || !source) return alert("ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркдрк╛рк░рлАркЦ ркЕркирлЗ ркирк╛рко ркнрк░рлЛ.");

            const rows = els.bulk.body.querySelectorAll('tr');
            if(rows.length === 0) return alert("ркХрлЛркИ рк╡рк╕рлНркдрлБ ркЙркорлЗрк░рлЗрк▓ ркиркерлА.");

            let entriesToAdd = [];
            let isValid = true;
            
            // If editing, reuse the ID, otherwise create new
            const billId = editingBillId || generateId();

            rows.forEach(r => {
                const itemType = r.querySelector('.item-select').value;
                const q = parseFloat(r.querySelector('.qty-input').value);
                const rate = parseFloat(r.querySelector('.rate-input').value);
                const total = parseFloat(r.getAttribute('data-total'));

                if(!itemType || !q || !rate) {
                    isValid = false;
                } else {
                    entriesToAdd.push({
                        id: generateId(), 
                        billId: billId, 
                        date: date,
                        itemType: itemType,
                        quantity: q,
                        rate: rate,
                        amount: total,
                        sourceDest: source,
                        type: type
                    });
                }
            });

            if(!isValid) return alert("ркмркзрлА рк╡рк╕рлНркдрлБркирлА рк╡рк┐ркЧркд (ркирк╛рко, ркЬркерлНркерлЛ, ркнрк╛рк╡) ркнрк░рлЛ.");

            // If editing, first remove old entries for this bill
            if(editingBillId) {
                allTransactionsData = allTransactionsData.filter(t => t.billId !== editingBillId);
            }

            // Add all new entries
            entriesToAdd.forEach(e => allTransactionsData.push(e));
            
            // Clean up state
            editingBillId = null;
            els.bulk.btnSave.textContent = "ркмркзрлБркВ рк╕рк╛ркЪрк╡рлЛ (Save All)";
            els.bulk.btnCancel.classList.add('hidden');
            
            saveData();
            renderAll();
            
            // Reset Bulk Form
            els.bulk.body.innerHTML = '';
            els.bulk.source.value = '';
            els.bulk.total.innerText = 'тВ╣ 0';
            addBulkRow(); // Add one fresh row
            
            showStatus(editingBillId ? `ркмрк┐рк▓ рк╕рлБркзрк╛рк░рк╛ркИ ркЧркпрлБркВ!` : `${entriesToAdd.length} рк╡рк╕рлНркдрлБркУркирлБркВ ркмрк┐рк▓ ркЙркорлЗрк░рк╛ркИ ркЧркпрлБркВ!`);
        };
        
        window.cancelBulkEdit = () => {
            editingBillId = null;
            els.bulk.btnSave.textContent = "ркмркзрлБркВ рк╕рк╛ркЪрк╡рлЛ (Save All)";
            els.bulk.btnCancel.classList.add('hidden');
            els.bulk.body.innerHTML = '';
            els.bulk.source.value = '';
            els.bulk.total.innerText = 'тВ╣ 0';
            addBulkRow();
        };

        window.editBill = (billId) => {
            // 1. Find all transactions for this bill
            const billItems = allTransactionsData.filter(t => t.billId === billId);
            if(billItems.length === 0) return;

            // 2. Switch to bulk mode
            els.form.classList.add('hidden');
            els.bulk.form.classList.remove('hidden');
            els.bulk.btnSingle.className = "px-3 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-gray-800 transition";
            els.bulk.btnBulk.className = "px-3 py-1 rounded-md text-sm font-bold bg-white shadow text-gray-800 transition";

            // 3. Populate Header Data
            const first = billItems[0];
            els.bulk.date.value = first.date;
            els.bulk.source.value = first.sourceDest;
            els.bulk.type.value = first.type;

            // 4. Populate Rows
            els.bulk.body.innerHTML = ''; // Clear existing rows
            billItems.forEach(item => {
                const tr = addBulkRow(); // Create row
                const rowId = tr.id.replace('row-', '');
                
                // Set values
                tr.querySelector('.item-select').value = item.itemType;
                tr.querySelector('.qty-input').value = item.quantity;
                tr.querySelector('.rate-input').value = item.rate;
                
                // Trigger update logic to set totals
                updateBulkTotal(rowId);
            });

            // 5. Set Edit Mode State
            editingBillId = billId;
            els.bulk.btnSave.textContent = "ркЕрккркбрлЗркЯ ркмрк┐рк▓ (Update)";
            els.bulk.btnCancel.classList.remove('hidden');
            
            // 6. Scroll to form
            els.bulk.form.scrollIntoView({ behavior: 'smooth' });
        };

        // --- Data Management ---
        const loadData = () => {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                allTransactionsData = data ? JSON.parse(data) : [];
                // Ensure numbers are numbers
                allTransactionsData = allTransactionsData.map(t => ({...t, amount: parseFloat(t.amount), quantity: parseInt(t.quantity)}));
            } catch (e) { console.error(e); allTransactionsData = []; }
            renderAll();
        };

        const saveData = () => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allTransactionsData));
        };

        const exportData = () => {
            let dataToExport = [...allTransactionsData];
            let filenameSuffix = 'All';
            // Check for Monthly Filter logic...
            const type = els.filter.type.value;
            const dynamicDateInput = document.getElementById('filter-date-dynamic');
            if (type === 'monthly' && dynamicDateInput && dynamicDateInput.value) {
                dataToExport = dataToExport.filter(t => t.date.startsWith(dynamicDateInput.value));
                filenameSuffix = dynamicDateInput.value;
            } else if (type === 'yearly' && dynamicDateInput && dynamicDateInput.value) {
                 dataToExport = dataToExport.filter(t => t.date.startsWith(dynamicDateInput.value));
                 filenameSuffix = dynamicDateInput.value;
            }

            if(!dataToExport.length) return showStatus("ркбрк╛ркЙркирк▓рлЛркб ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ ркХрлЛркИ ркбрлЗркЯрк╛ ркиркерлА.", 'error');

            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Navjivan_Data_${filenameSuffix}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showStatus(`рклрк╛ркИрк▓ ркбрк╛ркЙркирк▓рлЛркб ркеркИ! (${filenameSuffix})`);
        };

        const resetFile = () => {
            if(confirm("рк╢рлБркВ ркдркорлЗ ркЦрк╛ркдрк╛ркирлА рклрк╛ркИрк▓ рк░рк┐рк╕рлЗркЯ ркХрк░рк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?\n\nркЖркирк╛ркерлА ркЕркдрлНркпрк╛рк░ркирлЛ ркмркзрлЛ ркбрлЗркЯрк╛ ркЬркдрлЛ рк░рк╣рлЗрк╢рлЗ ркЕркирлЗ ркирк╡рлБркВ ркХрлЛрк░рлБркВ ркЦрк╛ркдрлБркВ рк╢рк░рлВ ркерк╢рлЗ.")) {
                localStorage.setItem(BACKUP_KEY, JSON.stringify(allTransactionsData));
                localStorage.removeItem(STORAGE_KEY);
                allTransactionsData = [];
                loadData();
                els.buttons.undo.classList.remove('hidden');
                showStatus("рклрк╛ркИрк▓ рк░рк┐рк╕рлЗркЯ ркеркИ ркЧркИ. ркЬрлВркирлЛ ркбрлЗркЯрк╛ 'Undo' ркмркЯркиркерлА рккрк╛ркЫрлЛ рк▓рк╛рк╡рлА рк╢ркХрк╛рк╢рлЗ.");
            }
        };

        const restoreBackup = () => {
            const backup = localStorage.getItem(BACKUP_KEY);
            if(backup) {
                if(confirm("рк╢рлБркВ ркдркорлЗ рк░рк┐рк╕рлЗркЯ ркХрк░рлЗрк▓рлЛ ркбрлЗркЯрк╛ рккрк╛ркЫрлЛ рк▓рк╛рк╡рк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?")) {
                    allTransactionsData = JSON.parse(backup);
                    saveData();
                    renderAll();
                    els.buttons.undo.classList.add('hidden');
                    showStatus("ркЬрлВркирлЛ ркбрлЗркЯрк╛ рккрк╛ркЫрлЛ ркЖрк╡рлА ркЧркпрлЛ!");
                }
            } else {
                showStatus("ркХрлЛркИ ркмрлЗркХркЕркк ркбрлЗркЯрк╛ ркорк│рлНркпрлЛ ркиркерлА.", 'error');
            }
        };

        const importData = (input) => {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data)) {
                        isPreviewMode = true;
                        tempImportedData = data;
                        renderAll();
                        els.preview.banner.classList.remove('hidden');
                        els.buttons.submit.disabled = true;
                        showStatus("рккрлНрк░рк┐рк╡рлНркпрлБ ркорлЛркб ркЪрк╛рк▓рлБ ркЫрлЗ.");
                    } else showStatus("ркЦрлЛркЯрлА рклрк╛ркИрк▓ ркЫрлЗ.", 'error');
                } catch(err) { showStatus("рклрк╛ркИрк▓ рк╡рк╛ркВркЪрлА рк╢ркХрк╛ркИ ркиркерлА.", 'error'); }
                input.value = '';
            };
            reader.readAsText(input.files[0]);
        };

        const confirmImport = () => {
            if(confirm("ркЖ ркбрлЗркЯрк╛ ркдркорк╛рк░рк╛ ркЬрлВркирк╛ ркбрлЗркЯрк╛ркорк╛ркВ ркЙркорлЗрк░рк╛рк╢рлЗ (Merge). рк╢рлБркВ ркдркорлЗ ркЖркЧрк│ рк╡ркзрк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?")) {
                const mergedMap = new Map();
                allTransactionsData.forEach(item => mergedMap.set(item.id, item));
                tempImportedData.forEach(item => {
                    if(!item.id) item.id = generateId();
                    mergedMap.set(item.id, item);
                });
                allTransactionsData = Array.from(mergedMap.values());
                allTransactionsData.sort((a,b) => new Date(b.date) - new Date(a.date));
                saveData();
                isPreviewMode = false;
                tempImportedData = [];
                els.preview.banner.classList.add('hidden');
                els.buttons.submit.disabled = false;
                renderAll();
                showStatus("ркбрлЗркЯрк╛ рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркорк░рлНркЬ (Merge) ркеркИ ркЧркпрлЛ!");
            }
        };

        const cancelImport = () => {
            isPreviewMode = false;
            tempImportedData = [];
            els.preview.banner.classList.add('hidden');
            els.buttons.submit.disabled = false;
            renderAll();
            showStatus("ркУрк░рлАркЬрлАркирк▓ ркбрлЗркЯрк╛ рккрк╛ркЫрлЛ ркЖрк╡рлА ркЧркпрлЛ.");
        };

        // --- Filter Logic ---
        const updateFilterInputs = () => {
            const type = els.filter.type.value;
            els.filter.container.innerHTML = '';
            if (type === 'all') {
                els.filter.container.innerHTML = `<label class="block text-sm font-medium text-gray-700 mb-1">ркдрк╛рк░рлАркЦ</label><input type="text" disabled value="ркмркзрлЛ ркбрлЗркЯрк╛" class="w-full large-input border rounded-lg bg-gray-100 text-gray-500">`;
            } else if (type === 'monthly') {
                els.filter.container.innerHTML = `<label class="block text-sm font-medium text-gray-700 mb-1">ркорк╣рк┐ркирлЛ</label><input type="month" id="filter-date-dynamic" class="w-full large-input border rounded-lg">`;
                const monthInput = document.getElementById('filter-date-dynamic');
                monthInput.value = new Date().toISOString().slice(0,7);
                monthInput.addEventListener('change', renderAll);
            } else if (type === 'yearly') {
                els.filter.container.innerHTML = `<label class="block text-sm font-medium text-gray-700 mb-1">рк╡рк░рлНрк╖</label><input type="number" id="filter-date-dynamic" min="2000" max="2100" class="w-full large-input border rounded-lg">`;
                const yearInput = document.getElementById('filter-date-dynamic');
                yearInput.value = new Date().getFullYear();
                yearInput.addEventListener('input', renderAll);
            } else if (type === 'custom') {
                const template = document.getElementById('custom-date-template').innerHTML;
                els.filter.container.innerHTML = template;
                document.getElementById('filter-start-date').addEventListener('change', renderAll);
                document.getElementById('filter-end-date').addEventListener('change', renderAll);
            }
            renderAll();
        };

        const getFilteredData = () => {
            let data = isPreviewMode ? tempImportedData : allTransactionsData;
            const query = els.inputs.search.value.toLowerCase();
            if (query) {
                data = data.filter(t => 
                    t.itemType.toLowerCase().includes(query) || 
                    t.sourceDest.toLowerCase().includes(query) ||
                    t.amount.toString().includes(query)
                );
            }
            const type = els.filter.type.value;
            const dynamicDateInput = document.getElementById('filter-date-dynamic');

            if (type === 'monthly' && dynamicDateInput && dynamicDateInput.value) {
                data = data.filter(t => t.date.startsWith(dynamicDateInput.value));
            } else if (type === 'yearly' && dynamicDateInput && dynamicDateInput.value) {
                data = data.filter(t => t.date.startsWith(dynamicDateInput.value));
            } else if (type === 'custom') {
                const start = document.getElementById('filter-start-date')?.value;
                const end = document.getElementById('filter-end-date')?.value;
                if (start) data = data.filter(t => t.date >= start);
                if (end) data = data.filter(t => t.date <= end);
            }
            return data.sort((a, b) => new Date(b.date) - new Date(a.date));
        };

        // --- Rendering ---
        const renderAll = () => {
            const filteredData = getFilteredData();

            // Calculate Totals
            let income = 0, expense = 0;
            filteredData.forEach(t => {
                if (t.type === 'income') income += t.amount;
                else expense += t.amount;
            });

            els.summary.income.innerText = formatCurrency(income);
            els.summary.expense.innerText = formatCurrency(expense);
            els.summary.balance.innerText = formatCurrency(income - expense);
            els.summary.balance.className = `text-2xl font-bold mt-1 ${income - expense >= 0 ? 'text-blue-600' : 'text-red-600'}`;

            renderTable(filteredData.filter(t => t.type === 'income'), 'income', els.lists.income, els.lists.noIncome);
            renderTable(filteredData.filter(t => t.type === 'expense'), 'expense', els.lists.expense, els.lists.noExpense);

            renderStockSummary(filteredData);
            renderMonthlyAnalysis(filteredData);
        };

        const renderTable = (data, type, tableBody, noMsg) => {
            tableBody.innerHTML = '';
            if (data.length === 0) {
                noMsg.classList.remove('hidden');
                return;
            }
            noMsg.classList.add('hidden');

            // NEW: Logic to group items by billId
            const renderedBillIds = new Set();

            data.forEach(t => {
                if (t.billId) {
                    // Handle Bill Grouping
                    if (renderedBillIds.has(t.billId)) return; // Skip if already rendered

                    // Find all parts of this bill from the *total* data (or filtered data?)
                    // Using allTransactionsData ensures correct total even if filter hides some parts, 
                    // but usually filters (date/name) keep bills together.
                    const billItems = allTransactionsData.filter(x => x.billId === t.billId);
                    
                    // Double check if we should render this based on current view filters
                    // If none of the items are in 'data', we wouldn't be here.
                    
                    const totalQty = billItems.reduce((sum, i) => sum + i.quantity, 0);
                    const totalAmt = billItems.reduce((sum, i) => sum + i.amount, 0);
                    
                    // Create a summarized name string
                    const names = [...new Set(billItems.map(i => i.itemType))].join(', ');
                    const dateObj = new Date(t.date);
                    const dateStr = `${dateObj.getDate().toString().padStart(2,'0')}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}-${dateObj.getFullYear()}`;

                    const row = document.createElement('tr');
                    row.className = "bg-yellow-50 border-b hover:bg-yellow-100 transition"; // Highlight bills slightly
                    row.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap text-xs font-medium text-gray-900">
                            ${dateStr}
                            <div class="text-gray-500 text-[10px] font-bold">${t.sourceDest}</div>
                        </td>
                        <td class="px-3 py-3 text-xs text-gray-500 break-words">
                            <span class="font-bold text-indigo-700">ркмрк┐рк▓ (${billItems.length} рк╡рк╕рлНркдрлБ):</span> ${names}<br>
                            <span class="font-semibold text-black">ркХрлБрк▓ ${totalQty} ркиркВркЧ</span>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-xs text-right font-bold ${type === 'income' ? 'text-emerald-600' : 'text-red-600'}">
                            ${formatCurrency(totalAmt)}
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-xs text-center flex justify-center items-center space-x-1 h-full">
                            ${!isPreviewMode ? `
                            <button onclick="viewBill('${t.billId}')" class="flex items-center justify-center text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded border border-blue-200 transition shadow-sm" title="ркмрк┐рк▓ ркЬрлЛрк╡рлЛ">
                                ЁЯСБя╕П <span class="ml-1 hidden md:inline">ркЬрлЛрк╡рлЛ</span>
                            </button>
                            <button onclick="editBill('${t.billId}')" class="flex items-center justify-center text-green-600 hover:text-green-800 bg-green-50 hover:bg-green-100 px-2 py-1 rounded border border-green-200 transition shadow-sm" title="ркмрк┐рк▓ рк╕рлБркзрк╛рк░рлЛ">
                                тЬПя╕П <span class="ml-1 hidden md:inline">рк╕рлБркзрк╛рк░рлЛ</span>
                            </button>
                            <button onclick="deleteBill('${t.billId}')" class="flex items-center justify-center text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 px-2 py-1 rounded border border-red-200 transition shadow-sm" title="ркмрк┐рк▓ ркбрк┐рк▓рлАркЯ ркХрк░рлЛ">
                                ЁЯЧСя╕П
                            </button>
                            ` : `<span class="text-gray-400">Locked</span>`}
                        </td>
                    `;
                    tableBody.appendChild(row);
                    renderedBillIds.add(t.billId);

                } else {
                    // Handle Normal Single Entry
                    const row = document.createElement('tr');
                    const d = new Date(t.date);
                    const dateStr = `${d.getDate().toString().padStart(2,'0')}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getFullYear()}`;
                    
                    row.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap text-xs font-medium text-gray-900">
                            ${dateStr}
                            <div class="text-gray-400 text-[10px]">${t.sourceDest}</div>
                        </td>
                        <td class="px-3 py-3 text-xs text-gray-500 break-words">
                            <span class="font-bold text-gray-700">${t.itemType}</span><br>
                            ${t.quantity} ркиркВркЧ x ${t.rate}
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-xs text-right font-bold ${type === 'income' ? 'text-emerald-600' : 'text-red-600'}">
                            ${formatCurrency(t.amount)}
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-xs text-center flex justify-center items-center space-x-1">
                            ${!isPreviewMode ? `
                            <button onclick="editTransaction('${t.id}')" class="text-indigo-600 hover:text-indigo-900 p-1 rounded hover:bg-indigo-50" title="рк╕рлБркзрк╛рк░рлЛ">тЬПя╕П</button>
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50" title="ркбрк┐рк▓рлАркЯ">ЁЯЧСя╕П</button>
                            ` : `<span class="text-gray-400">Locked</span>`}
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        };

        const renderStockSummary = (data) => {
            const summary = {};
            data.forEach(t => {
                if (!summary[t.itemType]) summary[t.itemType] = { in: 0, out: 0 };
                if (t.type === 'income') summary[t.itemType].in += t.quantity;
                else summary[t.itemType].out += t.quantity;
            });
            const tbody = els.summary.itemBody;
            tbody.innerHTML = '';
            if(Object.keys(summary).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">ркорк╛рк╣рк┐ркдрлА ркиркерлА</td></tr>';
                return;
            }
            Object.keys(summary).forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-xs font-medium text-gray-900">${item}</td>
                    <td class="px-4 py-3 text-right text-xs text-emerald-600 font-bold">${summary[item].in > 0 ? summary[item].in : '-'}</td>
                    <td class="px-4 py-3 text-right text-xs text-red-600 font-bold">${summary[item].out > 0 ? summary[item].out : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        };

        const renderMonthlyAnalysis = (data) => {
            const analysis = {};
            data.forEach(t => {
                const m = t.date.substring(0, 7);
                if (!analysis[m]) analysis[m] = { inc: 0, exp: 0 };
                if (t.type === 'income') analysis[m].inc += t.amount;
                else analysis[m].exp += t.amount;
            });
            let maxInc = { val: 0, m: 'N/A' }, minInc = { val: Infinity, m: 'N/A' };
            let maxExp = { val: 0, m: 'N/A' }, minExp = { val: Infinity, m: 'N/A' };
            Object.keys(analysis).forEach(m => {
                const a = analysis[m];
                if(a.inc > 0) {
                    if (a.inc > maxInc.val) { maxInc.val = a.inc; maxInc.m = m; }
                    if (a.inc < minInc.val) { minInc.val = a.inc; minInc.m = m; }
                }
                if(a.exp > 0) {
                    if (a.exp > maxExp.val) { maxExp.val = a.exp; maxExp.m = m; }
                    if (a.exp < minExp.val) { minExp.val = a.exp; minExp.m = m; }
                }
            });
            const formatM = (ys) => {
                if (ys === 'N/A') return 'N/A';
                const [y, m] = ys.split('-');
                return `${GUJARATI_MONTHS[parseInt(m)-1]} ${y}`;
            };
            if(minInc.val === Infinity) minInc.val = 0;
            if(minExp.val === Infinity) minExp.val = 0;

            els.summary.monthly.maxIncM.innerText = formatM(maxInc.m);
            els.summary.monthly.maxIncA.innerText = formatCurrency(maxInc.val);
            els.summary.monthly.minIncM.innerText = formatM(minInc.m);
            els.summary.monthly.minIncA.innerText = formatCurrency(minInc.val);
            els.summary.monthly.maxExpM.innerText = formatM(maxExp.m);
            els.summary.monthly.maxExpA.innerText = formatCurrency(maxExp.val);
            els.summary.monthly.minExpM.innerText = formatM(minExp.m);
            els.summary.monthly.minExpA.innerText = formatCurrency(minExp.val);
        };

        // --- CRUD Operations ---
        els.form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (isPreviewMode) return;
            const transaction = {
                id: editingTransactionId || generateId(),
                date: els.inputs.date.value,
                itemType: els.inputs.itemType.value,
                quantity: parseFloat(els.inputs.quantity.value),
                rate: parseFloat(els.inputs.rate.value),
                amount: parseFloat(els.inputs.amountHidden.value),
                sourceDest: els.inputs.sourceDest.value,
                type: els.inputs.type.value
            };
            if (editingTransactionId) {
                const index = allTransactionsData.findIndex(t => t.id === editingTransactionId);
                if (index !== -1) allTransactionsData[index] = transaction;
                showStatus("рк╡рлНркпрк╡рк╣рк╛рк░ рк╕рлБркзрк╛рк░рк╛ркИ ркЧркпрлЛ!");
                editingTransactionId = null;
                els.buttons.submit.textContent = "ркЙркорлЗрк░рлЛ";
                els.buttons.submit.classList.replace('bg-blue-600', 'bg-emerald-600');
                els.buttons.submit.classList.replace('hover:bg-blue-700', 'hover:bg-emerald-700');
                els.buttons.cancel.classList.add('hidden');
                document.getElementById('form-title').innerText = "ркирк╡рлЛ рк╡рлНркпрк╡рк╣рк╛рк░ (Add Transaction)";
            } else {
                allTransactionsData.push(transaction);
                showStatus("рк╡рлНркпрк╡рк╣рк╛рк░ ркЙркорлЗрк░рк╛ркИ ркЧркпрлЛ!");
            }
            saveData();
            renderAll();
            els.form.reset();
            document.getElementById('total-amount-display').value = "тВ╣ 0";
            document.getElementById('date').valueAsDate = new Date();
        });

        window.editTransaction = (id) => {
            switchMode('single');
            const t = allTransactionsData.find(x => x.id === id);
            if (!t) return;
            els.inputs.date.value = t.date;
            els.inputs.itemType.value = t.itemType;
            els.inputs.quantity.value = t.quantity;
            els.inputs.rate.value = t.rate;
            els.inputs.sourceDest.value = t.sourceDest;
            els.inputs.type.value = t.type;
            calculateTotal();
            toggleSourceDest();
            editingTransactionId = id;
            els.buttons.submit.textContent = "рк╕рлБркзрк╛рк░рлЛ (Update)";
            els.buttons.submit.classList.replace('bg-emerald-600', 'bg-blue-600');
            els.buttons.submit.classList.replace('hover:bg-emerald-700', 'hover:bg-blue-700');
            els.buttons.cancel.classList.remove('hidden');
            document.getElementById('form-title').innerText = "рк╡рлНркпрк╡рк╣рк╛рк░ рк╕рлБркзрк╛рк░рлЛ (Edit Transaction)";
            els.form.scrollIntoView({ behavior: 'smooth' });
        };

        window.deleteTransaction = (id) => {
            if (confirm("рк╢рлБркВ ркдркорлЗ ркЖ рк╡рлНркпрк╡рк╣рк╛рк░ ркбрк┐рк▓рлАркЯ ркХрк░рк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?")) {
                allTransactionsData = allTransactionsData.filter(t => t.id !== id);
                saveData();
                renderAll();
                showStatus("рк╡рлНркпрк╡рк╣рк╛рк░ ркбрк┐рк▓рлАркЯ ркХрк░рлНркпрлЛ.", 'error');
            }
        };
        
        // NEW: Function to delete entire bill
        window.deleteBill = (billId) => {
             if (confirm("ркЖркЦрлБркВ ркмрк┐рк▓ (ркмркзрлА рк╡рк╕рлНркдрлБркУ) ркбрк┐рк▓рлАркЯ ркерк╢рлЗ. ркЖркЧрк│ рк╡ркзрк╡рлБркВ ркЫрлЗ?")) {
                allTransactionsData = allTransactionsData.filter(t => t.billId !== billId);
                saveData();
                renderAll();
                showStatus("ркЖркЦрлБркВ ркмрк┐рк▓ ркбрк┐рк▓рлАркЯ ркХрк░рлНркпрлБркВ.", 'error');
            }
        };

        // NEW: View Bill Detail Logic
        window.viewBill = (billId) => {
            const billItems = allTransactionsData.filter(t => t.billId === billId);
            if(billItems.length === 0) return;

            const tbody = document.getElementById('bill-modal-body');
            tbody.innerHTML = '';
            let grandTotal = 0;

            // Get first item for metadata
            const first = billItems[0];
            const d = new Date(first.date);
            const dateStr = `${d.getDate().toString().padStart(2,'0')}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getFullYear()}`;
            
            document.getElementById('bill-modal-title').innerText = `ркмрк┐рк▓: ${first.sourceDest}`;
            document.getElementById('bill-modal-subtitle').innerText = `ркдрк╛рк░рлАркЦ: ${dateStr} | рккрлНрк░ркХрк╛рк░: ${first.type === 'income' ? 'ркЖрк╡ркХ' : 'ркЦрк░рлНркЪ'}`;

            billItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="px-4 py-2 text-sm font-medium text-gray-900">${item.itemType}</td>
                    <td class="px-4 py-2 text-sm text-right text-gray-600">${item.quantity}</td>
                    <td class="px-4 py-2 text-sm text-right text-gray-600">${item.rate}</td>
                    <td class="px-4 py-2 text-sm text-right font-bold text-emerald-600">${formatCurrency(item.amount)}</td>
                `;
                tbody.appendChild(tr);
                grandTotal += item.amount;
            });

            document.getElementById('bill-modal-total').innerText = formatCurrency(grandTotal);
            document.getElementById('bill-modal').classList.remove('hidden');
        };

        window.closeBillModal = () => {
            document.getElementById('bill-modal').classList.add('hidden');
        };

        // === NEW: Daily Report Functions ===
        window.openDailyReport = () => {
            document.getElementById('daily-report-modal').classList.remove('hidden');
            // Default to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('report-date').value = today;
            renderDailyReport();
        };

        window.closeDailyReport = () => {
            document.getElementById('daily-report-modal').classList.add('hidden');
        };

        window.renderDailyReport = () => {
            const date = document.getElementById('report-date').value;
            if(!date) return;

            const tbody = document.getElementById('daily-report-body');
            const totalQtyEl = document.getElementById('daily-report-total-qty');
            const totalAmountEl = document.getElementById('daily-report-total-amount'); // New element
            
            tbody.innerHTML = '';
            
            // Filter: Selected Date AND Income Type
            const data = allTransactionsData.filter(t => t.date === date && t.type === 'income');

            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="px-4 py-3 text-center text-gray-500">ркХрлЛркИ рк╡рлЗркЪрк╛ркг ркбрлЗркЯрк╛ ркорк│рлНркпрлЛ ркиркерлА.</td></tr>';
                totalQtyEl.innerText = '0';
                totalAmountEl.innerText = formatCurrency(0);
                return;
            }

            // Aggregate Data by Item Type
            const summary = {};
            let grandTotalQty = 0;
            let grandTotalAmount = 0;

            data.forEach(t => {
                if(!summary[t.itemType]) summary[t.itemType] = 0;
                summary[t.itemType] += t.quantity;
                grandTotalQty += t.quantity;
                grandTotalAmount += t.amount;
            });

            // Render Table
            Object.keys(summary).forEach(itemType => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${itemType}</td>
                    <td class="px-4 py-3 text-right text-sm font-bold text-emerald-600">${summary[itemType]}</td>
                `;
                tbody.appendChild(tr);
            });

            totalQtyEl.innerText = grandTotalQty;
            totalAmountEl.innerText = formatCurrency(grandTotalAmount);
        };

        els.buttons.cancel.addEventListener('click', () => {
            editingTransactionId = null;
            els.form.reset();
            calculateTotal();
            els.buttons.submit.textContent = "ркЙркорлЗрк░рлЛ";
            els.buttons.submit.classList.replace('bg-blue-600', 'bg-emerald-600');
            els.buttons.submit.classList.replace('hover:bg-blue-700', 'hover:bg-emerald-700');
            els.buttons.cancel.classList.add('hidden');
            document.getElementById('form-title').innerText = "ркирк╡рлЛ рк╡рлНркпрк╡рк╣рк╛рк░ (Add Transaction)";
            document.getElementById('date').valueAsDate = new Date();
        });

        // --- Event Listeners ---
        els.inputs.quantity.addEventListener('input', calculateTotal);
        els.inputs.rate.addEventListener('input', calculateTotal);
        els.inputs.type.addEventListener('change', toggleSourceDest);
        els.inputs.search.addEventListener('input', renderAll);
        els.filter.type.addEventListener('change', updateFilterInputs);
        els.bulk.type.addEventListener('change', () => {
            const label = document.getElementById('bulk-source-label');
            if(els.bulk.type.value === 'expense') {
                label.textContent = "ркХрлЛркирлЗ ркЪрлВркХрк╡рлНркпрк╛";
                els.bulk.source.placeholder = "ркХрлЛркирлЗ ркЪрлВркХрк╡рлНркпрк╛?";
            } else {
                label.textContent = "ркХрлЛркирлЗ ркЖрккрлНркпрлБркВ";
                els.bulk.source.placeholder = "ркХрлЛркирлЗ ркЖрккрлНркпрлБркВ?";
            }
        });

        document.getElementById('date').valueAsDate = new Date();
        updateFilterInputs();
        loadData();
    </script>
</body>
</html>
