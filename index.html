<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ркирк╡ркЬрлАрк╡рки рккрк╢рлБркЖрк╣рк╛рк░ - рк╣рк┐рк╕рк╛ркм</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ркХрк╕рлНркЯрко CSS */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            width: 100%;
        }
        /* ркХрк╕рлНркЯрко рк╕рлНркХрлНрк░рлЛрк▓ркмрк╛рк░ */
        .transaction-table-body::-webkit-scrollbar {
            width: 8px;
        }
        .transaction-table-body::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        /* ркорлЛркЯрк╛ ркЗркирккрлБркЯ ркорк╛ркЯрлЗ рк╕рлНркЯрк╛ркЗрк▓ */
        .large-input {
            padding: 0.75rem; 
            border-color: #9ca3af; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        /* рк░рк┐рк╕рлНрккрлЛркирлНрк╕рк┐рк╡ ркЯрлЗркмрк▓ рклрк┐ркХрлНрк╕ */
        @media (min-width: 768px) {
            .table-container {
                display: table;
                table-layout: fixed;
                width: 100%;
            }
            .table-container thead, .table-container tbody {
                display: table-row-group;
            }
            .transaction-table-body {
                display: table-row-group;
                max-height: none;
                overflow-y: visible;
            }
        }
        /* ркЯрлНрк░рк╛ркирлНркЭрлЗркХрлНрк╢рки ркмрлЛркбрлА ркорк╛ркЯрлЗ ркорк╣ркдрлНркдрко ркКркВркЪрк╛ркИ ркорлЛркмрк╛ркЗрк▓ рккрк░ */
        .transaction-table-body {
            max-height: 400px;
            overflow-y: auto;
            display: block; /* ркорлЛркмрк╛ркИрк▓ ркорк╛ркЯрлЗ */
        }
        /* ркорлЛркмрк╛ркИрк▓ ркорк╛ркЯрлЗ рк╣рлЗркбрк░ ркЕркирлЗ рк░рлЛ рклрк┐ркХрлНрк╕ */
        thead tr, tbody tr {
             display: table;
             width: 100%;
             table-layout: fixed;
        }
    </style>
</head>
<body>
    <div class="container bg-white p-6 md:p-10 rounded-xl shadow-2xl relative">
        
        <!-- Preview Mode Banner -->
        <div id="preview-banner" class="hidden mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded shadow-md sticky top-0 z-50">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-3 md:mb-0">
                    <p class="font-bold text-lg flex items-center"><span class="text-2xl mr-2">тЪая╕П</span> рклрк╛ркИрк▓ рккрлНрк░рк┐рк╡рлНркпрлБ (Preview Mode)</p>
                    <p class="text-sm mt-1">ркдркорлЗ ркЕрккрк▓рлЛркб ркХрк░рлЗрк▓рлА рклрк╛ркИрк▓ ркЬрлЛркИ рк░рк╣рлНркпрк╛ ркЫрлЛ. ркдркорк╛рк░рлЛ <b>ркЬрлВркирлЛ ркбрлЗркЯрк╛ рк╣ркЬрлБ рк╕рлБрк░ркХрлНрк╖рк┐ркд ркЫрлЗ.</b></p>
                </div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                    <!-- Cancel Button -->
                    <button onclick="cancelImport()" class="flex items-center justify-center bg-white text-red-600 font-bold py-2 px-4 border-2 border-red-200 rounded-lg shadow hover:bg-red-50 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        рк░ркж ркХрк░рлЛ (ркЬрлВркирлЛ ркбрлЗркЯрк╛ ркмркдрк╛рк╡рлЛ)
                    </button>
                    <!-- Save Button -->
                    <button onclick="confirmImport()" class="flex items-center justify-center bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-emerald-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        ркЬрлВркирк╛ ркбрлЗркЯрк╛ркорк╛ркВ ркЙркорлЗрк░рлЛ (Merge & Save)
                    </button>
                </div>
            </div>
        </div>

        <header class="mb-8 border-b-4 border-emerald-500 pb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center">
                ркирк╡ркЬрлАрк╡рки рккрк╢рлБркЖрк╣рк╛рк░ (Kh─Бt─Б P┼Нth─л)
            </h1>
            <p class="text-center text-sm text-gray-600 mt-1">ркСрклрк▓рк╛ркЗрки ркЖрк╡ркХ ркЕркирлЗ ркЦрк░рлНркЪркирлЛ рк╣рк┐рк╕рк╛ркм (Offline Income & Expense Tracker)</p>
        </header>

        <!-- ркбрлЗркЯрк╛ ркорлЗркирлЗркЬркорлЗркирлНркЯ -->
        <section class="mb-8 p-6 bg-indigo-50 rounded-xl border border-indigo-200 shadow-md">
            <h2 class="text-lg font-bold mb-3 text-indigo-900 flex items-center justify-between">
                <span class="flex items-center"><span class="text-xl mr-2">ЁЯТ╛</span> ркбрлЗркЯрк╛ ркорлЗркирлЗркЬркорлЗркирлНркЯ (Data Backup)</span>
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <button onclick="exportData()" class="flex justify-center items-center px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow">
                    <span class="mr-2">тмЗя╕П</span> ркбрлЗркЯрк╛ ркбрк╛ркЙркирк▓рлЛркб
                </button>
                <label class="flex justify-center items-center px-4 py-3 bg-white border-2 border-indigo-300 border-dashed hover:border-indigo-500 text-indigo-700 font-semibold rounded-lg shadow cursor-pointer">
                    <span class="mr-2">тмЖя╕П</span> ркбрлЗркЯрк╛ ркЕрккрк▓рлЛркб
                    <input type="file" accept=".json" class="hidden" onchange="importData(this)">
                </label>
                <button onclick="resetFile()" class="flex justify-center items-center px-4 py-3 bg-orange-100 hover:bg-orange-200 text-orange-800 border border-orange-300 font-semibold rounded-lg shadow">
                    <span class="mr-2">ЁЯФД</span> рклрк╛ркИрк▓ рк░рк┐рк╕рлЗркЯ ркХрк░рлЛ
                </button>
                <!-- Undo Button (Hidden initially) -->
                <button id="undo-button" onclick="restoreBackup()" class="hidden flex justify-center items-center px-4 py-3 bg-green-100 hover:bg-green-200 text-green-800 border border-green-300 font-semibold rounded-lg shadow animate-pulse">
                    <span class="mr-2">тЖйя╕П</span> Undo (ркбрлЗркЯрк╛ рккрк╛ркЫрлЛ рк▓рк╛рк╡рлЛ)
                </button>
            </div>
        </section>

        <!-- ркПркбрк╡рк╛ркирлНрк╕ рклрк┐рк▓рлНркЯрк░ ркЕркирлЗ рк╕рк░рлНркЪ (NEW FEATURE) -->
        <section class="mb-8 p-4 bg-yellow-50 rounded-xl border border-yellow-200 shadow-md">
            <h2 class="text-lg font-semibold mb-3 text-yellow-800">рк╣рк┐рк╕рк╛ркм рк╢рлЛркзрлЛ ркЕркирлЗ рклрк┐рк▓рлНркЯрк░ ркХрк░рлЛ (Search & Filter)</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-12 gap-4 items-end">
                <!-- рк╕рк░рлНркЪ ркмрк╛рк░ -->
                <div class="sm:col-span-4">
                    <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">ркирк╛рко ркХрлЗ рк╡рк┐ркЧркд рк╢рлЛркзрлЛ (Search)</label>
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="ркжрк╛.ркд. рк░ркорлЗрк╢ркнрк╛ркИ, ркоркХрк╛ркИ..." 
                               class="w-full large-input border rounded-lg focus:ring-yellow-500 focus:border-yellow-500 pl-10">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- рклрк┐рк▓рлНркЯрк░ рккрлНрк░ркХрк╛рк░ -->
                <div class="sm:col-span-3">
                    <label for="filter-type" class="block text-sm font-medium text-gray-700 mb-1">рк╕ркоркпркЧрк╛рк│рлЛ (Duration)</label>
                    <select id="filter-type" class="w-full large-input border rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-white">
                        <option value="all">ркмркзрлЛ рк╕ркоркп (All Time)</option>
                        <option value="monthly">ркорк╣рк┐ркирк╛ ркорлБркЬркм (Monthly)</option>
                        <option value="yearly">рк╡рк░рлНрк╖ ркорлБркЬркм (Yearly)</option>
                        <option value="custom">ркдрк╛рк░рлАркЦ рк░рлЗркирлНркЬ (Custom Date)</option>
                    </select>
                </div>
                
                <!-- ркдрк╛рк░рлАркЦ ркЗркирккрлБркЯрлНрк╕ (Dynamic) -->
                <div class="sm:col-span-5" id="date-inputs-container">
                    <!-- ркЕрк╣рлАркВ JavaScript ркерлА ркЗркирккрлБркЯ ркЖрк╡рк╢рлЗ -->
                    <label class="block text-sm font-medium text-gray-700 mb-1">ркдрк╛рк░рлАркЦ (Date)</label>
                    <input type="month" id="filter-date-month" class="w-full large-input border rounded-lg disabled:bg-gray-100" disabled>
                </div>
            </div>
            
            <!-- Custom Date Range Inputs (Hidden by default, moved via JS) -->
            <div id="custom-date-template" class="hidden grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-xs text-gray-500">ркерлА (From)</label>
                    <input type="date" id="filter-start-date" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-xs text-gray-500">рк╕рлБркзрлА (To)</label>
                    <input type="date" id="filter-end-date" class="w-full p-2 border rounded-lg">
                </div>
            </div>
        </section>

        <!-- рк╕рк╛рк░рк╛ркВрк╢ рк╡рк┐ркнрк╛ркЧ -->
        <section id="summary" class="mb-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="bg-emerald-100 p-4 rounded-lg shadow-md text-center">
                <p class="text-sm font-semibold text-emerald-700">ркХрлБрк▓ ркЖрк╡ркХ</p>
                <p id="total-income" class="text-2xl font-bold text-emerald-600 mt-1">тВ╣ 0.00</p>
            </div>
            <div class="bg-red-100 p-4 rounded-lg shadow-md text-center">
                <p class="text-sm font-semibold text-red-700">ркХрлБрк▓ ркЦрк░рлНркЪ</p>
                <p id="total-expense" class="text-2xl font-bold text-red-600 mt-1">тВ╣ 0.00</p>
            </div>
            <div class="bg-blue-100 p-4 rounded-lg shadow-md text-center">
                <p class="text-sm font-semibold text-blue-700">ркЪрлЛркЦрлНркЦрлБркВ ркмрлЗрк▓рлЗркирлНрк╕</p>
                <p id="net-balance" class="text-2xl font-bold text-blue-600 mt-1">тВ╣ 0.00</p>
            </div>
        </section>
        
        <!-- ркорк╛рк╕рк┐ркХ рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг -->
        <section class="mb-8 p-6 bg-blue-50 rounded-xl border border-blue-200 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-blue-800 border-b pb-2">ркорк╛рк╕рк┐ркХ рккрлНрк░ркжрк░рлНрк╢рки (Monthly Analysis)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-4 rounded-lg shadow-md border border-emerald-300">
                    <h3 class="text-lg font-bold text-emerald-700 mb-2">ркЖрк╡ркХ (Income)</h3>
                    <p class="text-sm text-gray-700">рк╡ркзрлБ: <span id="max-income-month" class="font-semibold">N/A</span> (<span id="max-income-amount" class="font-bold">тВ╣ 0</span>)</p>
                    <p class="text-sm text-gray-700">ркУркЫрлА: <span id="min-income-month" class="font-semibold">N/A</span> (<span id="min-income-amount" class="font-bold">тВ╣ 0</span>)</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md border border-red-300">
                    <h3 class="text-lg font-bold text-red-700 mb-2">ркЦрк░рлНркЪ (Expense)</h3>
                    <p class="text-sm text-gray-700">рк╡ркзрлБ: <span id="max-expense-month" class="font-semibold">N/A</span> (<span id="max-expense-amount" class="font-bold">тВ╣ 0</span>)</p>
                    <p class="text-sm text-gray-700">ркУркЫрлЛ: <span id="min-expense-month" class="font-semibold">N/A</span> (<span id="min-expense-amount" class="font-bold">тВ╣ 0</span>)</p>
                </div>
            </div>
        </section>

        <!-- рк╡рк╕рлНркдрлБ ркорлБркЬркм рк╕рк╛рк░рк╛ркВрк╢ -->
        <section class="mb-10 p-6 bg-purple-50 rounded-xl border border-purple-200 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-purple-800 border-b pb-2">рк╕рлНркЯрлЛркХ рк╕ркорк░рлА (Stock Summary)</h2>
            <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200 bg-white">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-purple-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-purple-900">рк╡рк╕рлНркдрлБ</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-emerald-700">ркЖрк╡ркХ ркЬркерлНркерлЛ</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-red-700">ркЦрк░рлНркЪ ркЬркерлНркерлЛ</th>
                        </tr>
                    </thead>
                    <tbody id="item-summary-body" class="divide-y divide-gray-100">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">ркорк╛рк╣рк┐ркдрлА ркиркерлА</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- рклрлЛрк░рлНрко -->
        <section class="mb-10 p-6 bg-gray-50 rounded-xl border border-gray-200 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-700" id="form-title">ркирк╡рлЛ рк╡рлНркпрк╡рк╣рк╛рк░ (Add Transaction)</h2>
            <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-8 gap-4 items-end">
                <div class="md:col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">ркдрк╛рк░рлАркЦ</label>
                    <input type="date" id="date" required class="w-full large-input border rounded-lg">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">рккрлНрк░ркХрк╛рк░</label>
                    <select id="item-type" required class="w-full large-input border rounded-lg bg-white">
                        <option value="" disabled selected>рккрк╕ркВркж ркХрк░рлЛ</option>
                        <option value="ркоркХрк╛ркИ рккрк╛рккркбрлА">ркоркХрк╛ркИ рккрк╛рккркбрлА</option>
                        <option value="ркоркХрк╛ркИ ркнрк░ркбрлЛ">ркоркХрк╛ркИ ркнрк░ркбрлЛ</option>
                        <option value="рккрк╛рккркбрлА">рккрк╛рккркбрлА</option>
                        <option value="ркЬрк╡ ркнрк░ркбрлЛ">ркЬрк╡ ркнрк░ркбрлЛ</option>
                        <option value="рк╕рлЛркпрк╛ркмрлАрки">рк╕рлЛркпрк╛ркмрлАрки</option>
                        <option value="ркдрлБрк╡рлЗрк░ркЪрлБркирлА">ркдрлБрк╡рлЗрк░ркЪрлБркирлА</option>
                        <option value="рккрк╢рлБ ркЖрк╣рк╛рк░">рккрк╢рлБ ркЖрк╣рк╛рк░</option>
                        <option value="рк▓рк╛рк▓рлА">рк▓рк╛рк▓рлА</option>
                        <option value="ркжрк╛ркг">ркжрк╛ркг</option>
                        <option value="ркЕркирлНркп">ркЕркирлНркп</option>
                    </select>
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">ркмрлЛрк░рлА</label>
                    <input type="number" id="quantity" placeholder="0" required min="1" class="w-full large-input border rounded-lg">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">ркнрк╛рк╡</label>
                    <input type="number" id="rate" placeholder="0.00" required min="0.01" step="0.01" class="w-full large-input border rounded-lg">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">ркХрлБрк▓</label>
                    <input type="text" id="total-amount-display" value="тВ╣ 0" readonly class="w-full large-input border rounded-lg bg-gray-200 font-bold">
                    <input type="hidden" id="amount-hidden">
                </div>
                <div class="md:col-span-1" id="source-destination-group">
                    <label class="block text-xs font-medium text-gray-700 mb-1">ркХрлЛркирлЗ/ркХрлНркпрк╛ркВркерлА?</label>
                    <input type="text" id="source-destination" placeholder="ркирк╛рко" required class="w-full large-input border rounded-lg">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">рк╡рлНркпрк╡рк╣рк╛рк░</label>
                    <select id="type" required class="w-full large-input border rounded-lg bg-white">
                        <option value="income">ркЖрк╡ркХ</option>
                        <option value="expense">ркЦрк░рлНркЪ</option>
                    </select>
                </div>
                <div class="md:col-span-1">
                    <button type="submit" id="submit-button" class="w-full bg-emerald-600 text-white font-bold py-3 px-2 rounded-xl shadow hover:bg-emerald-700 text-sm">ркЙркорлЗрк░рлЛ</button>
                    <button type="button" id="cancel-edit-button" class="w-full bg-gray-400 text-white font-bold py-3 px-2 rounded-xl shadow mt-2 hidden text-sm">рк░ркжрлНркж</button>
                </div>
            </form>
            <p id="status-message" class="text-center text-sm mt-3 font-semibold"></p>
        </section>

        <!-- ркпрк╛ркжрлАркУ -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ркЖрк╡ркХ -->
            <div id="income-section">
                <h2 class="text-xl font-semibold mb-4 text-emerald-700 border-b pb-2">ркЖрк╡ркХ (Income)</h2>
                <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-200 table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-emerald-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 w-1/4">ркдрк╛рк░рлАркЦ</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 w-2/4">рк╡рк┐ркЧркд</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 w-1/4">рк░ркХрко</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500">Action</th>
                            </tr>
                        </thead>
                        <tbody id="income-list-body" class="bg-white divide-y divide-gray-100 transaction-table-body"></tbody>
                    </table>
                </div>
                <p id="no-income" class="text-center text-gray-500 mt-4 hidden">ркбрлЗркЯрк╛ ркиркерлА.</p>
            </div>
            <!-- ркЦрк░рлНркЪ -->
            <div id="expense-section">
                <h2 class="text-xl font-semibold mb-4 text-red-700 border-b pb-2">ркЦрк░рлНркЪ (Expense)</h2>
                 <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-200 table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-red-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 w-1/4">ркдрк╛рк░рлАркЦ</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 w-2/4">рк╡рк┐ркЧркд</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 w-1/4">рк░ркХрко</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500">Action</th>
                            </tr>
                        </thead>
                        <tbody id="expense-list-body" class="bg-white divide-y divide-gray-100 transaction-table-body"></tbody>
                    </table>
                </div>
                <p id="no-expense" class="text-center text-gray-500 mt-4 hidden">ркбрлЗркЯрк╛ ркиркерлА.</p>
            </div>
        </section>
    </div>

    <script>
        // --- Constants & State ---
        const STORAGE_KEY = 'khataPothiTransactions';
        const BACKUP_KEY = 'khataPothiTempBackup';
        const GUJARATI_MONTHS = ["ркЬрк╛ркирлНркпрлБркЖрк░рлА", "рклрлЗркмрлНрк░рлБркЖрк░рлА", "ркорк╛рк░рлНркЪ", "ркПрккрлНрк░рк┐рк▓", "ркорлЗ", "ркЬрлВрки", "ркЬрлБрк▓рк╛ркИ", "ркУркЧрк╕рлНркЯ", "рк╕рккрлНркЯрлЗркорлНркмрк░", "ркУркХрлНркЯрлЛркмрк░", "ркирк╡рлЗркорлНркмрк░", "ркбрк┐рк╕рлЗркорлНркмрк░"];
        
        let allTransactionsData = [];
        let tempImportedData = []; // To store imported data temporarily for preview
        let editingTransactionId = null; 
        let isPreviewMode = false;

        // --- DOM Elements ---
        const els = {
            form: document.getElementById('transaction-form'),
            inputs: {
                date: document.getElementById('date'),
                itemType: document.getElementById('item-type'),
                quantity: document.getElementById('quantity'),
                rate: document.getElementById('rate'),
                totalDisplay: document.getElementById('total-amount-display'),
                amountHidden: document.getElementById('amount-hidden'),
                type: document.getElementById('type'),
                sourceDest: document.getElementById('source-destination'),
                sourceDestGroup: document.getElementById('source-destination-group'),
                search: document.getElementById('search-input')
            },
            buttons: {
                submit: document.getElementById('submit-button'),
                cancel: document.getElementById('cancel-edit-button'),
                undo: document.getElementById('undo-button')
            },
            summary: {
                income: document.getElementById('total-income'),
                expense: document.getElementById('total-expense'),
                balance: document.getElementById('net-balance'),
                itemBody: document.getElementById('item-summary-body'),
                monthly: {
                    maxIncM: document.getElementById('max-income-month'),
                    maxIncA: document.getElementById('max-income-amount'),
                    minIncM: document.getElementById('min-income-month'),
                    minIncA: document.getElementById('min-income-amount'),
                    maxExpM: document.getElementById('max-expense-month'),
                    maxExpA: document.getElementById('max-expense-amount'),
                    minExpM: document.getElementById('min-expense-month'),
                    minExpA: document.getElementById('min-expense-amount')
                }
            },
            lists: {
                income: document.getElementById('income-list-body'),
                expense: document.getElementById('expense-list-body'),
                noIncome: document.getElementById('no-income'),
                noExpense: document.getElementById('no-expense')
            },
            filter: {
                type: document.getElementById('filter-type'),
                container: document.getElementById('date-inputs-container'),
                statusMsg: document.getElementById('status-message')
            },
            preview: {
                banner: document.getElementById('preview-banner')
            }
        };

        // --- Helper Functions ---
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);
        
        const showStatus = (msg, type = 'success') => {
            els.filter.statusMsg.textContent = msg;
            els.filter.statusMsg.className = `text-center text-sm mt-3 font-semibold ${type === 'error' ? 'text-red-600' : 'text-emerald-600'}`;
            setTimeout(() => els.filter.statusMsg.textContent = '', 5000);
        };

        const formatCurrency = (amt) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }).format(amt || 0);

        const calculateTotal = () => {
            const q = parseFloat(els.inputs.quantity.value) || 0;
            const r = parseFloat(els.inputs.rate.value) || 0;
            const total = (q * r).toFixed(2);
            els.inputs.totalDisplay.value = formatCurrency(total);
            els.inputs.amountHidden.value = total;
        };

        const toggleSourceDest = () => {
            if (els.inputs.type.value === 'expense') {
                els.inputs.sourceDestGroup.classList.remove('hidden');
                els.inputs.sourceDest.required = true;
                els.inputs.sourceDest.placeholder = "ркХрлЛркирлЗ ркЪрлВркХрк╡рлНркпрк╛?";
            } else {
                els.inputs.sourceDestGroup.classList.add('hidden');
                els.inputs.sourceDest.required = false;
                if (!editingTransactionId) els.inputs.sourceDest.value = '';
            }
        };

        // --- Data Management ---
        const loadData = () => {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                allTransactionsData = data ? JSON.parse(data) : [];
                // Ensure numbers are numbers
                allTransactionsData = allTransactionsData.map(t => ({...t, amount: parseFloat(t.amount), quantity: parseInt(t.quantity)}));
            } catch (e) { console.error(e); allTransactionsData = []; }
            renderAll();
        };

        const saveData = () => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allTransactionsData));
        };

        const exportData = () => {
            let dataToExport = [...allTransactionsData];
            let filenameSuffix = 'All';

            // Check for Monthly Filter
            const type = els.filter.type.value;
            if (type === 'monthly') {
                const val = document.getElementById('filter-date-dynamic')?.value; // YYYY-MM
                if(val) {
                    dataToExport = dataToExport.filter(t => t.date.startsWith(val));
                    filenameSuffix = val;
                }
            } else if (type === 'yearly') {
                 const val = document.getElementById('filter-date-dynamic')?.value;
                 if(val) {
                    dataToExport = dataToExport.filter(t => t.date.startsWith(val));
                    filenameSuffix = val;
                 }
            }

            if(!dataToExport.length) return showStatus("ркбрк╛ркЙркирк▓рлЛркб ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ ркХрлЛркИ ркбрлЗркЯрк╛ ркиркерлА.", 'error');

            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Navjivan_Data_${filenameSuffix}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showStatus(`рклрк╛ркИрк▓ ркбрк╛ркЙркирк▓рлЛркб ркеркИ! (${filenameSuffix})`);
        };

        const resetFile = () => {
            if(confirm("рк╢рлБркВ ркдркорлЗ ркЦрк╛ркдрк╛ркирлА рклрк╛ркИрк▓ рк░рк┐рк╕рлЗркЯ ркХрк░рк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?\n\nркЖркирк╛ркерлА ркЕркдрлНркпрк╛рк░ркирлЛ ркмркзрлЛ ркбрлЗркЯрк╛ ркЬркдрлЛ рк░рк╣рлЗрк╢рлЗ ркЕркирлЗ ркирк╡рлБркВ ркХрлЛрк░рлБркВ ркЦрк╛ркдрлБркВ рк╢рк░рлВ ркерк╢рлЗ.")) {
                // 1. Save Backup
                localStorage.setItem(BACKUP_KEY, JSON.stringify(allTransactionsData));
                
                // 2. Clear Main Data
                localStorage.removeItem(STORAGE_KEY);
                allTransactionsData = [];
                loadData();
                
                // 3. Show Undo Button
                els.buttons.undo.classList.remove('hidden');
                
                showStatus("рклрк╛ркИрк▓ рк░рк┐рк╕рлЗркЯ ркеркИ ркЧркИ. ркЬрлВркирлЛ ркбрлЗркЯрк╛ 'Undo' ркмркЯркиркерлА рккрк╛ркЫрлЛ рк▓рк╛рк╡рлА рк╢ркХрк╛рк╢рлЗ.");
            }
        };

        const restoreBackup = () => {
            const backup = localStorage.getItem(BACKUP_KEY);
            if(backup) {
                if(confirm("рк╢рлБркВ ркдркорлЗ рк░рк┐рк╕рлЗркЯ ркХрк░рлЗрк▓рлЛ ркбрлЗркЯрк╛ рккрк╛ркЫрлЛ рк▓рк╛рк╡рк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?")) {
                    allTransactionsData = JSON.parse(backup);
                    saveData();
                    renderAll();
                    els.buttons.undo.classList.add('hidden'); // Hide after restore
                    showStatus("ркЬрлВркирлЛ ркбрлЗркЯрк╛ рккрк╛ркЫрлЛ ркЖрк╡рлА ркЧркпрлЛ!");
                }
            } else {
                showStatus("ркХрлЛркИ ркмрлЗркХркЕркк ркбрлЗркЯрк╛ ркорк│рлНркпрлЛ ркиркерлА.", 'error');
            }
        };

        const importData = (input) => {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data)) {
                        isPreviewMode = true;
                        tempImportedData = data; // Store temporarily
                        
                        // Render the preview (imported data only)
                        // NOTE: We render tempImportedData but DO NOT save it to allTransactionsData yet
                        renderDataList(tempImportedData); 
                        
                        els.preview.banner.classList.remove('hidden');
                        els.inputs.submit.disabled = true; // Disable adding in preview
                        showStatus("рккрлНрк░рк┐рк╡рлНркпрлБ ркорлЛркб ркЪрк╛рк▓рлБ ркЫрлЗ. ркЖ ркбрлЗркЯрк╛ ркорк╛ркдрлНрк░ ркЬрлЛрк╡рк╛ ркорк╛ркЯрлЗ ркЫрлЗ.");
                    } else showStatus("ркЦрлЛркЯрлА рклрк╛ркИрк▓ ркЫрлЗ.", 'error');
                } catch(err) { showStatus("рклрк╛ркИрк▓ рк╡рк╛ркВркЪрлА рк╢ркХрк╛ркИ ркиркерлА.", 'error'); }
                input.value = '';
            };
            reader.readAsText(input.files[0]);
        };

        const confirmImport = () => {
            if(confirm("ркЖ ркбрлЗркЯрк╛ ркдркорк╛рк░рк╛ ркЬрлВркирк╛ ркбрлЗркЯрк╛ркорк╛ркВ ркЙркорлЗрк░рк╛рк╢рлЗ (Merge). рк╢рлБркВ ркдркорлЗ ркЖркЧрк│ рк╡ркзрк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ?")) {
                // Merge Logic
                // We use a Map to avoid exact duplicates based on ID
                const mergedMap = new Map();
                
                // 1. Add existing data
                allTransactionsData.forEach(item => mergedMap.set(item.id, item));
                
                // 2. Add/Overwrite with imported data
                // If you prefer to KEEP old data on conflict, switch the order. 
                // Here we assume imported data might have updates, or just new data.
                // If we just want to append new IDs:
                tempImportedData.forEach(item => {
                    // Only add if ID doesn't exist, OR regenerate ID if you want to allow duplicates.
                    // To properly merge without deleting old unique entries:
                    mergedMap.set(item.id, item);
                });

                allTransactionsData = Array.from(mergedMap.values());
                
                // Sort again
                allTransactionsData.sort((a,b) => new Date(b.date) - new Date(a.date));

                saveData();
                isPreviewMode = false;
                tempImportedData = [];
                els.preview.banner.classList.add('hidden');
                els.inputs.submit.disabled = false;
                
                renderAll(); // Re-render the merged data
                showStatus("ркбрлЗркЯрк╛ рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркорк░рлНркЬ (Merge) ркеркИ ркЧркпрлЛ!");
            }
        };

        const cancelImport = () => {
            // Just re-render the original allTransactionsData
            renderAll();
            isPreviewMode = false;
            tempImportedData = [];
            els.preview.banner.classList.add('hidden');
            els.inputs.submit.disabled = false;
            showStatus("ркУрк░рлАркЬрлАркирк▓ ркбрлЗркЯрк╛ рккрк╛ркЫрлЛ ркЖрк╡рлА ркЧркпрлЛ.");
        };

        // --- Filter Logic ---
        const updateFilterInputs = () => {
            const type = els.filter.type.value;
            els.filter.container.innerHTML = ''; // Clear

            if (type === 'all') {
                els.filter.container.innerHTML = `<label class="block text-sm font-medium text-gray-700 mb-1">ркдрк╛рк░рлАркЦ</label><input type="text" disabled value="ркмркзрлЛ ркбрлЗркЯрк╛" class="w-full large-input border rounded-lg bg-gray-100 text-gray-500">`;
            } else if (type === 'monthly') {
                els.filter.container.innerHTML = `<label class="block text-sm font-medium text-gray-700 mb-1">ркорк╣рк┐ркирлЛ</label><input type="month" id="filter-date-dynamic" class="w-full large-input border rounded-lg">`;
                document.getElementById('filter-date-dynamic').value = new Date().toISOString().slice(0,7);
                document.getElementById('filter-date-dynamic').addEventListener('change', renderAll);
            } else if (type === 'yearly') {
                els.filter.container.innerHTML = `<label class="block text-sm font-medium text-gray-700 mb-1">рк╡рк░рлНрк╖</label><input type="number" id="filter-date-dynamic" min="2000" max="2100" class="w-full large-input border rounded-lg">`;
                document.getElementById('filter-date-dynamic').value = new Date().getFullYear();
                document.getElementById('filter-date-dynamic').addEventListener('input', renderAll);
            } else if (type === 'custom') {
                const template = document.getElementById('custom-date-template').cloneNode(true);
                template.classList.remove('hidden');
                template.id = '';
                els.filter.container.appendChild(template);
                template.querySelector('#filter-start-date').addEventListener('change', renderAll);
                template.querySelector('#filter-end-date').addEventListener('change', renderAll);
            }
            renderAll();
        };

        // --- Rendering ---
        // Modified to accept data argument so we can reuse it for preview
        const renderDataList = (dataSet) => {
            let filtered = [...dataSet];
            
            if (!isPreviewMode) {
                 // 1. Apply Search
                const searchTerm = els.inputs.search.value.toLowerCase();
                if(searchTerm) {
                    filtered = filtered.filter(t => 
                        t.itemType.toLowerCase().includes(searchTerm) || 
                        (t.sourceDestination && t.sourceDestination.toLowerCase().includes(searchTerm)) ||
                        t.amount.toString().includes(searchTerm)
                    );
                }

                // 2. Apply Date Filter
                const type = els.filter.type.value;
                if(type === 'monthly') {
                    const val = document.getElementById('filter-date-dynamic')?.value;
                    if(val) filtered = filtered.filter(t => t.date.startsWith(val));
                } else if (type === 'yearly') {
                    const val = document.getElementById('filter-date-dynamic')?.value;
                    if(val) filtered = filtered.filter(t => t.date.startsWith(val));
                } else if (type === 'custom') {
                    const start = els.filter.container.querySelector('#filter-start-date')?.value;
                    const end = els.filter.container.querySelector('#filter-end-date')?.value;
                    if(start) filtered = filtered.filter(t => t.date >= start);
                    if(end) filtered = filtered.filter(t => t.date <= end);
                }
            }

            // Split Data
            const incomeData = filtered.filter(t => t.type === 'income');
            const expenseData = filtered.filter(t => t.type === 'expense');

            // Render Tables
            renderTable(incomeData, els.lists.income, els.lists.noIncome);
            renderTable(expenseData, els.lists.expense, els.lists.noExpense);

            // Render Summaries
            renderSummaryStats(filtered);
        }

        const renderAll = () => {
            renderDataList(allTransactionsData);
        };

        const renderTable = (data, tbody, noDataMsg) => {
            tbody.innerHTML = '';
            if(!data.length) {
                noDataMsg.classList.remove('hidden');
                return;
            }
            noDataMsg.classList.add('hidden');
            data.forEach(item => {
                const row = document.createElement('tr');
                const dateParts = item.date.split('-');
                const displayDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                const color = item.type === 'income' ? 'text-emerald-600' : 'text-red-600';
                
                row.innerHTML = `
                    <td class="px-3 py-3 text-sm text-gray-600 align-top">${displayDate}</td>
                    <td class="px-3 py-3 text-sm text-gray-700 align-top">
                        <div class="font-bold">${item.itemType}</div>
                        <div class="text-xs text-gray-500">${item.quantity} ркмрлЛрк░рлА x ${item.rate}</div>
                        ${item.sourceDestination ? `<div class="text-xs italic text-gray-500 mt-1">To/From: ${item.sourceDestination}</div>` : ''}
                    </td>
                    <td class="px-3 py-3 text-right text-sm font-bold ${color} align-top">${formatCurrency(item.amount)}</td>
                    <td class="px-3 py-3 text-center text-sm font-medium align-top">
                        <button onclick="editItem('${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2 ${isPreviewMode ? 'opacity-50 pointer-events-none' : ''}">тЬО</button>
                        <button onclick="deleteItem('${item.id}')" class="text-red-600 hover:text-red-900 ${isPreviewMode ? 'opacity-50 pointer-events-none' : ''}">тЬЦ</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        };

        const renderSummaryStats = (data) => {
            let inc = 0, exp = 0;
            const items = {};
            const months = {};

            data.forEach(t => {
                if(t.type === 'income') inc += t.amount;
                else exp += t.amount;

                // Item Stock
                if(!items[t.itemType]) items[t.itemType] = {i:0, e:0};
                if(t.type === 'income') items[t.itemType].i += t.quantity;
                else items[t.itemType].e += t.quantity;

                // Monthly Stats
                const m = t.date.slice(0,7);
                if(!months[m]) months[m] = {i:0, e:0};
                if(t.type === 'income') months[m].i += t.amount;
                else months[m].e += t.amount;
            });

            els.summary.income.textContent = formatCurrency(inc);
            els.summary.expense.textContent = formatCurrency(exp);
            const net = inc - exp;
            els.summary.balance.textContent = formatCurrency(net);
            els.summary.balance.className = `text-2xl font-bold mt-1 ${net >= 0 ? 'text-blue-600' : 'text-red-600'}`;

            // Items Table
            els.summary.itemBody.innerHTML = '';
            Object.keys(items).sort().forEach(k => {
                if(items[k].i > 0 || items[k].e > 0) {
                    els.summary.itemBody.innerHTML += `
                        <tr>
                            <td class="px-4 py-2 text-sm font-medium text-gray-900">${k}</td>
                            <td class="px-4 py-2 text-right text-sm text-emerald-700 font-bold">${items[k].i}</td>
                            <td class="px-4 py-2 text-right text-sm text-red-700 font-bold">${items[k].e}</td>
                        </tr>
                    `;
                }
            });
            if(!els.summary.itemBody.innerHTML) els.summary.itemBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">ркорк╛рк╣рк┐ркдрлА ркиркерлА</td></tr>';

            // Monthly Analysis (Simple Max/Min calculation)
            let maxI = -1, minI = Infinity, maxE = -1, minE = Infinity;
            let maxIM = 'N/A', minIM = 'N/A', maxEM = 'N/A', minEM = 'N/A';

            Object.keys(months).forEach(m => {
                if(months[m].i > maxI) { maxI = months[m].i; maxIM = m; }
                if(months[m].i < minI && months[m].i > 0) { minI = months[m].i; minIM = m; }
                if(months[m].e > maxE) { maxE = months[m].e; maxEM = m; }
                if(months[m].e < minE && months[m].e > 0) { minE = months[m].e; minEM = m; }
            });

            const fmtM = (ym) => {
                if(ym === 'N/A') return ym;
                const [y, m] = ym.split('-');
                return `${GUJARATI_MONTHS[parseInt(m)-1]} ${y}`;
            };

            els.summary.monthly.maxIncM.textContent = fmtM(maxIM); els.summary.monthly.maxIncA.textContent = formatCurrency(maxI > -1 ? maxI : 0);
            els.summary.monthly.minIncM.textContent = fmtM(minIM); els.summary.monthly.minIncA.textContent = formatCurrency(minI !== Infinity ? minI : 0);
            els.summary.monthly.maxExpM.textContent = fmtM(maxEM); els.summary.monthly.maxExpA.textContent = formatCurrency(maxE > -1 ? maxE : 0);
            els.summary.monthly.minExpM.textContent = fmtM(minEM); els.summary.monthly.minExpA.textContent = formatCurrency(minE !== Infinity ? minE : 0);
        };

        // --- CRUD Operations ---
        const handleForm = (e) => {
            e.preventDefault();
            if(isPreviewMode) return;

            const raw = {
                date: els.inputs.date.value,
                itemType: els.inputs.itemType.value,
                quantity: parseInt(els.inputs.quantity.value),
                rate: parseFloat(els.inputs.rate.value),
                amount: parseFloat(els.inputs.amountHidden.value),
                type: els.inputs.type.value,
                sourceDestination: els.inputs.sourceDest.value
            };

            if(!raw.date || !raw.itemType || isNaN(raw.quantity) || isNaN(raw.rate)) {
                return showStatus("ркмркзрлА рк╡рк┐ркЧркд ркнрк░рлЛ.", 'error');
            }

            if(editingTransactionId) {
                const idx = allTransactionsData.findIndex(t => t.id === editingTransactionId);
                if(idx > -1) {
                    allTransactionsData[idx] = { ...raw, id: editingTransactionId };
                    showStatus("ркЕрккркбрлЗркЯ ркеркИ ркЧркпрлБркВ!");
                }
            } else {
                allTransactionsData.push({ ...raw, id: generateId() });
                showStatus("ркЙркорлЗрк░рк╛ркИ ркЧркпрлБркВ!");
            }

            allTransactionsData.sort((a,b) => new Date(b.date) - new Date(a.date));
            saveData();
            resetForm();
            renderAll();
        };

        const editItem = (id) => {
            if(isPreviewMode) return;
            const t = allTransactionsData.find(x => x.id === id);
            if(!t) return;
            editingTransactionId = id;
            els.inputs.date.value = t.date;
            els.inputs.itemType.value = t.itemType;
            els.inputs.quantity.value = t.quantity;
            els.inputs.rate.value = t.rate;
            els.inputs.type.value = t.type;
            toggleSourceDest();
            els.inputs.sourceDest.value = t.sourceDestination || '';
            calculateTotal();
            
            els.buttons.submit.textContent = "ркЕрккркбрлЗркЯ ркХрк░рлЛ";
            els.buttons.submit.classList.replace('bg-emerald-600', 'bg-blue-600');
            els.buttons.cancel.classList.remove('hidden');
            document.getElementById('form-title').textContent = "ркПркбрк┐ркЯ ркХрк░рлЛ";
            els.form.scrollIntoView({behavior:'smooth'});
        };

        const deleteItem = (id) => {
            if(isPreviewMode) return;
            if(confirm("ркбрк┐рк▓рлАркЯ ркХрк░рк╡рлБркВ ркЫрлЗ?")) {
                allTransactionsData = allTransactionsData.filter(x => x.id !== id);
                saveData();
                renderAll();
                showStatus("ркбрк┐рк▓рлАркЯ ркеркИ ркЧркпрлБркВ.");
            }
        };

        const resetForm = () => {
            els.form.reset();
            els.inputs.date.value = new Date().toISOString().split('T')[0];
            editingTransactionId = null;
            els.buttons.submit.textContent = "ркЙркорлЗрк░рлЛ";
            els.buttons.submit.classList.replace('bg-blue-600', 'bg-emerald-600');
            els.buttons.cancel.classList.add('hidden');
            document.getElementById('form-title').textContent = "ркирк╡рлЛ рк╡рлНркпрк╡рк╣рк╛рк░";
            calculateTotal();
            toggleSourceDest();
        };

        // --- Init ---
        els.inputs.quantity.addEventListener('input', calculateTotal);
        els.inputs.rate.addEventListener('input', calculateTotal);
        els.inputs.type.addEventListener('change', toggleSourceDest);
        els.form.addEventListener('submit', handleForm);
        els.buttons.cancel.addEventListener('click', resetForm);
        
        els.filter.type.addEventListener('change', updateFilterInputs);
        els.inputs.search.addEventListener('input', renderAll);

        // Check if backup exists on load (optional but good UX)
        if(localStorage.getItem(BACKUP_KEY)) {
             els.buttons.undo.classList.remove('hidden');
        }

        // Start
        loadData();
        resetForm();
        updateFilterInputs();

    </script>
</body>
</html>
