
<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>નવજીવન પશુઆહાર   હિસાબ</title>
    <!-- Tailwind CSS ને લોડ કરો -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* કસ્ટમ CSS */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            width: 100%;
        }
        /* કસ્ટમ સ્ક્રોલબાર */
        .transaction-table-body::-webkit-scrollbar {
            width: 8px;
        }
        .transaction-table-body::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        /* મોટા ઇનપુટ માટે સ્ટાઇલ */
        .large-input {
            padding: 0.75rem; 
            border-color: #9ca3af; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        /* રિસ્પોન્સિવ ટેબલ ફિક્સ */
        @media (min-width: 768px) {
            .table-container {
                display: table;
                table-layout: fixed;
                width: 100%;
            }
            .table-container thead, .table-container tbody {
                display: table-row-group;
            }
            .transaction-table-body {
                display: table-row-group;
                max-height: none;
                overflow-y: visible;
            }
        }
        /* ટ્રાન્ઝેક્શન બોડી માટે મહત્તમ ઊંચાઈ */
        .transaction-table-body {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <header class="mb-8 border-b-4 border-emerald-500 pb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center">
                નવજીવન પશુઆહાર (Khātā Pōthī)
            </h1>
            <p class="text-center text-sm text-gray-600 mt-1">ઑફલાઇન આવક અને ખર્ચનો હિસાબ (Offline Income & Expense Tracker)</p>
            <p class="text-center text-xs mt-3 p-1 bg-gray-100 rounded-lg text-red-500 font-semibold">
                નોંધ: આ ડેટા માત્ર તમારા બ્રાઉઝર (Local Storage) માં જ સેવ થાય છે.
            </p>
        </header>

        <!-- ફિલ્ટર કંટ્રોલ્સ -->
        <section class="mb-8 p-4 bg-yellow-50 rounded-xl border border-yellow-200 shadow-md">
            <h2 class="text-lg font-semibold mb-3 text-yellow-800">હિસાબ ફિલ્ટર કરો (Filter Account)</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                 <!-- ફિલ્ટર પ્રકાર -->
                <div>
                    <label for="filter-type" class="block text-sm font-medium text-gray-700 mb-1">ફિલ્ટર પ્રકાર (Filter Type)</label>
                    <select id="filter-type" class="w-full large-input border rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-white">
                        <option value="all">બધા વ્યવહારો (All Transactions)</option>
                        <option value="monthly">માસિક હિસાબ (Monthly Account)</option>
                        <option value="yearly">વાર્ષિક હિસાબ (Yearly Account)</option>
                    </select>
                </div>
                
                <!-- ફિલ્ટર તારીખ ઇનપુટ -->
                <div class="sm:col-span-2">
                    <label for="filter-date" class="block text-sm font-medium text-gray-700 mb-1" id="filter-date-label">તારીખ પસંદ કરો (Select Date)</label>
                    <input type="month" id="filter-date" class="w-full large-input border rounded-lg focus:ring-yellow-500 focus:border-yellow-500" disabled>
                </div>
            </div>
        </section>

        <!-- સારાંશ વિભાગ (Summary Section) -->
        <section id="summary" class="mb-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
            <!-- કુલ આવક -->
            <div class="bg-emerald-100 p-4 rounded-lg shadow-md text-center">
                <p class="text-sm font-semibold text-emerald-700">કુલ આવક (Total Income)</p>
                <p id="total-income" class="text-2xl font-bold text-emerald-600 mt-1">₹ 0.00</p>
            </div>
            <!-- કુલ ખર્ચ -->
            <div class="bg-red-100 p-4 rounded-lg shadow-md text-center">
                <p class="text-sm font-semibold text-red-700">કુલ ખર્ચ (Total Expense)</p>
                <p id="total-expense" class="text-2xl font-bold text-red-600 mt-1">₹ 0.00</p>
            </div>
            <!-- ચોખ્ખું બેલેન્સ -->
            <div class="bg-blue-100 p-4 rounded-lg shadow-md text-center">
                <p class="text-sm font-semibold text-blue-700">ચોખ્ખું બેલેન્સ (Net Balance)</p>
                <p id="net-balance" class="text-2xl font-bold text-blue-600 mt-1">₹ 0.00</p>
            </div>
        </section>
        
        <!-- માસિક વિશ્લેષણ વિભાગ -->
        <section class="mb-10 p-6 bg-blue-50 rounded-xl border border-blue-200 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-blue-800 border-b pb-2">માસિક પ્રદર્શન વિશ્લેષણ (Monthly Performance Analysis)</h2>
            <div id="monthly-analysis-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- આવક વિશ્લેષણ -->
                <div class="bg-white p-4 rounded-lg shadow-md border border-emerald-300">
                    <h3 class="text-lg font-bold text-emerald-700 mb-2">આવક વિશ્લેષણ (Income Analysis)</h3>
                    <p class="text-sm mb-1 text-gray-700">સૌથી વધુ આવક: <span id="max-income-month" class="font-semibold text-emerald-600">N/A</span> (<span id="max-income-amount" class="font-bold text-emerald-600">₹ 0.00</span>)</p>
                    <p class="text-sm text-gray-700">સૌથી ઓછી આવક: <span id="min-income-month" class="font-semibold text-red-600">N/A</span> (<span id="min-income-amount" class="font-bold text-red-600">₹ 0.00</span>)</p>
                </div>
                
                <!-- ખર્ચ વિશ્લેષણ -->
                <div class="bg-white p-4 rounded-lg shadow-md border border-red-300">
                    <h3 class="text-lg font-bold text-red-700 mb-2">ખર્ચ વિશ્લેષણ (Expense Analysis)</h3>
                    <p class="text-sm mb-1 text-gray-700">સૌથી વધુ ખર્ચ: <span id="max-expense-month" class="font-semibold text-red-600">N/A</span> (<span id="max-expense-amount" class="font-bold text-red-600">₹ 0.00</span>)</p>
                    <p class="text-sm text-gray-700">સૌથી ઓછો ખર્ચ: <span id="min-expense-month" class="font-semibold text-emerald-600">N/A</span> (<span id="min-expense-amount" class="font-bold text-emerald-600">₹ 0.00</span>)</p>
                </div>
            </div>
        </section>

        <!-- વ્યવહાર ઉમેરો/એડિટ કરો ફોર્મ -->
        <section class="mb-10 p-6 bg-gray-50 rounded-xl border border-gray-200 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-700" id="form-title">નવો વ્યવહાર ઉમેરો (Add New Transaction)</h2>
            <!-- form માં autofocus ઉમેર્યો છે અને enter કી હેન્ડલ કરવા માટે logic ઉમેરાયો છે -->
            <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-8 gap-4 items-end">
                
                <!-- તારીખ -->
                <div class="md:col-span-1">
                    <label for="date" class="block text-sm font-medium text-gray-700 mb-1">તારીખ (Date)</label>
                    <input type="date" id="date" required autofocus
                           class="w-full large-input border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <!-- આઇટમનો પ્રકાર (ખોનનો પ્રકાર - Dropdown) -->
                <div class="md:col-span-1">
                    <label for="item-type" class="block text-sm font-medium text-gray-700 mb-1">ખોનનો પ્રકાર (Item Type)</label>
                    <select id="item-type" required 
                            class="w-full large-input border rounded-lg focus:ring-emerald-500 focus:border-emerald-500 bg-white">
                        <option value="" disabled selected>પસંદ કરો</option>
                        <option value="મકાઈ પાપડી">મકાઈ પાપડી (Makai Papadi)</option>
                        <option value="મકાઈ ભરડો">મકાઈ ભરડો (Makai Bhardo)</option>
                        <option value="પાપડી">પાપડી (Papadi)</option>
                        <option value="જવ ભરડો">જવ ભરડો (Jav Bhardo)</option>
                        <option value="સોયાબીન">સોયાબીન (Soyabean)</option>
			 <option value="તુવેરચુની ">તુવેરચુની (Tuverchuni)</option>
                        <option value="પશુ આહાર">પશુ આહાર (Pashu Aahar)</option>
                        <option value="લાલી">લાલી (Lali)</option>
                        <option value="દાણ">દાણ (Daan)</option>
                        <option value="અન્ય">અન્ય (Other)</option>
                    </select>
                </div>
                
                <!-- જથ્થો (કેટલી બોરી) -->
                <div class="md:col-span-1">
                    <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">બોરી (Quantity)</label>
                    <input type="number" id="quantity" placeholder="સંખ્યા" required min="1" step="1" 
                           class="w-full large-input border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <!-- દર (બોરીનો ભાવ) -->
                <div class="md:col-span-1">
                    <label for="rate" class="block text-sm font-medium text-gray-700 mb-1">બોરીનો ભાવ (Rate)</label>
                    <input type="number" id="rate" placeholder="ભાવ/Rate" required min="0.01" step="0.01" 
                           class="w-full large-input border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                 
                 <!-- કુલ રકમ (Calculated) -->
                <div class="md:col-span-1">
                    <label for="total-amount-display" class="block text-sm font-medium text-gray-700 mb-1">કુલ રકમ (Total)</label>
                    <input type="text" id="total-amount-display" value="₹ 0.00" readonly 
                           class="w-full large-input border rounded-lg bg-gray-200 font-bold text-gray-700">
                    <input type="hidden" id="amount-hidden" name="amount"> <!-- ગણતરી કરેલ રકમ સાચવવા માટેનું છુપાયેલું ક્ષેત્ર -->
                </div>
                
                <!-- સ્ત્રોત/ગંતવ્ય (Source/Destination) -->
                <div class="md:col-span-1" id="source-destination-group">
                    <label for="source-destination" class="block text-sm font-medium text-gray-700 mb-1">ક્યાંથી/કોને? (S/D)</label>
                    <input type="text" id="source-destination" placeholder="વેપારીનું નામ" required 
                           class="w-full large-input border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <!-- વ્યવહાર પ્રકાર -->
                <div class="md:col-span-1">
                    <label for="type" class="block text-sm font-medium text-gray-700 mb-1">વ્યવહાર પ્રકાર (Type)</label>
                    <select id="type" required 
                            class="w-full large-input border rounded-lg focus:ring-emerald-500 focus:border-emerald-500 bg-white">
                        <option value="income">આવક (Income)</option>
                        <option value="expense">ખર્ચ (Expense)</option>
                    </select>
                </div>
                
                <!-- સબમિટ બટન -->
                <div class="md:col-span-1">
                    <button type="submit" id="submit-button"
                            class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-4 rounded-xl 
                                   transition duration-150 ease-in-out shadow-lg hover:shadow-xl transform hover:scale-105">
                        ઉમેરો (Add)
                    </button>
                    <!-- એડિટ રદ્દ કરો બટન -->
                    <button type="button" id="cancel-edit-button"
                            class="w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-4 rounded-xl 
                                   transition duration-150 ease-in-out shadow-lg transform hover:scale-105 mt-2 hidden">
                        રદ્દ કરો (Cancel)
                    </button>
                </div>
            </form>
            <p id="error-message" class="text-red-500 text-sm mt-3 hidden"></p>
            <p id="success-message" class="text-emerald-500 text-sm mt-3 hidden"></p>
        </section>

        <!-- ટ્રાન્ઝેક્શન યાદીઓ -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- આવક યાદી વિભાગ -->
            <div id="income-section">
                <h2 class="text-xl font-semibold mb-4 text-emerald-700 border-b pb-2">આવકની યાદી (Income List)</h2>
                <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-200 table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-emerald-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">તારીખ</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">ખોનનો પ્રકાર</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">કુલ રકમ (₹)</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">કાર્યવાહી</th>
                            </tr>
                        </thead>
                        <tbody id="income-list-body" class="bg-white divide-y divide-gray-100 transaction-table-body">
                            <tr class="loading-row-income"><td colspan="4" class="py-4 text-center text-gray-500">લોડ થઈ રહ્યું છે...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="no-income" class="text-center text-gray-500 mt-4 hidden">કોઈ આવક વ્યવહાર મળ્યો નથી.</p>
            </div>

            <!-- ખર્ચ યાદી વિભાગ -->
            <div id="expense-section">
                <h2 class="text-xl font-semibold mb-4 text-red-700 border-b pb-2">ખર્ચની યાદી (Expense List)</h2>
                 <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-200 table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-red-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">તારીખ</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">ક્યાંથી/કોને?</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">કુલ રકમ (₹)</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">કાર્યવાહી</th>
                            </tr>
                        </thead>
                        <tbody id="expense-list-body" class="bg-white divide-y divide-gray-100 transaction-table-body">
                             <tr class="loading-row-expense"><td colspan="4" class="py-4 text-center text-gray-500">લોડ થઈ રહ્યું છે...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="no-expense" class="text-center text-gray-500 mt-4 hidden">કોઈ ખર્ચ વ્યવહાર મળ્યો નથી.</p>
            </div>
        </section>
    </div>

    <!-- JavaScript Logic (LocalStorage Based) -->
    <script>
        // --- કોન્સ્ટન્ટ્સ ---
        const STORAGE_KEY = 'khataPothiTransactions';
        const GUJARATI_MONTHS = ["જાન્યુઆરી", "ફેબ્રુઆરી", "માર્ચ", "એપ્રિલ", "મે", "જૂન", "જુલાઈ", "ઓગસ્ટ", "સપ્ટેમ્બર", "ઓક્ટોબર", "નવેમ્બર", "ડિસેમ્બર"];

        let allTransactionsData = []; // બધા ડેટા સ્ટોર કરવા માટે
        let editingTransactionId = null; 

        // --- HTML એલિમેન્ટ્સ ---
        const form = document.getElementById('transaction-form');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const netBalanceEl = document.getElementById('net-balance');
        const errorMessageEl = document.getElementById('error-message');
        const successMessageEl = document.getElementById('success-message');

        const dateInput = document.getElementById('date');
        const itemTypeInput = document.getElementById('item-type');
        const quantityInput = document.getElementById('quantity');
        const rateInput = document.getElementById('rate');
        const totalAmountDisplay = document.getElementById('total-amount-display');
        const amountHiddenInput = document.getElementById('amount-hidden');
        const typeInput = document.getElementById('type');
        const sourceDestinationInput = document.getElementById('source-destination');
        const sourceDestinationGroup = document.getElementById('source-destination-group');
        
        const submitButton = document.getElementById('submit-button');
        const cancelButton = document.getElementById('cancel-edit-button');
        const formTitle = document.getElementById('form-title');

        const incomeListBody = document.getElementById('income-list-body');
        const expenseListBody = document.getElementById('expense-list-body');
        const noIncomeEl = document.getElementById('no-income');
        const noExpenseEl = document.getElementById('no-expense');
        
        const filterTypeInput = document.getElementById('filter-type');
        const filterDateInput = document.getElementById('filter-date');
        const filterDateLabel = document.getElementById('filter-date-label');
        
        // વિશ્લેષણ એલિમેન્ટ્સ
        const maxIncomeMonthEl = document.getElementById('max-income-month');
        const maxIncomeAmountEl = document.getElementById('max-income-amount');
        const minIncomeMonthEl = document.getElementById('min-income-month');
        const minIncomeAmountEl = document.getElementById('min-income-amount');
        const maxExpenseMonthEl = document.getElementById('max-expense-month');
        const maxExpenseAmountEl = document.getElementById('max-expense-amount');
        const minExpenseMonthEl = document.getElementById('min-expense-month');
        const minExpenseAmountEl = document.getElementById('min-expense-amount');
        
        /**
         * રેન્ડમ ID જનરેટ કરવા માટેનું યુટિલિટી ફંક્શન
         */
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        /**
         * સ્ટેટસ મેસેજીસ દર્શાવવા માટેનું યુટિલિટી ફંક્શન.
         * @param {string} message - મેસેજ સામગ્રી.
         * @param {string} type - 'error' અથવા 'success'.
         */
        function showStatus(message, type = 'success') {
            errorMessageEl.classList.add('hidden');
            successMessageEl.classList.add('hidden');
            
            const targetEl = type === 'error' ? errorMessageEl : successMessageEl;
            targetEl.textContent = message;
            targetEl.classList.remove('hidden');

            setTimeout(() => {
                targetEl.classList.add('hidden');
            }, 3000);
        }

        /**
         * સ્ત્રોત/ગંતવ્ય ક્ષેત્રની દૃશ્યતા અને જરૂરી સ્થિતિને ટોગલ કરે છે.
         */
        function toggleSourceDestinationVisibility() {
            const isExpense = typeInput.value === 'expense';
            
            if (isExpense) {
                sourceDestinationGroup.classList.remove('hidden');
                sourceDestinationInput.required = true;
            } else {
                sourceDestinationGroup.classList.add('hidden');
                sourceDestinationInput.required = false;
                // આવક પસંદ કરવામાં આવે ત્યારે સ્ત્રોત/ગંતવ્ય સાફ કરો
                if (editingTransactionId === null) { 
                    sourceDestinationInput.value = ''; 
                }
            }
        }

        /**
         * પસંદ કરેલ ફિલ્ટર પ્રકારના આધારે ફિલ્ટર તારીખ ઇનપુટને સમાયોજિત કરે છે.
         */
        function updateFilterDateInput() {
            const filterType = filterTypeInput.value;
            
            filterDateInput.disabled = false;
            
            if (filterType === 'all') {
                filterDateInput.disabled = true;
                filterDateInput.type = 'month'; 
                filterDateInput.value = ''; 
                filterDateLabel.textContent = 'તારીખ પસંદ કરો (Select Date)';
            } else if (filterType === 'monthly') {
                filterDateInput.type = 'month';
                if (!filterDateInput.value) {
                    filterDateInput.value = new Date().toISOString().substring(0, 7); 
                }
                filterDateLabel.textContent = 'મહિનો પસંદ કરો (Select Month)';
            } else if (filterType === 'yearly') {
                filterDateInput.type = 'number'; // વર્ષ માટે નંબરનો ઉપયોગ
                filterDateInput.min = 2000;
                filterDateInput.max = 2099;
                if (!filterDateInput.value) {
                    filterDateInput.value = new Date().getFullYear();
                }
                filterDateLabel.textContent = 'વર્ષ પસંદ કરો (Select Year)';
            }
            
            // ઇનપુટ બદલાય ત્યારે ફિલ્ટર્સ ફરીથી લાગુ કરો
            applyFiltersAndRender();
        }

        /**
         * ફોર્મ અને એડિટિંગ સ્ટેટને રીસેટ કરે છે.
         */
        function resetFormState() {
            form.reset();
            dateInput.value = new Date().toISOString().substring(0, 10);
            calculateTotalAmount();
            editingTransactionId = null;
            
            // નવા વ્યવહાર માટે UI રીસેટ કરો
            submitButton.textContent = 'ઉમેરો (Add)';
            submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            submitButton.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
            cancelButton.classList.add('hidden');
            formTitle.textContent = 'નવો વ્યવહાર ઉમેરો (Add New Transaction)';

            toggleSourceDestinationVisibility(); // દૃશ્યતા ફરીથી તપાસો
            dateInput.focus(); // ઝડપી એન્ટ્રી માટે ફોકસ પાછું આપો
        }

        /**
         * એડિટિંગ સક્ષમ કરવા માટે ફોર્મમાં વ્યવહાર ડેટા ભરે છે.
         * @param {object} transaction - એડિટ કરવા માટેનો વ્યવહાર ઓબ્જેક્ટ.
         */
        function editTransaction(transaction) {
            editingTransactionId = transaction.id;

            dateInput.value = transaction.date;
            itemTypeInput.value = transaction.itemType;
            quantityInput.value = transaction.quantity;
            rateInput.value = transaction.rate;
            typeInput.value = transaction.type;
            
            sourceDestinationInput.value = transaction.sourceDestination || ''; 
            
            calculateTotalAmount(); // ભરેલા મૂલ્યોના આધારે કુલની ગણતરી કરો
            toggleSourceDestinationVisibility(); // નવા પ્રકારના આધારે દૃશ્યતા ટોગલ કરો

            // એડિટિંગ સ્ટેટ માટે UI અપડેટ કરો
            submitButton.textContent = 'અપડેટ કરો (Update)';
            submitButton.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
            submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            cancelButton.classList.remove('hidden');
            formTitle.textContent = `વ્યવહાર એડિટ કરો (Edit Transaction: ${transaction.id.substring(0, 4)}...)`;

            // ફોર્મ પર સ્ક્રોલ કરો અને ફોકસ આપો
            form.scrollIntoView({ behavior: 'smooth' });
            dateInput.focus();
        }


        /**
         * LocalStorage માંથી વ્યવહારો લોડ કરે છે.
         */
        function loadTransactions() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                allTransactionsData = data ? JSON.parse(data) : [];
                // ખાતરી કરો કે amount ફ્લોટ છે
                allTransactionsData = allTransactionsData.map(t => ({
                    ...t,
                    amount: parseFloat(t.amount)
                }));
                console.log("Transactions loaded from LocalStorage:", allTransactionsData.length);
            } catch (error) {
                console.error("Error loading transactions from localStorage:", error);
                showStatus("ડેટા લોડ કરવામાં ભૂલ આવી.", 'error');
                allTransactionsData = [];
            }
            // ડેટા લોડ થયા પછી ફિલ્ટર્સ લાગુ કરો અને રેન્ડર કરો
            applyFiltersAndRender();
        }

        /**
         * વ્યવહારોને LocalStorage માં સાચવે છે.
         */
        function saveTransactions() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allTransactionsData));
            } catch (error) {
                console.error("Error saving transactions to localStorage:", error);
                showStatus("ડેટા સેવ કરવામાં ભૂલ આવી. સ્ટોરેજ ભરેલો હોઈ શકે.", 'error');
            }
        }

        /**
         * કુલ રકમની ગણતરી કરે છે (જથ્થો * દર) અને ડિસ્પ્લે/છુપાયેલ ક્ષેત્રને અપડેટ કરે છે.
         */
        function calculateTotalAmount() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const rate = parseFloat(rateInput.value) || 0;
            
            const totalAmount = (quantity * rate).toFixed(2); 

            totalAmountDisplay.value = formatCurrency(totalAmount);
            amountHiddenInput.value = totalAmount; // ગણતરી કરેલ રકમ સ્ટોર કરો
        }

        /**
         * નવા વ્યવહારને સાચવવા અથવા હાલના વ્યવહારને અપડેટ કરવા માટે ફોર્મ સબમિશનને હેન્ડલ કરે છે.
         * @param {Event} e - ફોર્મ સબમિશન ઇવેન્ટ.
         */
        function handleFormSubmit(e) {
            e.preventDefault();
            errorMessageEl.classList.add('hidden');
            successMessageEl.classList.add('hidden');

            calculateTotalAmount(); 

            // --- ક્ષેત્રો પુનઃપ્રાપ્તિ ---
            const date = dateInput.value;
            const itemType = itemTypeInput.value ? itemTypeInput.value.trim() : '';
            const quantity = parseInt(quantityInput.value);
            const rate = parseFloat(rateInput.value);
            const totalAmount = parseFloat(amountHiddenInput.value);
            const type = typeInput.value;
            
            let sourceDestination = '';
            if (type === 'expense') {
                sourceDestination = sourceDestinationInput.value ? sourceDestinationInput.value.trim() : '';
                if (!sourceDestination) {
                    showStatus("ખર્ચ માટે 'ક્યાંથી/કોને?' (Source/Destination) ભરવું ફરજિયાત છે.", 'error');
                    return;
                }
            } else {
                sourceDestination = ''; 
            }
            
            // મૂળભૂત માન્યતા
            if (!date || !itemType || isNaN(quantity) || quantity <= 0 || isNaN(rate) || rate < 0 || isNaN(totalAmount) || totalAmount < 0) {
                showStatus("કૃપા કરીને બધી વિગતો યોગ્ય રીતે ભરો.", 'error');
                return;
            }

            const transactionData = {
                date: date,
                itemType: itemType,
                quantity: quantity,
                rate: rate,
                amount: totalAmount, // ફ્લોટ તરીકે સ્ટોર કરો
                type: type,
                sourceDestination: sourceDestination,
            };

            if (editingTransactionId) {
                // હાલના વ્યવહારને અપડેટ કરો
                const index = allTransactionsData.findIndex(t => t.id === editingTransactionId);
                if (index !== -1) {
                    allTransactionsData[index] = { ...allTransactionsData[index], ...transactionData };
                    showStatus("વ્યવહાર સફળતાપૂર્વક અપડેટ થયો. (Transaction updated successfully.)");
                }
            } else {
                // નવો વ્યવહાર ઉમેરો
                transactionData.id = generateId();
                transactionData.timestamp = Date.now();
                allTransactionsData.push(transactionData);
                showStatus("નવો વ્યવહાર સફળતાપૂર્વક ઉમેરાયો. (New transaction added successfully.)");
            }
            
            saveTransactions(); // LocalStorage માં સેવ કરો
            resetFormState(); // ફોર્મ અને સ્ટેટ સાફ કરો
            applyFiltersAndRender(); // UI અપડેટ કરો
        }

        /**
         * વ્યવહાર કાઢી નાખે છે.
         * @param {string} docId - વ્યવહાર ID.
         */
        function deleteTransaction(docId) {
            allTransactionsData = allTransactionsData.filter(t => t.id !== docId);
            saveTransactions();
            applyFiltersAndRender();
            showStatus("વ્યવહાર સફળતાપૂર્વક કાઢી નાખવામાં આવ્યો. (Transaction deleted successfully.)");
            
            // જો કાઢી નાખેલ વ્યવહાર એડિટિંગમાં હોય, તો ફોર્મને રીસેટ કરો
            if (editingTransactionId === docId) {
                resetFormState();
            }
        }

        /**
         * નંબરને ભારતીય રૂપિયા (INR) ફોર્મેટમાં ફોર્મેટ કરે છે.
         * @param {number|string} amount - ફોર્મેટ કરવા માટેની રકમ.
         * @returns {string} ફોર્મેટ કરેલ ચલણ સ્ટ્રિંગ.
         */
        function formatCurrency(amount) {
            const numAmount = typeof amount === 'number' ? amount : parseFloat(amount);
            if (isNaN(numAmount)) return '₹ 0.00';
            
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2
            }).format(numAmount);
        }
        
        /**
         * YYYY-MM સ્ટ્રિંગને ગુજરાતી મહિનાના નામ + વર્ષમાં રૂપાંતરિત કરે છે.
         * @param {string} ymString - YYYY-MM સ્ટ્રિંગ.
         * @returns {string} ગુજરાતીમાં ફોર્મેટ કરેલ મહિનો અને વર્ષ સ્ટ્રિંગ.
         */
        function formatMonthYear(ymString) {
            if (!ymString || ymString.length !== 7 || ymString.indexOf('-') !== 4) return ymString;
            const [year, monthIndexStr] = ymString.split('-');
            const monthIndex = parseInt(monthIndexStr, 10) - 1; // 0-ઇન્ડેક્સ
            
            if (monthIndex >= 0 && monthIndex < 12) {
                return `${GUJARATI_MONTHS[monthIndex]} ${year}`;
            }
            return ymString;
        }

        /**
         * સારાંશ વિભાગને અપડેટ કરે છે (આવક, ખર્ચ, બેલેન્સ).
         * @param {Array<object>} transactions - હાલમાં ફિલ્ટર કરેલા વ્યવહારોની સૂચિ.
         */
        function updateSummary(transactions) {
            let totalIncome = 0;
            let totalExpense = 0;

            transactions.forEach(t => {
                const amount = t.amount;
                
                if (!isNaN(amount)) {
                    if (t.type === 'income') {
                        totalIncome += amount;
                    } else if (t.type === 'expense') {
                        totalExpense += amount;
                    }
                }
            });

            const netBalance = totalIncome - totalExpense;

            totalIncomeEl.textContent = formatCurrency(totalIncome);
            totalExpenseEl.textContent = formatCurrency(totalExpense);
            netBalanceEl.textContent = formatCurrency(netBalance);
            
            const netBalanceParent = netBalanceEl.parentElement;
            
            // ક્લાસ રીસેટ કરો
            netBalanceParent.classList.remove('bg-red-100', 'bg-blue-100');
            netBalanceEl.classList.remove('text-red-600', 'text-blue-600');

            // નવા ક્લાસ લાગુ કરો
            if (netBalance >= 0) {
                netBalanceParent.classList.add('bg-blue-100');
                netBalanceEl.classList.add('text-blue-600');
            } else {
                netBalanceParent.classList.add('bg-red-100');
                netBalanceEl.classList.add('text-red-600');
            }
        }
        
        /**
         * ન્યૂનતમ/મહત્તમ આવક અને ખર્ચ સાથેનો મહિનો શોધવા માટે વિશ્લેષણ કરે છે.
         * @param {Array<object>} transactions - બધા વ્યવહારોની સંપૂર્ણ સૂચિ.
         */
        function performMonthlyAnalysis(transactions) {
            const monthlyData = {}; // સ્ટોર કરે છે { 'YYYY-MM': { income: 0, expense: 0 } }
            
            transactions.forEach(t => {
                const monthKey = t.date.substring(0, 7); 
                const amount = t.amount;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { income: 0, expense: 0 };
                }
                
                if (t.type === 'income') {
                    monthlyData[monthKey].income += amount;
                } else if (t.type === 'expense') {
                    monthlyData[monthKey].expense += amount;
                }
            });

            const months = Object.keys(monthlyData);
            if (months.length === 0) {
                // જો કોઈ વ્યવહાર ન હોય તો N/A પર રીસેટ કરો
                const defaultText = 'N/A';
                const defaultAmount = '₹ 0.00';
                
                maxIncomeMonthEl.textContent = defaultText;
                maxIncomeAmountEl.textContent = defaultAmount;
                minIncomeMonthEl.textContent = defaultText;
                minIncomeAmountEl.textContent = defaultAmount;
                maxExpenseMonthEl.textContent = defaultText;
                maxExpenseAmountEl.textContent = defaultAmount;
                minExpenseMonthEl.textContent = defaultText;
                minExpenseAmountEl.textContent = defaultAmount;
                return;
            }


            let maxIncome = { month: '', amount: -Infinity };
            let minIncome = { month: '', amount: Infinity };
            let maxExpense = { month: '', amount: -Infinity };
            let minExpense = { month: '', amount: Infinity };

            months.forEach(monthKey => {
                const data = monthlyData[monthKey];

                // આવક વિશ્લેષણ
                if (data.income > maxIncome.amount) {
                    maxIncome = { month: monthKey, amount: data.income };
                }
                if (data.income < minIncome.amount) {
                     minIncome = { month: monthKey, amount: data.income };
                }

                // ખર્ચ વિશ્લેષણ
                if (data.expense > maxExpense.amount) {
                    maxExpense = { month: monthKey, amount: data.expense };
                }
                if (data.expense < minExpense.amount) {
                    minExpense = { month: monthKey, amount: data.expense };
                }
            });
            
            // જો કોઈ ન્યૂનતમ મૂલ્ય ન મળે (કારણ કે બધા વ્યવહારો શૂન્ય છે અથવા માત્ર એક મહિનો છે), તો પ્રથમ મહિનાનો ઉપયોગ કરો.
             if (minIncome.amount === Infinity && months.length > 0) {
                 minIncome = { month: months[0], amount: monthlyData[months[0]].income };
            }
            if (minExpense.amount === Infinity && months.length > 0) {
                 minExpense = { month: months[0], amount: monthlyData[months[0]].expense };
            }

            // HTML વિશ્લેષણ વિભાગ અપડેટ કરો
            maxIncomeMonthEl.textContent = formatMonthYear(maxIncome.month);
            maxIncomeAmountEl.textContent = formatCurrency(maxIncome.amount);
            
            minIncomeMonthEl.textContent = formatMonthYear(minIncome.month);
            minIncomeAmountEl.textContent = formatCurrency(minIncome.amount);
            
            maxExpenseMonthEl.textContent = formatMonthYear(maxExpense.month);
            maxExpenseAmountEl.textContent = formatCurrency(maxExpense.amount);
            
            minExpenseMonthEl.textContent = formatMonthYear(minExpense.month);
            minExpenseAmountEl.textContent = formatCurrency(minExpense.amount);
        }

        /**
         * બધા વ્યવહારોની સૂચિમાં તારીખ ફિલ્ટર લાગુ કરે છે અને પછી રેન્ડર કરે છે.
         */
        function applyFiltersAndRender() {
            const filterType = filterTypeInput.value;
            const filterDate = filterDateInput.value;
            
            let filteredTransactions = allTransactionsData;

            if (filterType === 'monthly' && filterDate) {
                // filterDate એ 'YYYY-MM' છે
                filteredTransactions = allTransactionsData.filter(t => t.date.startsWith(filterDate));
            } else if (filterType === 'yearly' && filterDate) {
                // filterDate એ 'YYYY' છે
                filteredTransactions = allTransactionsData.filter(t => t.date.startsWith(filterDate));
            } else if (filterType === 'all') {
                // કોઈ ફિલ્ટર લાગુ નથી
                filteredTransactions = allTransactionsData;
            }

            // 1. સારાંશ અપડેટ કરો (ફિલ્ટર કરેલા ડેટા પર)
            updateSummary(filteredTransactions);
            
            // 2. યાદીઓ રેન્ડર કરો (ફિલ્ટર કરેલા ડેટા પર)
            renderTransactions(filteredTransactions);
            
            // 3. માસિક વિશ્લેષણ અપડેટ કરો (બધા ડેટા પર, ફિલ્ટર નહીં)
            performMonthlyAnalysis(allTransactionsData);
        }

        /**
         * ફિલ્ટર કરેલી આવક અને ખર્ચની યાદીઓ રેન્ડર કરે છે.
         * @param {Array<object>} filteredTransactions - તારીખ દ્વારા ફિલ્ટર કરાયેલા વ્યવહારો.
         */
        function renderTransactions(filteredTransactions) {
            
            // અલગ યાદીઓ
            const incomeTransactions = filteredTransactions.filter(t => t.type === 'income');
            const expenseTransactions = filteredTransactions.filter(t => t.type === 'expense');

            // તારીખ દ્વારા વ્યવહારોને સૉર્ટ કરો (નવીનતમ પ્રથમ)
            const sortFn = (a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA > dateB) return -1;
                if (dateA < dateB) return 1;
                return b.timestamp - a.timestamp; // જો તારીખ સમાન હોય તો ટાઇમસ્ટેમ્પ દ્વારા સૉર્ટ કરો
            };
            
            incomeTransactions.sort(sortFn);
            expenseTransactions.sort(sortFn);


            // --- આવક યાદી રેન્ડર કરો ---
            incomeListBody.innerHTML = '';
            if (incomeTransactions.length === 0) {
                noIncomeEl.classList.remove('hidden');
            } else {
                noIncomeEl.classList.add('hidden');
                incomeTransactions.forEach(t => {
                    incomeListBody.appendChild(createTransactionRow(t, 'income'));
                });
            }

            // --- ખર્ચ યાદી રેન્ડર કરો ---
            expenseListBody.innerHTML = '';
            if (expenseTransactions.length === 0) {
                noExpenseEl.classList.remove('hidden');
            } else {
                noExpenseEl.classList.add('hidden');
                expenseTransactions.forEach(t => {
                    expenseListBody.appendChild(createTransactionRow(t, 'expense'));
                });
            }

            // રેન્ડરિંગ પછી ઇવેન્ટ લિસનર્સ ફરીથી જોડો
            attachActionListeners();
        }

        /**
         * એક જ વ્યવહાર માટે HTML ટેબલ પંક્તિ બનાવે છે.
         * @param {object} t - વ્યવહાર ઓબ્જેક્ટ.
         * @param {string} listType - 'income' અથવા 'expense'.
         * @returns {HTMLElement} બનાવેલ ટેબલ પંક્તિ એલિમેન્ટ.
         */
        function createTransactionRow(t, listType) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition duration-100';

            const [year, month, day] = t.date.split('-');
            const formattedDate = `${day}/${month}/${year}`;
            
            // યાદી પ્રકાર માટે વિશિષ્ટ ડેટા
            let mainDetail = '';
            if (listType === 'income') {
                mainDetail = t.itemType || 'N/A'; // આવક માટે, આઇટમનો પ્રકાર દર્શાવો
            } else {
                mainDetail = t.sourceDestination || '-'; // ખર્ચ માટે, સ્ત્રોત/ગંતવ્ય દર્શાવો
            }

            row.innerHTML = `
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 w-1/5">${formattedDate}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-800 w-2/5">${mainDetail}</td> 
                <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-right ${listType === 'income' ? 'text-emerald-600' : 'text-red-600'} w-1/5">
                    ${formatCurrency(t.amount)}
                </td>
                <td class="px-3 py-3 whitespace-nowrap text-center text-sm font-medium space-x-2 w-1/5">
                    <!-- એડિટ બટન -->
                    <button class="text-blue-500 hover:text-blue-700 transition duration-150 ease-in-out edit-btn" data-id="${t.id}">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                         </svg>
                    </button>
                    <!-- ડિલીટ બટન -->
                    <button class="text-red-500 hover:text-red-700 transition duration-150 ease-in-out delete-btn" data-id="${t.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </td>
            `;
            // એડિટ માટે એલિમેન્ટ સાથે વ્યવહાર ડેટા જોડો
            row.transactionData = t;
            return row;
        }

        /**
         * બંને યાદીઓમાં ડિલીટ અને એડિટ બટનો માટે ઇવેન્ટ લિસનર્સ જોડે છે.
         */
        function attachActionListeners() {
            [incomeListBody, expenseListBody].forEach(listBody => {
                listBody.querySelectorAll('.delete-btn').forEach(button => {
                    button.onclick = (e) => {
                        deleteTransaction(e.currentTarget.getAttribute('data-id'));
                    };
                });
                
                listBody.querySelectorAll('.edit-btn').forEach(button => {
                    button.onclick = (e) => {
                        const row = e.currentTarget.closest('tr');
                        if (row && row.transactionData) {
                            editTransaction(row.transactionData);
                        }
                    };
                });
            });
        }


        // --- ઇવેન્ટ લિસનર્સ અને પ્રારંભિક સેટઅપ ---
        
        window.onload = () => {
             // ફોર્મ તારીખને આજની તારીખ પર સેટ કરો
             dateInput.value = new Date().toISOString().substring(0, 10);
             // ફિલ્ટર ઇનપુટ માટે પ્રારંભિક સેટઅપ
             updateFilterDateInput();
             // LocalStorage માંથી વ્યવહારો લોડ કરો
             loadTransactions(); 
             toggleSourceDestinationVisibility(); // Add ફોર્મ માટે પ્રારંભિક દૃશ્યતા તપાસ
        }

        // કુલ રકમની આપોઆપ ગણતરી કરવા માટે જથ્થા અથવા દરમાં ફેરફારો માટે સાંભળો
        quantityInput.addEventListener('input', calculateTotalAmount);
        rateInput.addEventListener('input', calculateTotalAmount);

        // સ્ત્રોત/ગંતવ્યની દૃશ્યતાને ટોગલ કરવા માટે પ્રકારમાં ફેરફારો માટે સાંભળો
        typeInput.addEventListener('change', toggleSourceDestinationVisibility);
        
        // ફોર્મ સબમિશન (ઉમેરો અથવા અપડેટ) ને હેન્ડલ કરો
        form.addEventListener('submit', handleFormSubmit);
        
        // એડિટ રદ્દ કરો બટન ક્લિકને હેન્ડલ કરો
        cancelButton.addEventListener('click', resetFormState);

        // ફિલ્ટર કંટ્રોલ્સ લિસનર્સ
        filterTypeInput.addEventListener('change', updateFilterDateInput);
        filterDateInput.addEventListener('change', applyFiltersAndRender);
        filterDateInput.addEventListener('input', applyFiltersAndRender);
        
        // પ્રારંભિક કુલ રકમ ડિસ્પ્લેની ગણતરી કરો
        calculateTotalAmount(); 
    </script>
</body>
</html>